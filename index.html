<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satizabal Family Cruise 2026 - Norwegian Joy | Nov 20-23, 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-ocean: #0a2540;
            --ocean-blue: #1e3a5f;
            --teal: #0d9488;
            --teal-light: #14b8a6;
            --gold: #f59e0b;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Room type colors */
            --inside-color: #6b7280;
            --oceanview-color: #0ea5e9;
            --balcony-color: #22c55e;
            --club-balcony-color: #8b5cf6;
            --suite-color: #f59e0b;
            --haven-color: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* Hero Header */
        .hero {
            background: linear-gradient(135deg, var(--deep-ocean) 0%, var(--ocean-blue) 100%);
            color: var(--white);
            padding: 2rem 1rem 10rem;
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .version-badge {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.5;
            letter-spacing: 0.025em;
        }

        .visitor-counter {
            position: absolute;
            top: 1.2rem;
            right: 0;
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.5;
            letter-spacing: 0.025em;
        }

        .lang-toggle {
            position: absolute;
            top: 2rem;
            right: 0;
            display: flex;
            gap: 0.35rem;
            z-index: 3;
        }

        .lang-btn {
            padding: 0.3rem 0.75rem;
            border: 1.5px solid rgba(255,255,255,0.4);
            border-radius: 9999px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 0.03em;
        }

        .lang-btn:hover {
            border-color: rgba(255,255,255,0.7);
            color: white;
        }

        .lang-btn.active {
            border-color: var(--teal-light);
            color: white;
            background: rgba(13,148,136,0.3);
        }

        .ship-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .ship-name a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.2s;
        }

        .ship-name a:hover {
            color: var(--teal-light);
        }

        .cruise-dates {
            font-size: 1.25rem;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .itinerary-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--teal-light);
            margin-bottom: 1.5rem;
        }

        .itinerary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .itinerary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .itinerary-grid {
                grid-template-columns: 1fr;
            }
        }

        .port-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .port-day {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .port-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .port-time {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .validity-banner {
            background: linear-gradient(90deg, var(--gold), #fbbf24);
            color: var(--gray-900);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); }
        }

        .validity-icon {
            font-size: 1.25rem;
        }

        /* Wave Animation */
        .wave-container {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            height: 120px;
            overflow: hidden;
            margin-top: -120px;
            z-index: 100;
            background: linear-gradient(135deg, var(--deep-ocean) 0%, var(--ocean-blue) 100%);
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 80'%3E%3Cpath d='M0 20 Q25 8 50 20 Q75 8 100 20 Q125 8 150 20 Q175 8 200 20 L200 35 Q175 23 150 35 Q125 23 100 35 Q75 23 50 35 Q25 23 0 35 Z' fill='%235b9cd9'/%3E%3Cpath d='M0 18 Q25 6 50 18 Q75 6 100 18 Q125 6 150 18 Q175 6 200 18' fill='none' stroke='%2393c5f7' stroke-width='2'/%3E%3Cpath d='M0 35 Q25 23 50 35 Q75 23 100 35 Q125 23 150 35 Q175 23 200 35 L200 50 Q175 38 150 50 Q125 38 100 50 Q75 38 50 50 Q25 38 0 50 Z' fill='%234a8bc9'/%3E%3Cpath d='M0 33 Q25 21 50 33 Q75 21 100 33 Q125 21 150 33 Q175 21 200 33' fill='none' stroke='%237db5e9' stroke-width='2'/%3E%3Cpath d='M0 50 Q25 38 50 50 Q75 38 100 50 Q125 38 150 50 Q175 38 200 50 L200 65 Q175 53 150 65 Q125 53 100 65 Q75 53 50 65 Q25 53 0 65 Z' fill='%233a7ab9'/%3E%3Cpath d='M0 48 Q25 36 50 48 Q75 36 100 48 Q125 36 150 48 Q175 36 200 48' fill='none' stroke='%236aa5d9' stroke-width='2'/%3E%3Cpath d='M0 65 Q25 53 50 65 Q75 53 100 65 Q125 53 150 65 Q175 53 200 65 L200 80 L0 80 Z' fill='%232a69a9'/%3E%3Cpath d='M0 63 Q25 51 50 63 Q75 51 100 63 Q125 51 150 63 Q175 51 200 63' fill='none' stroke='%235795c9' stroke-width='2'/%3E%3C/svg%3E") repeat-x;
            background-size: 200px 100%;
            animation: wave 25s linear infinite;
        }

        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Controls Panel */
        .controls {
            max-width: 1200px;
            margin: 0.5rem auto 2rem;
            padding: 0 1rem;
            position: relative;
            z-index: 10;
        }

        .controls-panel {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex: 1;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 9999px;
            background: var(--white);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-tab:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .filter-tab.active {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--white);
        }

        .filter-tab[data-filter="Inside"].active { background: var(--inside-color); border-color: var(--inside-color); }
        .filter-tab[data-filter="Oceanview"].active { background: var(--oceanview-color); border-color: var(--oceanview-color); }
        .filter-tab[data-filter="Balcony"].active { background: var(--balcony-color); border-color: var(--balcony-color); }
        .filter-tab[data-filter="Club Balcony Suite"].active { background: var(--club-balcony-color); border-color: var(--club-balcony-color); }
        .filter-tab[data-filter="Suite"].active { background: var(--suite-color); border-color: var(--suite-color); }
        .filter-tab[data-filter="The Haven"].active { background: var(--haven-color); border-color: var(--haven-color); }

        .sort-select {
            padding: 0.5rem 2rem 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--white);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
        }

        /* Guest Count Section */
        .guest-section {
            display: flex;
            gap: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .guest-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .guest-input-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 0;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .stepper-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gray-50);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray-700);
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stepper-btn:hover:not(:disabled) {
            background: var(--gray-200);
        }

        .stepper-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stepper-value {
            width: 36px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            border-left: 1px solid var(--gray-200);
            border-right: 1px solid var(--gray-200);
            height: 36px;
            line-height: 36px;
        }

        .guest-total {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-500);
            padding-bottom: 0.4rem;
        }

        .package-toggles {
            display: flex;
            gap: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .toggle-price {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* iOS-style Toggle */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            appearance: none;
            background: var(--gray-300);
            border-radius: 9999px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch:checked {
            background: var(--teal);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .toggle-switch:checked::before {
            transform: translateX(22px);
        }

        /* Cabin Grid */
        .cabin-grid {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem 2rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .cabin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .cabin-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cabin Card */
        .cabin-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s;
            position: relative;
        }

        .cabin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }

        .cabin-card.selected {
            outline: 3px solid var(--teal);
            outline-offset: -3px;
        }

        .cabin-card.dimmed {
            opacity: 0.5;
        }

        .cabin-card.dimmed:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .max-guests-note {
            background: var(--gray-100);
            color: var(--gray-500);
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .cabin-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .cabin-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.75rem;
        }

        .badge-Inside { background: #f3f4f6; color: var(--inside-color); }
        .badge-Oceanview { background: #e0f2fe; color: #0369a1; }
        .badge-Balcony { background: #dcfce7; color: #166534; }
        .badge-Club-Balcony-Suite { background: #ede9fe; color: #6d28d9; }
        .badge-Suite { background: #fef3c7; color: #b45309; }
        .badge-The-Haven { background: #fce7f3; color: #be185d; }

        .cabin-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .cabin-specs {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray-500);
            flex-wrap: wrap;
        }

        .cabin-spec {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .cabin-body {
            padding: 1.25rem;
        }

        .price-display {
            text-align: center;
            margin-bottom: 1rem;
        }

        .price-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-ocean);
        }

        .price-amount.flash {
            animation: price-flash 0.5s ease;
        }

        @keyframes price-flash {
            0%, 100% { color: var(--deep-ocean); }
            50% { color: var(--teal); }
        }

        .price-per-person {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .tips-onboard-note {
            font-size: 0.8rem;
            color: var(--suite-color);
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .deposit-info {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .deposit-label {
            color: var(--gray-600);
        }

        .deposit-amount {
            font-weight: 600;
            color: var(--teal);
        }

        .cabin-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--teal);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--teal-light);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-compare {
            background: var(--white);
            border: 2px solid var(--teal);
            color: var(--teal);
        }

        .btn-compare:hover {
            background: var(--teal);
            color: var(--white);
        }

        .btn-compare.selected {
            background: var(--teal);
            color: var(--white);
        }

        .btn-select-cabin {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--teal);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: background 0.2s;
        }

        .btn-select-cabin:hover {
            background: var(--teal-light);
        }

        .btn-select-cabin:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .selection-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 250;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .selection-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .selection-modal .modal-content {
            background: var(--white);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
            padding: 1.5rem;
            position: relative;
        }

        .selection-modal.visible .modal-content {
            transform: translateY(0);
        }

        .selection-modal .modal-content h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
            padding-right: 2.5rem;
        }

        .selection-summary-section {
            margin-bottom: 1rem;
        }

        .selection-summary-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--teal);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid var(--teal);
        }

        .selection-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .selection-summary-row .label {
            color: var(--gray-500);
        }

        .selection-summary-row .value {
            font-weight: 600;
            color: var(--gray-800);
        }

        .selection-summary-row.total {
            border-top: 2px solid var(--gray-300);
            border-bottom: none;
            padding-top: 0.5rem;
            margin-top: 0.25rem;
            font-size: 1rem;
        }

        .selection-summary-row.total .value {
            color: var(--teal);
            font-size: 1.1rem;
        }

        .selection-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
        }

        .btn-cancel {
            flex: 1;
            padding: 0.75rem;
            background: var(--gray-200);
            color: var(--gray-700);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover {
            background: var(--gray-300);
        }

        .btn-confirm {
            flex: 2;
            padding: 0.75rem;
            background: #22c55e;
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-confirm:hover {
            background: #16a34a;
        }

        .btn-confirm:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ncl-link {
            display: block;
            text-align: center;
            padding: 0.75rem;
            color: var(--ocean-blue);
            font-size: 0.875rem;
            text-decoration: none;
            border-top: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .ncl-link:hover {
            background: var(--gray-50);
        }

        /* Breakdown */
        .breakdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .breakdown.open {
            max-height: 2000px;
        }

        .breakdown-content {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .breakdown-row:last-child {
            border-bottom: none;
        }

        .breakdown-row.total {
            font-weight: 700;
            font-size: 1rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--gray-300);
            margin-top: 0.5rem;
        }

        .breakdown-label {
            color: var(--gray-600);
        }

        .breakdown-value {
            color: var(--gray-900);
            font-weight: 500;
        }

        .breakdown-section-header {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--ocean-blue);
            padding: 1rem 0 0.5rem;
            margin-top: 0.75rem;
            border-top: 2px dashed var(--gray-300);
        }

        .breakdown-row.tips-onboard {
            background: #fef3c7;
            margin: 0 -1rem;
            padding: 0.5rem 1rem;
            font-style: italic;
        }

        .breakdown-row.tips-onboard .breakdown-label {
            color: var(--suite-color);
        }

        .breakdown-row.tips-onboard .breakdown-value {
            color: var(--suite-color);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            background: #dc2626;
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .guest-breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.825rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .guest-breakdown-row:last-child {
            border-bottom: none;
        }

        .guest-breakdown-label {
            color: var(--gray-700);
            font-weight: 500;
        }

        .guest-breakdown-detail {
            color: var(--gray-500);
            font-size: 0.75rem;
            margin-top: 0.125rem;
        }

        .guest-breakdown-value {
            font-weight: 600;
            color: var(--gray-900);
            white-space: nowrap;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--gray-400);
            font-size: 0.8em;
            font-weight: 400;
            margin-right: 0.35rem;
        }

        .free-tag {
            display: inline-block;
            background: var(--teal);
            color: var(--white);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.25rem;
            vertical-align: middle;
        }

        /* Comparison Tray */
        .comparison-tray {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--deep-ocean);
            color: var(--white);
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
        }

        .comparison-tray.visible {
            transform: translateY(0);
        }

        .tray-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .tray-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tray-count {
            background: var(--teal);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .tray-text {
            font-size: 0.875rem;
        }

        .tray-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-tray {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-compare-now {
            background: var(--teal);
            color: var(--white);
        }

        .btn-compare-now:hover {
            background: var(--teal-light);
        }

        .btn-clear {
            background: transparent;
            color: var(--gray-300);
            border: 1px solid var(--gray-600);
        }

        .btn-clear:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 200;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: var(--white);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gray-500);
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .comparison-grid {
            display: grid;
            gap: 1rem;
        }

        .comparison-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .comparison-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (max-width: 768px) {
            .comparison-grid.cols-2,
            .comparison-grid.cols-3 {
                grid-template-columns: 1fr;
            }
        }

        .comparison-column {
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            overflow: hidden;
        }

        .comparison-cabin-header {
            padding: 1rem;
            background: var(--gray-50);
            text-align: center;
        }

        .comparison-cabin-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-top: 0.5rem;
        }

        .comparison-cabin-body {
            padding: 1rem;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 0.625rem 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-row.highlight {
            background: var(--gray-50);
            margin: 0 -1rem;
            padding: 0.625rem 1rem;
            font-weight: 600;
        }

        .comparison-label {
            color: var(--gray-500);
        }

        .comparison-value {
            font-weight: 500;
            color: var(--gray-900);
        }

        .comparison-total {
            text-align: center;
            padding: 1rem;
            background: var(--deep-ocean);
            color: var(--white);
        }

        .comparison-total-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        .comparison-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Inline Child Age Inputs */
        .child-ages-inline {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .child-age-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }

        .child-age-card-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .child-age-card-row {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .child-age-inline-input {
            width: 50px;
            padding: 0.35rem;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
            font-weight: 600;
            color: var(--gray-900);
        }

        .child-age-inline-input:focus {
            outline: none;
            border-color: var(--teal);
        }

        /* Footer */
        .footer {
            background: var(--deep-ocean);
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .payment-due {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .payment-due-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .payment-due-date {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .footer-note {
            font-size: 0.875rem;
            opacity: 0.7;
            margin-top: 1rem;
        }

        /* No results */
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Running totals display */
        .running-totals {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .running-total-item {
            font-size: 0.875rem;
        }

        .running-total-label {
            color: var(--gray-500);
        }

        .running-total-value {
            font-weight: 600;
            color: var(--teal);
        }

        /* Deposit Options */
        .deposit-options-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .deposit-options-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .deposit-radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .deposit-radio-label {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 200px;
        }

        .deposit-radio-label:hover:not(.disabled) {
            border-color: var(--teal);
        }

        .deposit-radio-label.active {
            border-color: var(--teal);
            background: rgba(13, 148, 136, 0.05);
        }

        .deposit-radio-label.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .deposit-radio-label input[type="radio"] {
            margin-top: 0.2rem;
            accent-color: var(--teal);
        }

        .deposit-radio-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .deposit-radio-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .deposit-radio-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Free at Sea Plus */
        .fas-plus-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .fas-plus-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .fas-plus-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .fas-plus-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fas-plus-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .fas-plus-savings {
            font-size: 0.75rem;
            color: var(--teal);
            font-weight: 600;
        }

        .fas-plus-requires {
            font-size: 0.7rem;
            color: var(--suite-color);
            font-weight: 500;
        }

        .fas-plus-info-btn {
            background: none;
            border: 2px solid var(--teal);
            color: var(--teal);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .fas-plus-info-btn:hover {
            background: var(--teal);
            color: var(--white);
        }

        .toggle-switch.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* FAS Plus Info Modal */
        .fas-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fas-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .fas-modal {
            background: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .fas-modal-overlay.visible .fas-modal {
            transform: scale(1);
        }

        .fas-modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fas-modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .fas-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fas-modal-close:hover {
            background: var(--gray-200);
        }

        .fas-modal-body {
            padding: 1.5rem;
        }

        .fas-modal-body p {
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .cost-benefit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .cost-benefit-table th {
            background: var(--gray-50);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        .cost-benefit-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .cost-benefit-table tr.total-row td {
            font-weight: 700;
            border-top: 2px solid var(--gray-300);
            color: var(--gray-900);
        }

        .cost-benefit-table .savings {
            color: var(--teal);
            font-weight: 600;
        }

        .credit-badge {
            display: inline-block;
            background: var(--gold);
            color: var(--gray-900);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.25rem;
            vertical-align: middle;
        }


        /* Tab Navigation */
        .tab-nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 11;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px 12px 0 0;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.7);
            color: var(--gray-600);
            position: relative;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.9);
            color: var(--teal);
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--teal);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--teal);
            border-radius: 3px 3px 0 0;
        }

        .tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            border-radius: 11px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .tab-badge-unbooked {
            background: var(--gold);
            color: var(--gray-900);
        }

        .tab-badge-reserved {
            background: var(--teal);
            color: white;
        }

        .tab-page {
            display: none;
        }

        .tab-page.active {
            display: block;
        }

        /* Family Group Buttons */
        .family-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .family-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .family-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .family-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 9999px;
            background: var(--white);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            white-space: nowrap;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .family-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .family-btn.active {
            background: var(--teal);
            border-color: var(--teal);
            color: white;
            transform: scale(1.03);
        }

        .family-btn .member-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .family-btn.active .member-count {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .guest-summary {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .guest-summary-names {
            font-weight: 500;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .guest-summary strong {
            color: var(--teal);
        }

        /* Fit badges on cabin cards */
        .fit-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            z-index: 2;
        }

        .fit-badge.perfect {
            background: var(--teal);
            color: white;
        }

        .fit-badge.good {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        /* Suggestion banner */
        .suggestion-banner {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
        }

        .suggestion-content {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-size: 0.875rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Tracker Page Styles */
        .tracker-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem 3rem;
        }

        /* Countdown Section */
        .countdown-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 640px) {
            .countdown-section {
                grid-template-columns: 1fr;
            }
        }

        .countdown-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }

        .countdown-label {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .countdown-date {
            font-size: 0.8rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .countdown-digits {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        .countdown-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .countdown-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            color: var(--deep-ocean);
            background: var(--gray-50);
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            min-width: 60px;
            transition: color 0.5s;
        }

        .countdown-number.green { color: #16a34a; }
        .countdown-number.yellow { color: #ca8a04; }
        .countdown-number.red { color: #dc2626; }
        .countdown-number.pulse { animation: pulse-red 1s ease-in-out infinite; }

        @keyframes pulse-red {
            0%, 100% { color: #dc2626; }
            50% { color: #fca5a5; }
        }

        .countdown-unit-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--gray-400);
            margin-top: 0.35rem;
            font-weight: 600;
        }

        .countdown-alert {
            background: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            animation: pulse-red-bg 1.5s ease-in-out infinite;
        }

        @keyframes pulse-red-bg {
            0%, 100% { background: #dc2626; }
            50% { background: #ef4444; }
        }

        /* Progress Bar */
        .progress-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .progress-bar-track {
            width: 100%;
            height: 24px;
            background: var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal), var(--teal-light));
            border-radius: 12px;
            transition: width 1s ease-out;
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-message {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* Reserved Family Cards */
        .tracker-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .reserved-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .reserved-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-top: 4px solid var(--gray-300);
        }

        .reserved-card[data-cabin-type="Inside"] { border-top-color: var(--inside-color); }
        .reserved-card[data-cabin-type="Oceanview"] { border-top-color: var(--oceanview-color); }
        .reserved-card[data-cabin-type="Balcony"] { border-top-color: var(--balcony-color); }
        .reserved-card[data-cabin-type="Club Balcony Suite"] { border-top-color: var(--club-balcony-color); }
        .reserved-card[data-cabin-type="Suite"] { border-top-color: var(--suite-color); }
        .reserved-card[data-cabin-type="The Haven"] { border-top-color: var(--haven-color); }

        .reserved-card-body {
            padding: 1rem;
        }

        .reserved-card-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .reserved-card-members {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .reserved-card-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .reserved-card-detail:last-child {
            border-bottom: none;
        }

        .reserved-detail-label {
            color: var(--gray-500);
        }

        .reserved-detail-value {
            font-weight: 600;
            color: var(--gray-700);
        }

        .deposit-yes {
            color: #16a34a;
        }

        .deposit-no {
            color: #dc2626;
        }

        /* Unbooked Section */
        .unbooked-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .unbooked-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .unbooked-pill {
            padding: 0.4rem 0.8rem;
            background: var(--gray-100);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: var(--gray-500);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nudge-btn {
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .nudge-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .share-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            min-height: 44px;
        }

        .share-btn-copy {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .share-btn-copy:hover {
            background: var(--gray-200);
        }

        .share-btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .share-btn-whatsapp:hover {
            background: #1da851;
        }

        /* Family color coding */
        .family-color-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.25rem;
        }

        /* Ship bobbing animation on wave */
        .ship-icon {
            position: absolute;
            bottom: 40px;
            left: 15%;
            font-size: 1.5rem;
            color: var(--white);
            z-index: 1;
            animation: bob 3s ease-in-out infinite;
        }

        @keyframes bob {
            0%, 100% { transform: scale(5, 2) translateY(0) rotate(-2deg); }
            50% { transform: scale(5, 2) translateY(-8px) rotate(2deg); }
        }

        /* Grand total floating summary */
        .grand-total-float {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
            display: none;
        }

        .grand-total-float.visible {
            display: block;
        }

        .grand-total-content {
            background: linear-gradient(135deg, var(--deep-ocean), var(--ocean-blue));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .grand-total-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .grand-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ==================== CONNECTING ROOMS ==================== */
        .connecting-rooms-toggle {
            display: none;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(13,148,136,0.08), rgba(30,58,95,0.08));
            border: 1px solid rgba(13,148,136,0.2);
            border-radius: 10px;
        }

        .connecting-rooms-toggle.visible {
            display: flex;
        }

        .connecting-rooms-toggle .toggle-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .connecting-rooms-toggle .toggle-desc {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .room-assignment {
            display: none;
            gap: 0.75rem;
            margin-top: 0.75rem;
            grid-template-columns: 1fr 1fr;
        }

        .room-assignment.visible {
            display: grid;
        }

        .room-column {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 10px;
            padding: 0.75rem;
            min-height: 80px;
        }

        .room-column-header {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .room-column-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .room-group-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            color: white;
            transition: all 0.2s;
        }

        .room-group-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .room-group-chip .chip-arrow {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .room-empty-msg {
            font-size: 0.8rem;
            color: var(--gray-400);
            font-style: italic;
            padding: 0.5rem 0;
        }

        .room-guest-count {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.35rem;
        }

        .connecting-pairs-section {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
            display: none;
        }

        .connecting-pairs-section.visible {
            display: block;
        }

        .connecting-pairs-header {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--gray-800);
        }

        .connecting-pairs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .connecting-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .connecting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .connecting-card.dimmed {
            opacity: 0.55;
            order: 99;
        }

        .connecting-card-top {
            height: 4px;
            background: linear-gradient(90deg, var(--teal), var(--ocean-blue));
        }

        .connecting-card-body {
            padding: 1rem;
        }

        .connecting-card-label {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connecting-link-icon {
            font-size: 0.8rem;
            color: var(--teal);
        }

        .connecting-room-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .connecting-room-info {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
        }

        .connecting-room-info-header {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .connecting-room-type-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.25rem;
        }

        .connecting-room-specs {
            font-size: 0.75rem;
            color: var(--gray-500);
            line-height: 1.4;
        }

        .connecting-room-guests {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .connecting-room-subtotal {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.35rem;
        }

        .connecting-combined {
            border-top: 2px solid var(--gray-200);
            padding-top: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connecting-combined-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .connecting-combined-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--deep-ocean);
        }

        .connecting-combined-deposit {
            font-size: 0.8rem;
            color: var(--gray-500);
            text-align: right;
        }

        .connecting-card-actions {
            margin-top: 0.75rem;
        }

        .connecting-card .max-guests-note {
            font-size: 0.75rem;
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .connecting-breakdown {
            display: none;
            margin-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 0.75rem;
        }

        .connecting-breakdown.open {
            display: block;
        }

        .connecting-breakdown-room-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--ocean-blue);
            margin: 0.5rem 0 0.25rem;
        }

        @media (max-width: 600px) {
            .room-assignment {
                grid-template-columns: 1fr;
            }
            .connecting-room-row {
                grid-template-columns: 1fr;
            }
            .connecting-pairs-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Header -->
    <header class="hero">
        <div class="hero-content">
            <span class="version-badge">v1.8.0</span>
            <span class="visitor-counter" id="visitorCounter"></span>
            <div class="lang-toggle">
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="es">ES</button>
            </div>
            <h1 class="ship-name">
                <a href="https://www.ncl.com/cruise-ships/norwegian-joy" target="_blank" rel="noopener" id="shipNameLink">Norwegian Joy</a>
            </h1>
            <p class="cruise-dates" data-i18n="hero.cruiseDates">Satizabal Family Cruise &middot; Fri, Nov 20 - Mon, Nov 23, 2026</p>
            <p class="itinerary-title" data-i18n="hero.itinerary">3-Day Bahamas Round-trip Miami: Great Stirrup Cay &amp; Nassau</p>

            <div class="itinerary-grid">
                <div class="port-card">
                    <div class="port-day" data-i18n="port.day1">Friday</div>
                    <div class="port-name">Miami, Florida</div>
                    <div class="port-time" data-i18n="port.time1">Embark 4:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day" data-i18n="port.day2">Saturday</div>
                    <div class="port-name">Nassau, Bahamas</div>
                    <div class="port-time">7:00 AM - 5:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day" data-i18n="port.day3">Sunday</div>
                    <div class="port-name">Great Stirrup Cay</div>
                    <div class="port-time">7:00 AM - 5:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day" data-i18n="port.day4">Monday</div>
                    <div class="port-name">Miami, Florida</div>
                    <div class="port-time" data-i18n="port.time4">Debark 7:00 AM</div>
                </div>
            </div>

            <div class="validity-banner">
                <span class="validity-icon">&#9888;</span>
                <span data-i18n="hero.validity" data-i18n-html>Prices valid as of <strong>February 1, 2026</strong></span>
            </div>
        </div>

    </header>
    <div class="wave-container">
        <span class="ship-icon">&#9972;</span>
        <div class="wave"></div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="selector"><span data-i18n="tab.selector">Cabin Selector</span> <span class="tab-badge tab-badge-unbooked" id="tabBadgeUnbooked">0</span></button>
        <button class="tab-btn" data-tab="tracker"><span data-i18n="tab.tracker">Reservation Tracker</span> <span class="tab-badge tab-badge-reserved" id="tabBadgeReserved">0</span></button>
    </nav>

    <!-- Page: Selector -->
    <div class="tab-page active" id="page-selector">

    <!-- Controls Panel -->
    <section class="controls">
        <div class="controls-panel">
            <div class="controls-row">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="All" data-i18n="filter.all">All</button>
                    <button class="filter-tab" data-filter="Inside" data-i18n="filter.inside">Inside</button>
                    <button class="filter-tab" data-filter="Oceanview" data-i18n="filter.oceanview">Oceanview</button>
                    <button class="filter-tab" data-filter="Balcony" data-i18n="filter.balcony">Balcony</button>
                    <button class="filter-tab" data-filter="Club Balcony Suite" data-i18n="filter.clubBalcony">Club Balcony</button>
                    <button class="filter-tab" data-filter="Suite" data-i18n="filter.suite">Suite</button>
                    <button class="filter-tab" data-filter="The Haven" data-i18n="filter.haven">The Haven</button>
                </div>

                <select class="sort-select" id="sortSelect">
                    <option value="price-asc" data-i18n="sort.priceAsc">Price: Low to High</option>
                    <option value="price-desc" data-i18n="sort.priceDesc">Price: High to Low</option>
                    <option value="sqft-desc" data-i18n="sort.sqftDesc">Sq Ft: Large to Small</option>
                    <option value="sqft-asc" data-i18n="sort.sqftAsc">Sq Ft: Small to Large</option>
                </select>
            </div>

            <!-- Family Group Selection -->
            <div class="family-section" id="familySection">
                <div class="family-section-title" data-i18n="family.title">Select your travel group</div>
                <div class="family-buttons" id="familyButtons"></div>
                <div class="guest-summary" id="guestSummary" style="display:none;">
                    <div id="guestSummaryText"></div>
                    <div class="guest-summary-names" id="guestSummaryNames"></div>
                </div>

                <!-- Connecting Rooms Toggle -->
                <div class="connecting-rooms-toggle" id="connectingRoomsToggle">
                    <input type="checkbox" class="toggle-switch" id="connectingRoomsSwitch">
                    <div>
                        <div class="toggle-label" data-i18n="connecting.label">Connecting Rooms</div>
                        <div class="toggle-desc" data-i18n="connecting.desc">Price two adjacent cabins with a shared door</div>
                    </div>
                </div>

                <!-- Room Assignment UI (for 3+ groups) -->
                <div class="room-assignment" id="roomAssignment">
                    <div class="room-column" id="room1Column">
                        <div class="room-column-header" data-i18n="room.room1">Room 1</div>
                        <div class="room-column-chips" id="room1Chips"></div>
                        <div class="room-guest-count" id="room1GuestCount"></div>
                    </div>
                    <div class="room-column" id="room2Column">
                        <div class="room-column-header" data-i18n="room.room2">Room 2</div>
                        <div class="room-column-chips" id="room2Chips"></div>
                        <div class="room-guest-count" id="room2GuestCount"></div>
                    </div>
                </div>
            </div>

            <div class="guest-section">
                <div class="guest-input-group">
                    <label class="guest-input-label" data-i18n="guest.adults">Adults (21+)</label>
                    <div class="stepper" style="opacity:0.6; pointer-events:none;">
                        <button class="stepper-btn" id="adultDec" disabled>-</button>
                        <div class="stepper-value" id="adultCount">0</div>
                        <button class="stepper-btn" id="adultInc" disabled>+</button>
                    </div>
                </div>
                <div class="guest-input-group">
                    <label class="guest-input-label" data-i18n="guest.children">Children (0-20)</label>
                    <div class="stepper" style="opacity:0.6; pointer-events:none;">
                        <button class="stepper-btn" id="childDec" disabled>-</button>
                        <div class="stepper-value" id="childCount">0</div>
                        <button class="stepper-btn" id="childInc" disabled>+</button>
                    </div>
                </div>
                <div class="guest-total" id="guestTotal">Select a family group above</div>
                <div class="child-ages-inline" id="childAgesInline"></div>
            </div>

            <div class="package-toggles">
                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="drinkToggle">
                    <div>
                        <div class="toggle-label" data-i18n="toggle.drink">Drink Package</div>
                        <div class="toggle-price" id="drinkToggleDesc">+$171 (2 adults x $85.50)</div>
                    </div>
                </div>

                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="dinnerToggle">
                    <div>
                        <div class="toggle-label" data-i18n="toggle.dinner">Dinner Package</div>
                        <div class="toggle-price" id="dinnerToggleDesc">+$40 (2 guests x $20)</div>
                    </div>
                </div>

                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="tipsToggle">
                    <div>
                        <div class="toggle-label" data-i18n="toggle.tips">When to Pay Tips</div>
                        <div class="toggle-price" id="tipsToggleDesc">Onboard (pay during cruise)</div>
                    </div>
                </div>
            </div>

            <!-- Free at Sea Plus -->
            <div class="fas-plus-section" id="fasPlusSection">
                <div class="fas-plus-toggle">
                    <input type="checkbox" class="toggle-switch" id="fasPlusToggle">
                    <div class="fas-plus-info">
                        <div class="fas-plus-title">
                            <span data-i18n="fas.title">Free at Sea Plus</span>
                            <button class="fas-plus-info-btn" id="fasPlusInfoBtn" title="What's included?">?</button>
                        </div>
                        <div class="fas-plus-desc" id="fasPlusDesc">+$300 (2 guests x $150) &mdash; Includes prepaid gratuities</div>
                        <div class="fas-plus-requires" id="fasPlusRequires" style="display: none;" data-i18n="fas.requires">Enabling will auto-select Drink &amp; Dinner packages if not already selected</div>
                        <div class="fas-plus-savings" id="fasPlusSavings" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Deposit Options -->
            <div class="deposit-options-section" id="depositOptionsSection">
                <div class="deposit-options-title" data-i18n="deposit.title">Deposit Option</div>
                <div class="deposit-radio-group" id="depositRadioGroup">
                    <label class="deposit-radio-label active" data-option="regular">
                        <input type="radio" name="depositOption" value="regular" checked>
                        <div class="deposit-radio-info">
                            <span class="deposit-radio-name" data-i18n="deposit.regularName">Regular Deposit</span>
                            <span class="deposit-radio-desc" data-i18n="deposit.regularDesc">Suite/Haven: 10% of fare | Others: $100</span>
                        </div>
                    </label>
                    <label class="deposit-radio-label" data-option="credit150">
                        <input type="radio" name="depositOption" value="credit150">
                        <div class="deposit-radio-info">
                            <span class="deposit-radio-name" data-i18n="deposit.creditName">$150 Credit Deposit</span>
                            <span class="deposit-radio-desc" data-i18n="deposit.creditDesc">Pay $150 deposit, receive $150 credit toward your cruise</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="running-totals" id="runningTotals" style="display: none;">
                <div class="running-total-item">
                    <span class="running-total-label" data-i18n="totals.packageAdditions">Package additions: </span>
                    <span class="running-total-value" id="packageTotal">$0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Suggestion Banner -->
    <div class="suggestion-banner" id="suggestionBanner" style="display:none;">
        <div class="suggestion-content">
            <span class="suggestion-icon">&#128161;</span>
            <span id="suggestionText"></span>
        </div>
    </div>

    <!-- Grand Total Float -->
    <div class="grand-total-float" id="grandTotalFloat">
        <div class="grand-total-content">
            <span class="grand-total-label" id="grandTotalLabel"></span>
            <span class="grand-total-amount" id="grandTotalAmount"></span>
        </div>
    </div>

    <!-- Connecting Room Pairs -->
    <div class="connecting-pairs-section" id="connectingPairsSection">
        <div class="connecting-pairs-header" data-i18n="connecting.pairsHeader">Connecting Room Options</div>
        <div class="connecting-pairs-grid" id="connectingPairsGrid"></div>
    </div>

    <!-- Cabin Grid -->
    <main class="cabin-grid" id="cabinGrid">
        <!-- Cabins will be rendered here -->
    </main>

    </div><!-- /page-selector -->

    <!-- Comparison Tray (outside pages so it's always accessible) -->
    <div class="comparison-tray" id="comparisonTray">
        <div class="tray-content">
            <div class="tray-info">
                <div class="tray-count" id="trayCount">0</div>
                <div class="tray-text" data-i18n="tray.text">cabins selected for comparison (max 3)</div>
            </div>
            <div class="tray-actions">
                <button class="btn-tray btn-clear" id="clearComparison" data-i18n="tray.clearAll">Clear All</button>
                <button class="btn-tray btn-compare-now" id="compareNow" data-i18n="tray.compareNow">Compare Now</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal-overlay" id="comparisonModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="compare.title">Side-by-Side Comparison</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="comparison-grid" id="comparisonGrid"></div>
            </div>
        </div>
    </div>

    <!-- Selection Confirmation Modal -->
    <div class="selection-modal" id="selectionModal">
        <div class="modal-content">
            <button class="modal-close" id="selectionModalClose">&times;</button>
            <h2 id="selectionModalTitle"></h2>
            <div id="selectionModalBody"></div>
            <div class="selection-actions">
                <button class="btn btn-cancel" id="selectionCancel"></button>
                <button class="btn btn-confirm" id="selectionConfirm"></button>
            </div>
        </div>
    </div>

    <!-- FAS Plus Info Modal -->
    <div class="fas-modal-overlay" id="fasPlusModal">
        <div class="fas-modal">
            <div class="fas-modal-header">
                <h3 class="fas-modal-title" data-i18n="fasModal.title">Free at Sea Plus &mdash; Cost/Benefit Analysis</h3>
                <button class="fas-modal-close" id="closeFasModal">&times;</button>
            </div>
            <div class="fas-modal-body">
                <p data-i18n="fasModal.desc" data-i18n-html>
                    Free at Sea Plus is an upgrade package that adds premium perks on top of the standard
                    Free at Sea benefits. It costs <strong>$49.99/person/day</strong>, totaling approximately
                    <strong>$300 for a 3-day cruise (2 guests)</strong>.
                </p>
                <p style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; font-size: 0.8rem;" data-i18n="fasModal.onlyGuests12" data-i18n-html>
                    Free at Sea Plus applies ONLY to Guests 1 &amp; 2.
                </p>
                <table class="cost-benefit-table" id="costBenefitTable"></table>
                <p style="margin-top: 1.5rem; font-size: 0.8rem;">
                    <strong data-i18n="fasModal.resources">Resources:</strong><br>
                    <a href="https://www.ncl.com/content/dam/ncl/us/en/promo/cruise-deals/Free_at_sea_Plus_ver_11042025.pdf" target="_blank" rel="noopener" style="color: var(--teal);">Free at Sea Plus Comparison (PDF)</a><br>
                    <a href="https://www.ncl.com/faq/what-is-included-in-free-at-sea-plus-and-how-much-does-it-cost-" target="_blank" rel="noopener" style="color: var(--teal);">What is included in Free at Sea Plus? (NCL FAQ)</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Page: Tracker -->
    <div class="tab-page" id="page-tracker">
        <div class="tracker-container">
            <div class="countdown-section" id="countdownSection">
                <div class="countdown-card" id="cruiseCountdown">
                    <div class="countdown-label" data-i18n="tracker.cruiseDay">Cruise Day</div>
                    <div class="countdown-date" data-i18n="tracker.cruiseDate">November 20, 2026</div>
                    <div class="countdown-digits" id="cruiseCountdownDigits"></div>
                </div>
                <div class="countdown-card" id="paymentCountdown">
                    <div class="countdown-label" data-i18n="tracker.finalPayment">Final Payment</div>
                    <div class="countdown-date" data-i18n="tracker.paymentDate">July 23, 2026</div>
                    <div class="countdown-digits" id="paymentCountdownDigits"></div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-title" data-i18n="tracker.reunionProgress">Reunion Progress</div>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressBarFill" style="width:0%"></div>
                </div>
                <div class="progress-stats">
                    <span class="progress-count" id="progressCount">0/0 families booked</span>
                    <span class="progress-message" id="progressMessage"></span>
                </div>
            </div>

            <h3 class="tracker-section-title" data-i18n="tracker.reservedFamilies">Reserved Families</h3>
            <div class="reserved-grid" id="reservedGrid"></div>

            <div class="unbooked-section">
                <h3 class="tracker-section-title" style="border:none;margin:0 0 0.75rem;padding:0;" data-i18n="tracker.stillDeciding">Still Deciding</h3>
                <div class="unbooked-pills" id="unbookedPills"></div>
                <p style="font-size:0.85rem;color:var(--gray-500);margin-bottom:1rem;" data-i18n="tracker.shareHelp">Share this page to help them pick a cabin!</p>
                <div class="share-actions">
                    <button class="share-btn share-btn-copy" id="copyLinkBtn" data-i18n="tracker.copyLink">Copy Link</button>
                    <button class="share-btn share-btn-whatsapp" id="whatsappShareBtn" data-i18n="tracker.whatsapp">Share via WhatsApp</button>
                </div>
            </div>
        </div>
    </div><!-- /page-tracker -->

    <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="payment-due">
                <div class="payment-due-label" data-i18n="footer.paymentDue">Final Payment Due</div>
                <div class="payment-due-date" data-i18n="footer.paymentDate">July 23, 2026</div>
            </div>
            <p class="footer-note" data-i18n="footer.note">Satizabal Family Cruise 2026 &middot; Deposits are refundable if canceled by July 23, 2026</p>
        </div>
    </footer>

    <div class="toast" id="toast"></div>

    <script>
        // ==================== CABIN DATA (loaded from CSV) ====================
        let CABIN_DATA = [];
        let CONNECTING_PAIRS = [];

        const CRUISE_NIGHTS = 3;
        const TAX_PER_PERSON = 150;
        const EXTRA_GUEST_FARE = 438;
        const PROMO_DISCOUNT = 0.50;
        const FREE_GUEST_POSITIONS = [3, 4];

        const CRUISE_DATE = new Date('2026-11-20T16:00:00');
        const PAYMENT_DATE = new Date('2026-07-23T23:59:59');

        const FAMILY_COLORS = [
            '#f97316', '#06b6d4', '#ec4899', '#8b5cf6',
            '#84cc16', '#f59e0b', '#3b82f6', '#ef4444',
            '#14b8a6', '#a855f7', '#f43f5e', '#22c55e'
        ];

        // ==================== TRANSLATIONS ====================
        const TRANSLATIONS = {
            en: {
                // Hero
                'hero.cruiseDates': 'Satizabal Family Cruise \u00B7 Fri, Nov 20 - Mon, Nov 23, 2026',
                'hero.itinerary': '3-Day Bahamas Round-trip Miami: Great Stirrup Cay & Nassau',
                'hero.validity': 'Prices valid as of <strong>February 1, 2026</strong>',
                // Ports
                'port.day1': 'Friday', 'port.day2': 'Saturday', 'port.day3': 'Sunday', 'port.day4': 'Monday',
                'port.time1': 'Embark 4:00 PM', 'port.time4': 'Debark 7:00 AM',
                // Tabs
                'tab.selector': 'Cabin Selector', 'tab.tracker': 'Reservation Tracker',
                // Filters
                'filter.all': 'All', 'filter.inside': 'Inside', 'filter.oceanview': 'Oceanview',
                'filter.balcony': 'Balcony', 'filter.clubBalcony': 'Club Balcony',
                'filter.suite': 'Suite', 'filter.haven': 'The Haven',
                // Sort
                'sort.priceAsc': 'Price: Low to High', 'sort.priceDesc': 'Price: High to Low',
                'sort.sqftDesc': 'Sq Ft: Large to Small', 'sort.sqftAsc': 'Sq Ft: Small to Large',
                // Family section
                'family.title': 'Select your travel group',
                // Connecting rooms
                'connecting.label': 'Connecting Rooms',
                'connecting.desc': 'Price two adjacent cabins with a shared door',
                'connecting.pairsHeader': 'Connecting Room Options',
                // Room assignment
                'room.room1': 'Room 1', 'room.room2': 'Room 2',
                // Guest
                'guest.adults': 'Adults (21+)', 'guest.children': 'Children (0-20)',
                'guest.total': 'Total: {count} {guestWord}',
                'guest.selectFamily': 'Select a family group above',
                'guest.selected': 'Selected:',
                'guest.adult': 'adult', 'guest.adults_plural': 'adults',
                'guest.child': 'child', 'guest.children_plural': 'children',
                'guest.guestSingular': 'guest', 'guest.guestPlural': 'guests',
                'guest.age': 'age',
                'guest.guestsDefault': '{count} guests (default)',
                // Toggle labels
                'toggle.drink': 'Drink Package', 'toggle.dinner': 'Dinner Package',
                'toggle.tips': 'When to Pay Tips',
                'toggle.tipsBefore': 'Before cruise (by 7/23/2026)',
                'toggle.tipsOnboard': 'Onboard (end of cruise)',
                'toggle.noEligible': 'No eligible guests',
                'toggle.freeChildren': 'FREE for children under 13',
                'toggle.drinkAdult': '{count} {word} x $85.50',
                'toggle.drinkChild': '{count} child x $37.50 soda',
                'toggle.dinnerDesc': 'first {count} guests x $20',
                // FAS Plus
                'fas.title': 'Free at Sea Plus',
                'fas.requires': 'Enabling will auto-select Drink & Dinner packages if not already selected',
                'fas.desc': '+{cost} ({count} {guestWord} x $150) \u2014 Includes prepaid gratuities',
                'fas.savings': 'Includes ${low}-${high} in prepaid gratuities (varies by cabin)',
                // FAS Modal
                'fasModal.title': 'Free at Sea Plus \u2014 Cost/Benefit Analysis',
                'fasModal.desc': 'Free at Sea Plus is an upgrade package that adds premium perks on top of the standard Free at Sea benefits. It costs <strong>$49.99/person/day</strong>, totaling approximately <strong>$300 for a 3-day cruise (2 guests)</strong>.',
                'fasModal.onlyGuests12': 'Free at Sea Plus applies ONLY to Guests 1 & 2.',
                'fasModal.resources': 'Resources:',
                // Cost-benefit table
                'cbt.item': 'Item', 'cbt.without': 'Without FAS Plus', 'cbt.with': 'With FAS Plus',
                'cbt.packageCost': 'Package Cost',
                'cbt.fasLine': 'Free at Sea Plus ({nights} days x {guests} guests)',
                'cbt.savingsValue': 'Savings & Value',
                'cbt.standardCabins': 'Standard cabins ($20/day)', 'cbt.suiteHaven': 'Suite/Haven ($25/day)',
                'cbt.prepaidGrat': 'Prepaid Gratuities - {label}',
                'cbt.paySeparately': '$0 (pay separately)', 'cbt.included': '(included)',
                'cbt.gscBar': 'Unlimited Bar at Great Stirrup Cay',
                'cbt.gscBarDesc': '$0 (standard packages NOT valid on island after March 2026)',
                'cbt.starbucks': 'Unlimited Starbucks (1 drink per visit)',
                'cbt.topShelf': 'Premium Top-Shelf Spirits (Patr\u00F3n A\u00F1ejo, Macallan 12-Year, etc.)',
                'cbt.energy': 'Energy Drinks & Fresh Juices',
                'cbt.water': 'Bottled Water (Bars & Restaurants)',
                'cbt.gscPrices': 'Great Stirrup Cay Drink Prices (If No Plus Package)',
                'cbt.cocktails': 'Cocktails', 'cbt.cocktailPrice': '$12.50+ each (plus 20% gratuity)',
                'cbt.beer': 'Beer', 'cbt.beerPrice': '$7.50+ each (plus 20% gratuity)',
                'cbt.soda': 'Soda', 'cbt.sodaPrice': '$3.50 each (plus 20% gratuity)',
                'cbt.example': 'Example: 4 cocktails + 4 beers on island',
                'cbt.examplePrice': '~$96 + tip per couple',
                'cbt.netCost': 'Net Cost After Tip Savings',
                // Deposit
                'deposit.title': 'Deposit Option',
                'deposit.regularName': 'Regular Deposit',
                'deposit.regularDesc': 'Suite/Haven: 10% of fare | Others: $100',
                'deposit.creditName': '$150 Credit Deposit',
                'deposit.creditDesc': 'Pay $150 deposit, receive $150 credit toward your cruise',
                // Running totals
                'totals.packageAdditions': 'Package additions: ',
                // Cabin card
                'cabin.perfectFit': 'Perfect fit', 'cabin.goodFit': 'Good fit',
                'cabin.maxGuests': 'Max {count} {guestWord}',
                'cabin.sqft': 'sq ft', 'cabin.sqftBalcony': 'sq ft balcony',
                'cabin.upTo': 'Up to {count}',
                'cabin.totalFor': 'Total for {names}',
                'cabin.priceIf': 'Price (if {count} guests)',
                'cabin.perPerson': '/person', 'cabin.avg': '(avg)',
                'cabin.tipsOnboard': '+ {amount} tips paid onboard',
                'cabin.payToday': 'Pay today (deposit)',
                'cabin.viewBreakdown': 'View Breakdown', 'cabin.hideBreakdown': 'Hide Breakdown',
                'cabin.compare': 'Compare', 'cabin.selected': 'Selected',
                'cabin.viewNcl': 'View on NCL',
                // Room type display names
                'roomType.Inside': 'Inside', 'roomType.Oceanview': 'Oceanview',
                'roomType.Balcony': 'Balcony', 'roomType.Club Balcony Suite': 'Club Balcony Suite',
                'roomType.Suite': 'Suite', 'roomType.The Haven': 'The Haven',
                // Breakdown
                'breakdown.promoHalf': '50% OFF', 'breakdown.promoFull': '50% OFF + 3rd/4th FREE',
                'breakdown.baseFare': 'Base Fare ({count})',
                'breakdown.oneGuest': '1 guest',
                'breakdown.nGuests': '{count} guests',
                'breakdown.taxes': 'Taxes (${rate} x {count})',
                'breakdown.gratuities': 'Gratuities (${rate}/day x {nights} nights x {count} guests)',
                'breakdown.drinkPkg': 'Drink Package', 'breakdown.dinnerPkg': 'Dinner Package',
                'breakdown.fasPlus': 'Free at Sea Plus ($150 x {count} guests)',
                'breakdown.subtotal': 'Subtotal', 'breakdown.depositCredit': 'Deposit Credit',
                'breakdown.totalDue': 'Total Due by 7/23/2026',
                'breakdown.deposit': 'Deposit (pay today)',
                'breakdown.balance': 'Balance (due 7/23/2026)',
                'breakdown.perMonth': '~{amount}/mo over {months} months',
                'breakdown.gratOnboard': 'Gratuities (pay onboard)',
                'breakdown.fullTrip': 'Full Trip Cost',
                'breakdown.perGuest': 'Per-Guest Breakdown',
                'breakdown.adult': 'Adult', 'breakdown.ageN': 'Age {age}',
                'breakdown.fare': 'fare', 'breakdown.tax': 'tax',
                'breakdown.tip': 'tip', 'breakdown.tipOnboard': 'tip (onboard: {amount})',
                'breakdown.tipIncl': '$0 tip (incl.)', 'breakdown.tipZero': '$0 tip',
                'breakdown.sodaJuice': 'soda/juice', 'breakdown.drink': 'drink',
                'breakdown.drinkZero': '$0 drink', 'breakdown.dinner': 'dinner',
                'breakdown.dinnerZero': '$0 dinner',
                'breakdown.freeFare': 'FREE fare',
                'breakdown.freeCruiseFare': 'Cruise Fare', 'breakdown.freeTips': 'Tips',
                'breakdown.freeDrinks': 'Drinks', 'breakdown.freeDinner': 'Dinner',
                'breakdown.free': 'FREE {item}',
                // Comparison
                'compare.title': 'Side-by-Side Comparison',
                'compare.cabinSize': 'Cabin Size', 'compare.balcony': 'Balcony',
                'compare.maxGuests': 'Max Guests', 'compare.perPerson': 'Per Person',
                'compare.baseFare': 'Base Fare', 'compare.taxes': 'Taxes',
                'compare.gratuities': 'Gratuities', 'compare.fasPlus': 'Free at Sea Plus',
                'compare.drinkPkg': 'Drink Package', 'compare.dinnerPkg': 'Dinner Package',
                'compare.deposit': 'Deposit', 'compare.balanceDue': 'Balance Due',
                'compare.grandTotal': 'Grand Total',
                // Comparison tray
                'tray.text': 'cabins selected for comparison (max 3)',
                'tray.clearAll': 'Clear All', 'tray.compareNow': 'Compare Now',
                // Connecting pairs
                'connectPair.noGuests': 'No guests',
                'connectPair.assignBoth': 'Assign guests to both rooms',
                'connectPair.roomMax': 'Room {room}: max {count} guests',
                'connectPair.room1': 'Room 1', 'connectPair.room2': 'Room 2',
                'connectPair.combinedTotal': 'Combined Total',
                'connectPair.deposit': 'Deposit:',
                'connectPair.max': 'Max {count}',
                // Grand total float
                'grandTotal.pricingFor': 'Pricing for:',
                // Suggestion
                'suggestion.split': 'With {count} guests, consider splitting into 2 cabins for more options and better prices.',
                // Child ages
                'childAge.child': 'Child {n}', 'childAge.age': 'Age:',
                // Tracker
                'tracker.cruiseDay': 'Cruise Day',
                'tracker.cruiseDate': 'November 20, 2026',
                'tracker.finalPayment': 'Final Payment',
                'tracker.paymentDate': 'July 23, 2026',
                'tracker.reunionProgress': 'Reunion Progress',
                'tracker.reservedFamilies': 'Reserved Families',
                'tracker.stillDeciding': 'Still Deciding',
                'tracker.shareHelp': 'Share this page to help them pick a cabin!',
                'tracker.copyLink': 'Copy Link', 'tracker.whatsapp': 'Share via WhatsApp',
                'tracker.copied': 'Copied!',
                'tracker.familiesBooked': '{reserved}/{total} families booked',
                'tracker.progressFull': 'FULL REUNION! All families are booked!',
                'tracker.progressAlmost': 'Almost there! Just {count} {familyWord} left',
                'tracker.progressHalf': 'Over halfway there!',
                'tracker.progressQuarter': 'Gaining momentum! {count} more to go',
                'tracker.progressStart': 'The adventure begins! {count} {familyWord} booked',
                'tracker.familySingular': 'family', 'tracker.familyPlural': 'families',
                'tracker.familyHas': 'family has', 'tracker.familiesHave': 'families have',
                // Reserved cards
                'reserved.cabin': 'Cabin', 'reserved.room': 'Room', 'reserved.price': 'Price',
                'reserved.deposit': 'Deposit', 'reserved.paid': 'Paid', 'reserved.notPaid': 'Not paid',
                // Nudge
                'nudge.btn': 'Nudge', 'nudge.title': 'Send a nudge',
                'nudge.msg': 'Hey {name}! Have you picked your cabin yet? Check out the options: {url}',
                // WhatsApp
                'whatsapp.msg': 'Hey! Pick your cabin for our family cruise! {url}',
                // Countdown
                'countdown.paymentDue': 'PAYMENT DUE', 'countdown.bonVoyage': 'BON VOYAGE!',
                'countdown.days': 'Days', 'countdown.hrs': 'Hrs',
                'countdown.min': 'Min', 'countdown.sec': 'Sec',
                // Footer
                'footer.paymentDue': 'Final Payment Due',
                'footer.paymentDate': 'July 23, 2026',
                'footer.note': 'Satizabal Family Cruise 2026 \u00B7 Deposits are refundable if canceled by July 23, 2026',
                // No results
                'noResults.text': 'No cabins found for this filter.',
                'noResults.loadFail': 'Failed to load cabin data. Please refresh the page.',
                // Room assignment
                'roomAssign.clickToMove': 'Click a group chip to move it here',
                // Visitor counter
                'visitor.count': '{count} visitors',
                // Toast
                'toast.selectGroup': 'Please select your travel group first',
                // Selection
                'cabin.selectThis': 'Select This Cabin',
                'selection.title': 'Confirm Your Selection',
                'selection.group': 'Travel Group',
                'selection.members': 'Members',
                'selection.cabinType': 'Cabin Type',
                'selection.room1': 'Room 1',
                'selection.room2': 'Room 2',
                'selection.drinkPkg': 'Drink Package',
                'selection.dinnerPkg': 'Dinner Package',
                'selection.fasPlus': 'Free at Sea Plus',
                'selection.tips': 'When to Pay Tips',
                'selection.tipsBefore': 'Before Cruise',
                'selection.tipsOnboard': 'Onboard',
                'selection.depositType': 'Deposit Type',
                'selection.depositRegular': 'Regular',
                'selection.depositCredit': '$150 Credit',
                'selection.total': 'Total Price',
                'selection.deposit': 'Deposit (pay today)',
                'selection.balance': 'Balance Due',
                'selection.perPerson': 'Per Person Avg',
                'selection.confirm': 'Confirm Selection',
                'selection.cancel': 'Cancel',
                'selection.submitting': 'Submitting...',
                'selection.toast': "Thank you for your selection! David will call you to confirm the final price \u2014 or just call him, you know, whatever.",
                'selection.errorToast': 'Something went wrong. Please try again.',
                'selection.yes': 'Yes',
                'selection.no': 'No',
            },
            es: {
                // Hero
                'hero.cruiseDates': 'Crucero Familiar Satizabal \u00B7 Vie, Nov 20 - Lun, Nov 23, 2026',
                'hero.itinerary': '3 D\u00EDas Bahamas Ida y Vuelta Miami: Great Stirrup Cay y Nassau',
                'hero.validity': 'Precios vigentes desde el <strong>1 de febrero de 2026</strong>',
                // Ports
                'port.day1': 'Viernes', 'port.day2': 'S\u00E1bado', 'port.day3': 'Domingo', 'port.day4': 'Lunes',
                'port.time1': 'Embarque 4:00 PM', 'port.time4': 'Desembarque 7:00 AM',
                // Tabs
                'tab.selector': 'Selector de Cabinas', 'tab.tracker': 'Seguimiento de Reservas',
                // Filters
                'filter.all': 'Todas', 'filter.inside': 'Interior', 'filter.oceanview': 'Vista al Mar',
                'filter.balcony': 'Balc\u00F3n', 'filter.clubBalcony': 'Balc\u00F3n Club',
                'filter.suite': 'Suite', 'filter.haven': 'The Haven',
                // Sort
                'sort.priceAsc': 'Precio: Menor a Mayor', 'sort.priceDesc': 'Precio: Mayor a Menor',
                'sort.sqftDesc': 'Pies\u00B2: Mayor a Menor', 'sort.sqftAsc': 'Pies\u00B2: Menor a Mayor',
                // Family section
                'family.title': 'Selecciona tu grupo de viaje',
                // Connecting rooms
                'connecting.label': 'Cabinas Conectadas',
                'connecting.desc': 'Precios de dos cabinas adyacentes con puerta compartida',
                'connecting.pairsHeader': 'Opciones de Cabinas Conectadas',
                // Room assignment
                'room.room1': 'Cabina 1', 'room.room2': 'Cabina 2',
                // Guest
                'guest.adults': 'Adultos (21+)', 'guest.children': 'Ni\u00F1os (0-20)',
                'guest.total': 'Total: {count} {guestWord}',
                'guest.selectFamily': 'Selecciona un grupo familiar arriba',
                'guest.selected': 'Seleccionados:',
                'guest.adult': 'adulto', 'guest.adults_plural': 'adultos',
                'guest.child': 'ni\u00F1o', 'guest.children_plural': 'ni\u00F1os',
                'guest.guestSingular': 'hu\u00E9sped', 'guest.guestPlural': 'hu\u00E9spedes',
                'guest.age': 'edad',
                'guest.guestsDefault': '{count} hu\u00E9spedes (predeterminado)',
                // Toggle labels
                'toggle.drink': 'Paquete de Bebidas', 'toggle.dinner': 'Paquete de Cenas',
                'toggle.tips': 'Cu\u00E1ndo Pagar Propinas',
                'toggle.tipsBefore': 'Antes del crucero (antes del 23/7/2026)',
                'toggle.tipsOnboard': 'A bordo (final del crucero)',
                'toggle.noEligible': 'Sin hu\u00E9spedes elegibles',
                'toggle.freeChildren': 'GRATIS para ni\u00F1os menores de 13',
                'toggle.drinkAdult': '{count} {word} x $85.50',
                'toggle.drinkChild': '{count} ni\u00F1o x $37.50 refresco',
                'toggle.dinnerDesc': 'primeros {count} hu\u00E9spedes x $20',
                // FAS Plus
                'fas.title': 'Free at Sea Plus',
                'fas.requires': 'Al activar se seleccionar\u00E1n autom\u00E1ticamente los paquetes de Bebidas y Cenas',
                'fas.desc': '+{cost} ({count} {guestWord} x $150) \u2014 Incluye propinas prepagadas',
                'fas.savings': 'Incluye ${low}-${high} en propinas prepagadas (var\u00EDa seg\u00FAn cabina)',
                // FAS Modal
                'fasModal.title': 'Free at Sea Plus \u2014 An\u00E1lisis Costo/Beneficio',
                'fasModal.desc': 'Free at Sea Plus es un paquete de mejora que agrega beneficios premium sobre los beneficios est\u00E1ndar de Free at Sea. Cuesta <strong>$49.99/persona/d\u00EDa</strong>, totalizando aproximadamente <strong>$300 para un crucero de 3 d\u00EDas (2 hu\u00E9spedes)</strong>.',
                'fasModal.onlyGuests12': 'Free at Sea Plus aplica SOLO a los Hu\u00E9spedes 1 y 2.',
                'fasModal.resources': 'Recursos:',
                // Cost-benefit table
                'cbt.item': 'Concepto', 'cbt.without': 'Sin FAS Plus', 'cbt.with': 'Con FAS Plus',
                'cbt.packageCost': 'Costo del Paquete',
                'cbt.fasLine': 'Free at Sea Plus ({nights} d\u00EDas x {guests} hu\u00E9spedes)',
                'cbt.savingsValue': 'Ahorros y Valor',
                'cbt.standardCabins': 'Cabinas est\u00E1ndar ($20/d\u00EDa)', 'cbt.suiteHaven': 'Suite/Haven ($25/d\u00EDa)',
                'cbt.prepaidGrat': 'Propinas Prepagadas - {label}',
                'cbt.paySeparately': '$0 (pagar por separado)', 'cbt.included': '(incluido)',
                'cbt.gscBar': 'Bar Ilimitado en Great Stirrup Cay',
                'cbt.gscBarDesc': '$0 (paquetes est\u00E1ndar NO v\u00E1lidos en la isla despu\u00E9s de marzo 2026)',
                'cbt.starbucks': 'Starbucks Ilimitado (1 bebida por visita)',
                'cbt.topShelf': 'Licores Premium (Patr\u00F3n A\u00F1ejo, Macallan 12 A\u00F1os, etc.)',
                'cbt.energy': 'Bebidas Energ\u00E9ticas y Jugos Frescos',
                'cbt.water': 'Agua Embotellada (Bares y Restaurantes)',
                'cbt.gscPrices': 'Precios de Bebidas en Great Stirrup Cay (Sin Paquete Plus)',
                'cbt.cocktails': 'C\u00F3cteles', 'cbt.cocktailPrice': '$12.50+ c/u (m\u00E1s 20% propina)',
                'cbt.beer': 'Cerveza', 'cbt.beerPrice': '$7.50+ c/u (m\u00E1s 20% propina)',
                'cbt.soda': 'Refresco', 'cbt.sodaPrice': '$3.50 c/u (m\u00E1s 20% propina)',
                'cbt.example': 'Ejemplo: 4 c\u00F3cteles + 4 cervezas en la isla',
                'cbt.examplePrice': '~$96 + propina por pareja',
                'cbt.netCost': 'Costo Neto Despu\u00E9s de Ahorro en Propinas',
                // Deposit
                'deposit.title': 'Opci\u00F3n de Dep\u00F3sito',
                'deposit.regularName': 'Dep\u00F3sito Regular',
                'deposit.regularDesc': 'Suite/Haven: 10% de tarifa | Otros: $100',
                'deposit.creditName': 'Dep\u00F3sito con Cr\u00E9dito de $150',
                'deposit.creditDesc': 'Paga $150 de dep\u00F3sito, recibe $150 de cr\u00E9dito para tu crucero',
                // Running totals
                'totals.packageAdditions': 'Adiciones del paquete: ',
                // Cabin card
                'cabin.perfectFit': 'Ajuste perfecto', 'cabin.goodFit': 'Buen ajuste',
                'cabin.maxGuests': 'M\u00E1x {count} {guestWord}',
                'cabin.sqft': 'pies\u00B2', 'cabin.sqftBalcony': 'pies\u00B2 balc\u00F3n',
                'cabin.upTo': 'Hasta {count}',
                'cabin.totalFor': 'Total para {names}',
                'cabin.priceIf': 'Precio (si {count} hu\u00E9spedes)',
                'cabin.perPerson': '/persona', 'cabin.avg': '(prom)',
                'cabin.tipsOnboard': '+ {amount} propinas a bordo',
                'cabin.payToday': 'Pagar hoy (dep\u00F3sito)',
                'cabin.viewBreakdown': 'Ver Desglose', 'cabin.hideBreakdown': 'Ocultar Desglose',
                'cabin.compare': 'Comparar', 'cabin.selected': 'Seleccionado',
                'cabin.viewNcl': 'Ver en NCL',
                // Room type display names
                'roomType.Inside': 'Interior', 'roomType.Oceanview': 'Vista al Mar',
                'roomType.Balcony': 'Balc\u00F3n', 'roomType.Club Balcony Suite': 'Suite Balc\u00F3n Club',
                'roomType.Suite': 'Suite', 'roomType.The Haven': 'The Haven',
                // Breakdown
                'breakdown.promoHalf': '50% DESC', 'breakdown.promoFull': '50% DESC + 3ro/4to GRATIS',
                'breakdown.baseFare': 'Tarifa Base ({count})',
                'breakdown.oneGuest': '1 hu\u00E9sped',
                'breakdown.nGuests': '{count} hu\u00E9spedes',
                'breakdown.taxes': 'Impuestos (${rate} x {count})',
                'breakdown.gratuities': 'Propinas (${rate}/d\u00EDa x {nights} noches x {count} hu\u00E9spedes)',
                'breakdown.drinkPkg': 'Paquete de Bebidas', 'breakdown.dinnerPkg': 'Paquete de Cenas',
                'breakdown.fasPlus': 'Free at Sea Plus ($150 x {count} hu\u00E9spedes)',
                'breakdown.subtotal': 'Subtotal', 'breakdown.depositCredit': 'Cr\u00E9dito de Dep\u00F3sito',
                'breakdown.totalDue': 'Total a Pagar antes del 23/7/2026',
                'breakdown.deposit': 'Dep\u00F3sito (pagar hoy)',
                'breakdown.balance': 'Saldo (vence 23/7/2026)',
                'breakdown.perMonth': '~{amount}/mes en {months} meses',
                'breakdown.gratOnboard': 'Propinas (pagar a bordo)',
                'breakdown.fullTrip': 'Costo Total del Viaje',
                'breakdown.perGuest': 'Desglose por Hu\u00E9sped',
                'breakdown.adult': 'Adulto', 'breakdown.ageN': 'Edad {age}',
                'breakdown.fare': 'tarifa', 'breakdown.tax': 'impuesto',
                'breakdown.tip': 'propina', 'breakdown.tipOnboard': 'propina (a bordo: {amount})',
                'breakdown.tipIncl': '$0 propina (incl.)', 'breakdown.tipZero': '$0 propina',
                'breakdown.sodaJuice': 'refresco/jugo', 'breakdown.drink': 'bebida',
                'breakdown.drinkZero': '$0 bebida', 'breakdown.dinner': 'cena',
                'breakdown.dinnerZero': '$0 cena',
                'breakdown.freeFare': 'GRATIS tarifa',
                'breakdown.freeCruiseFare': 'Tarifa Crucero', 'breakdown.freeTips': 'Propinas',
                'breakdown.freeDrinks': 'Bebidas', 'breakdown.freeDinner': 'Cena',
                'breakdown.free': 'GRATIS {item}',
                // Comparison
                'compare.title': 'Comparaci\u00F3n Lado a Lado',
                'compare.cabinSize': 'Tama\u00F1o de Cabina', 'compare.balcony': 'Balc\u00F3n',
                'compare.maxGuests': 'M\u00E1x Hu\u00E9spedes', 'compare.perPerson': 'Por Persona',
                'compare.baseFare': 'Tarifa Base', 'compare.taxes': 'Impuestos',
                'compare.gratuities': 'Propinas', 'compare.fasPlus': 'Free at Sea Plus',
                'compare.drinkPkg': 'Paquete de Bebidas', 'compare.dinnerPkg': 'Paquete de Cenas',
                'compare.deposit': 'Dep\u00F3sito', 'compare.balanceDue': 'Saldo Pendiente',
                'compare.grandTotal': 'Total General',
                // Comparison tray
                'tray.text': 'cabinas seleccionadas para comparar (m\u00E1x 3)',
                'tray.clearAll': 'Limpiar Todo', 'tray.compareNow': 'Comparar Ahora',
                // Connecting pairs
                'connectPair.noGuests': 'Sin hu\u00E9spedes',
                'connectPair.assignBoth': 'Asigna hu\u00E9spedes a ambas cabinas',
                'connectPair.roomMax': 'Cabina {room}: m\u00E1x {count} hu\u00E9spedes',
                'connectPair.room1': 'Cabina 1', 'connectPair.room2': 'Cabina 2',
                'connectPair.combinedTotal': 'Total Combinado',
                'connectPair.deposit': 'Dep\u00F3sito:',
                'connectPair.max': 'M\u00E1x {count}',
                // Grand total float
                'grandTotal.pricingFor': 'Precio para:',
                // Suggestion
                'suggestion.split': 'Con {count} hu\u00E9spedes, considera dividir en 2 cabinas para m\u00E1s opciones y mejores precios.',
                // Child ages
                'childAge.child': 'Ni\u00F1o {n}', 'childAge.age': 'Edad:',
                // Tracker
                'tracker.cruiseDay': 'D\u00EDa del Crucero',
                'tracker.cruiseDate': '20 de noviembre de 2026',
                'tracker.finalPayment': 'Pago Final',
                'tracker.paymentDate': '23 de julio de 2026',
                'tracker.reunionProgress': 'Progreso de la Reuni\u00F3n',
                'tracker.reservedFamilies': 'Familias Reservadas',
                'tracker.stillDeciding': 'A\u00FAn Decidiendo',
                'tracker.shareHelp': '\u00A1Comparte esta p\u00E1gina para ayudarles a elegir cabina!',
                'tracker.copyLink': 'Copiar Enlace', 'tracker.whatsapp': 'Compartir por WhatsApp',
                'tracker.copied': '\u00A1Copiado!',
                'tracker.familiesBooked': '{reserved}/{total} familias reservadas',
                'tracker.progressFull': '\u00A1REUNI\u00D3N COMPLETA! \u00A1Todas las familias reservaron!',
                'tracker.progressAlmost': '\u00A1Casi listo! Solo faltan {count} {familyWord}',
                'tracker.progressHalf': '\u00A1M\u00E1s de la mitad!',
                'tracker.progressQuarter': '\u00A1Ganando impulso! Faltan {count} m\u00E1s',
                'tracker.progressStart': '\u00A1La aventura comienza! {count} {familyWord} reservaron',
                'tracker.familySingular': 'familia', 'tracker.familyPlural': 'familias',
                'tracker.familyHas': 'familia ha', 'tracker.familiesHave': 'familias han',
                // Reserved cards
                'reserved.cabin': 'Cabina', 'reserved.room': 'Cabina', 'reserved.price': 'Precio',
                'reserved.deposit': 'Dep\u00F3sito', 'reserved.paid': 'Pagado', 'reserved.notPaid': 'No pagado',
                // Nudge
                'nudge.btn': 'Recordar', 'nudge.title': 'Enviar recordatorio',
                'nudge.msg': '\u00A1Hola {name}! \u00BFYa elegiste tu cabina? Mira las opciones: {url}',
                // WhatsApp
                'whatsapp.msg': '\u00A1Hola! \u00A1Elige tu cabina para nuestro crucero familiar! {url}',
                // Countdown
                'countdown.paymentDue': 'PAGO VENCIDO', 'countdown.bonVoyage': '\u00A1BUEN VIAJE!',
                'countdown.days': 'D\u00EDas', 'countdown.hrs': 'Hrs',
                'countdown.min': 'Min', 'countdown.sec': 'Seg',
                // Footer
                'footer.paymentDue': 'Fecha L\u00EDmite de Pago',
                'footer.paymentDate': '23 de julio de 2026',
                'footer.note': 'Crucero Familiar Satizabal 2026 \u00B7 Los dep\u00F3sitos son reembolsables si se cancela antes del 23 de julio de 2026',
                // No results
                'noResults.text': 'No se encontraron cabinas para este filtro.',
                'noResults.loadFail': 'Error al cargar datos de cabinas. Por favor recarga la p\u00E1gina.',
                // Room assignment
                'roomAssign.clickToMove': 'Haz clic en un grupo para moverlo aqu\u00ED',
                // Visitor counter
                'visitor.count': '{count} visitantes',
                // Toast
                'toast.selectGroup': 'Por favor selecciona tu grupo de viaje primero',
                // Selection
                'cabin.selectThis': 'Seleccionar Esta Cabina',
                'selection.title': 'Confirma Tu Selecci\u00F3n',
                'selection.group': 'Grupo de Viaje',
                'selection.members': 'Miembros',
                'selection.cabinType': 'Tipo de Cabina',
                'selection.room1': 'Cabina 1',
                'selection.room2': 'Cabina 2',
                'selection.drinkPkg': 'Paquete de Bebidas',
                'selection.dinnerPkg': 'Paquete de Cenas',
                'selection.fasPlus': 'Free at Sea Plus',
                'selection.tips': 'Cu\u00E1ndo Pagar Propinas',
                'selection.tipsBefore': 'Antes del Crucero',
                'selection.tipsOnboard': 'A Bordo',
                'selection.depositType': 'Tipo de Dep\u00F3sito',
                'selection.depositRegular': 'Regular',
                'selection.depositCredit': 'Cr\u00E9dito de $150',
                'selection.total': 'Precio Total',
                'selection.deposit': 'Dep\u00F3sito (pagar hoy)',
                'selection.balance': 'Saldo Pendiente',
                'selection.perPerson': 'Promedio por Persona',
                'selection.confirm': 'Confirmar Selecci\u00F3n',
                'selection.cancel': 'Cancelar',
                'selection.submitting': 'Enviando...',
                'selection.toast': "\u00A1Gracias por tu selecci\u00F3n! David te llamar\u00E1 para confirmar el precio final \u2014 o ll\u00E1malo t\u00FA, como quieras.",
                'selection.errorToast': 'Algo sali\u00F3 mal. Por favor intenta de nuevo.',
                'selection.yes': 'S\u00ED',
                'selection.no': 'No',
            }
        };

        function t(key, params) {
            let str = (TRANSLATIONS[AppState.lang] && TRANSLATIONS[AppState.lang][key])
                    || TRANSLATIONS.en[key] || key;
            if (params) {
                Object.keys(params).forEach(k => {
                    str = str.replace(new RegExp('\\{' + k + '\\}', 'g'), params[k]);
                });
            }
            return str;
        }

        function translatePage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const translated = t(key);
                if (el.hasAttribute('data-i18n-html')) {
                    el.innerHTML = translated;
                } else {
                    el.textContent = translated;
                }
            });
        }

        function switchLanguage(lang) {
            AppState.lang = lang;
            localStorage.setItem('cruise-lang', lang);
            document.documentElement.lang = lang;
            // Update toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            // Translate static HTML
            translatePage();
            // Update tips toggle desc (dynamic, not data-i18n)
            document.getElementById('tipsToggleDesc').textContent = AppState.tipsBeforeCruise
                ? t('toggle.tipsBefore') : t('toggle.tipsOnboard');
            // Re-render all dynamic content
            Renderer.renderGrid();
            Renderer.updateToggleLabels();
            Renderer.updateRunningTotals();
            Renderer.renderConnectingPairsGrid();
            Renderer.updateComparisonTray();
            App.updateGuestSummary();
            App.updateGuestDisplay();
            App.updateSuggestionBanner();
            App.updateGrandTotalFloat();
            App.updateFasPlusDisplay();
            App.renderTracker();
            updateVisitorCounterText();
        }

        // ==================== TOAST ====================
        let toastTimer = null;
        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('visible');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => el.classList.remove('visible'), 3000);
        }

        // ==================== VISITOR COUNTER ====================
        let visitorCount = null;

        function updateVisitorCounterText() {
            const el = document.getElementById('visitorCounter');
            if (el && visitorCount !== null) {
                el.textContent = t('visitor.count', { count: visitorCount.toLocaleString() });
            }
        }

        async function loadVisitorCounter() {
            try {
                const response = await fetch('https://visitor.6developer.com/visit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain: window.location.hostname || 'satizabal-cruise-local' })
                });
                if (response.ok) {
                    const data = await response.json();
                    visitorCount = data.totalCount || 0;
                    updateVisitorCounterText();
                }
            } catch (e) {
                // Silently fail - counter is non-essential
            }
        }

        // ==================== CABIN SELECTION SUBMISSION ====================
        const APPS_SCRIPT_URL = ''; // Paste your deployed Google Apps Script URL here

        let selectionPayload = null;

        function showSelectionModal(id, mode) {
            const groupLabels = AppState.getSelectedGroupLabels();
            const groupLabel = groupLabels.join(' + ');
            const memberNames = AppState.guestNames.join(', ');

            const drinkYN = AppState.includeDrinks ? t('selection.yes') : t('selection.no');
            const dinnerYN = AppState.includeDinner ? t('selection.yes') : t('selection.no');
            const fasYN = AppState.freeAtSeaPlus ? t('selection.yes') : t('selection.no');
            const tipsLabel = AppState.tipsBeforeCruise ? t('selection.tipsBefore') : t('selection.tipsOnboard');
            const depositLabel = AppState.depositOption === 'credit150' ? t('selection.depositCredit') : t('selection.depositRegular');

            let bodyHtml = '';

            if (mode === 'single') {
                const cabin = CABIN_DATA.find(c => c.id === id);
                if (!cabin) return;
                const pricing = PriceCalculator.calculate(cabin, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise);

                bodyHtml = buildSingleCabinSummary(cabin, pricing, groupLabel, memberNames, drinkYN, dinnerYN, fasYN, tipsLabel, depositLabel);

                selectionPayload = {
                    group: groupLabel,
                    members: memberNames,
                    cabinType: cabin.name,
                    roomTypes: cabin.roomType,
                    drinkPkg: drinkYN,
                    dinnerPkg: dinnerYN,
                    fasPlus: fasYN,
                    tips: tipsLabel,
                    depositType: depositLabel,
                    total: PriceCalculator.formatCurrency(pricing.grandTotal),
                    deposit: PriceCalculator.formatCurrency(pricing.deposit),
                    balance: PriceCalculator.formatCurrency(pricing.balance),
                    perPerson: PriceCalculator.formatCurrency(pricing.perPersonAvg)
                };
            } else {
                const pair = CONNECTING_PAIRS.find(p => p.id === id);
                if (!pair) return;
                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);
                const combinedPricing = PriceCalculator.calculateConnectingPair(
                    pair, room1Members, room2Members,
                    AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise
                );

                const room1Names = room1Members.map(m => m.name).join(', ');
                const room2Names = room2Members.map(m => m.name).join(', ');
                const allMembers = room1Names + (room1Names && room2Names ? ', ' : '') + room2Names;
                const combinedPerPerson = (room1Members.length + room2Members.length) > 0
                    ? combinedPricing.combinedGrandTotal / (room1Members.length + room2Members.length)
                    : 0;

                bodyHtml = buildConnectingPairSummary(pair, combinedPricing, groupLabel, allMembers, room1Names, room2Names, drinkYN, dinnerYN, fasYN, tipsLabel, depositLabel, combinedPerPerson);

                selectionPayload = {
                    group: groupLabel,
                    members: allMembers,
                    cabinType: pair.label,
                    roomTypes: pair.room1Cabin.roomType + ' + ' + pair.room2Cabin.roomType,
                    drinkPkg: drinkYN,
                    dinnerPkg: dinnerYN,
                    fasPlus: fasYN,
                    tips: tipsLabel,
                    depositType: depositLabel,
                    total: PriceCalculator.formatCurrency(combinedPricing.combinedGrandTotal),
                    deposit: PriceCalculator.formatCurrency(combinedPricing.combinedDeposit),
                    balance: PriceCalculator.formatCurrency(combinedPricing.combinedBalance),
                    perPerson: PriceCalculator.formatCurrency(combinedPerPerson)
                };
            }

            document.getElementById('selectionModalTitle').textContent = t('selection.title');
            document.getElementById('selectionModalBody').innerHTML = bodyHtml;
            document.getElementById('selectionCancel').textContent = t('selection.cancel');
            const confirmBtn = document.getElementById('selectionConfirm');
            confirmBtn.textContent = t('selection.confirm');
            confirmBtn.disabled = false;
            document.getElementById('selectionModal').classList.add('visible');
        }

        function buildSingleCabinSummary(cabin, pricing, groupLabel, memberNames, drinkYN, dinnerYN, fasYN, tipsLabel, depositLabel) {
            return `
                <div class="selection-summary-section">
                    <h3>${t('selection.group')}</h3>
                    <div class="selection-summary-row"><span class="label">${t('selection.group')}</span><span class="value">${groupLabel}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.members')}</span><span class="value">${memberNames}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>${t('selection.cabinType')}</h3>
                    <div class="selection-summary-row"><span class="label">${cabin.roomType}</span><span class="value">${cabin.name}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>Packages</h3>
                    <div class="selection-summary-row"><span class="label">${t('selection.drinkPkg')}</span><span class="value">${drinkYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.dinnerPkg')}</span><span class="value">${dinnerYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.fasPlus')}</span><span class="value">${fasYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.tips')}</span><span class="value">${tipsLabel}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.depositType')}</span><span class="value">${depositLabel}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>${t('selection.total')}</h3>
                    <div class="selection-summary-row total"><span class="label">${t('selection.total')}</span><span class="value">${PriceCalculator.formatCurrency(pricing.grandTotal)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.deposit')}</span><span class="value">${PriceCalculator.formatCurrency(pricing.deposit)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.balance')}</span><span class="value">${PriceCalculator.formatCurrency(pricing.balance)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.perPerson')}</span><span class="value">${PriceCalculator.formatCurrency(pricing.perPersonAvg)}</span></div>
                </div>
            `;
        }

        function buildConnectingPairSummary(pair, combinedPricing, groupLabel, allMembers, room1Names, room2Names, drinkYN, dinnerYN, fasYN, tipsLabel, depositLabel, combinedPerPerson) {
            const { room1, room2 } = combinedPricing;
            return `
                <div class="selection-summary-section">
                    <h3>${t('selection.group')}</h3>
                    <div class="selection-summary-row"><span class="label">${t('selection.group')}</span><span class="value">${groupLabel}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.members')}</span><span class="value">${allMembers}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>${t('selection.room1')}: ${pair.room1Cabin.roomType}</h3>
                    <div class="selection-summary-row"><span class="label">${pair.room1Cabin.name}</span><span class="value">${PriceCalculator.formatCurrency(room1.grandTotal)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.members')}</span><span class="value">${room1Names}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>${t('selection.room2')}: ${pair.room2Cabin.roomType}</h3>
                    <div class="selection-summary-row"><span class="label">${pair.room2Cabin.name}</span><span class="value">${PriceCalculator.formatCurrency(room2.grandTotal)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.members')}</span><span class="value">${room2Names}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>Packages</h3>
                    <div class="selection-summary-row"><span class="label">${t('selection.drinkPkg')}</span><span class="value">${drinkYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.dinnerPkg')}</span><span class="value">${dinnerYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.fasPlus')}</span><span class="value">${fasYN}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.tips')}</span><span class="value">${tipsLabel}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.depositType')}</span><span class="value">${depositLabel}</span></div>
                </div>
                <div class="selection-summary-section">
                    <h3>${t('selection.total')}</h3>
                    <div class="selection-summary-row total"><span class="label">${t('selection.total')}</span><span class="value">${PriceCalculator.formatCurrency(combinedPricing.combinedGrandTotal)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.deposit')}</span><span class="value">${PriceCalculator.formatCurrency(combinedPricing.combinedDeposit)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.balance')}</span><span class="value">${PriceCalculator.formatCurrency(combinedPricing.combinedBalance)}</span></div>
                    <div class="selection-summary-row"><span class="label">${t('selection.perPerson')}</span><span class="value">${PriceCalculator.formatCurrency(combinedPerPerson)}</span></div>
                </div>
            `;
        }

        async function submitSelection() {
            if (!selectionPayload) return;

            const confirmBtn = document.getElementById('selectionConfirm');
            confirmBtn.textContent = t('selection.submitting');
            confirmBtn.disabled = true;

            try {
                if (!APPS_SCRIPT_URL) {
                    throw new Error('APPS_SCRIPT_URL not configured');
                }
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selectionPayload)
                });
                document.getElementById('selectionModal').classList.remove('visible');
                showToast(t('selection.toast'));
            } catch (err) {
                showToast(t('selection.errorToast'));
                confirmBtn.textContent = t('selection.confirm');
                confirmBtn.disabled = false;
            }

            selectionPayload = null;
        }

        // CSV Parser for new format
        const CSVParser = {
            async load(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load CSV');
                    const text = await response.text();
                    return this.parse(text);
                } catch (error) {
                    console.error('Error loading CSV:', error);
                    return [];
                }
            },

            parse(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                const cabins = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);

                    if (!values[0] || !values[1] || !values[2]) continue;

                    const cabin = {
                        id: i,
                        roomType: values[0].trim(),
                        name: values[1].trim(),
                        basePrice: parseFloat(values[2]) || 0,
                        maxGuests: parseInt(values[3]) || 2,
                        sqft: values[4] ? values[4].trim() : '',
                        balconySqft: values[5] ? values[5].trim() : null
                    };

                    if (cabin.balconySqft === 'N/A' || cabin.balconySqft === '') {
                        cabin.balconySqft = null;
                    }

                    // Determine if solo cabin
                    cabin.isSolo = cabin.maxGuests === 1;

                    cabins.push(cabin);
                }

                return cabins;
            },

            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);
                return values;
            }
        };

        // ==================== FAMILY CSV PARSER ====================
        const FamilyCSVParser = {
            async load(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load family CSV');
                    const text = await response.text();
                    return this.parse(text);
                } catch (error) {
                    console.error('Error loading family CSV:', error);
                    return { unbookedGroups: [], reservedGroups: [] };
                }
            },

            parse(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return { unbookedGroups: [], reservedGroups: [] };

                const unbookedMap = new Map();
                const reservedMap = new Map();

                for (let i = 1; i < lines.length; i++) {
                    const values = CSVParser.parseCSVLine(lines[i]);
                    if (!values[0] || !values[1]) continue;

                    const label = values[0].trim();
                    const name = values[1].trim();
                    const age = parseInt(values[2]) || 0;
                    const status = (values[3] || '').trim().toLowerCase();
                    const cabinType = (values[4] || '').trim();
                    const roomNumber = (values[5] || '').trim();
                    const pricePaid = parseFloat(values[6]) || 0;
                    const depositPaid = (values[7] || '').trim().toLowerCase() === 'yes';

                    const member = { name, age };

                    if (status === 'reserved') {
                        if (!reservedMap.has(label)) {
                            reservedMap.set(label, {
                                label, members: [], cabinType, roomNumber, pricePaid, depositPaid
                            });
                        }
                        const group = reservedMap.get(label);
                        group.members.push(member);
                        if (pricePaid > 0) group.pricePaid = pricePaid;
                        if (depositPaid) group.depositPaid = true;
                    } else {
                        if (!unbookedMap.has(label)) {
                            unbookedMap.set(label, { label, members: [] });
                        }
                        unbookedMap.get(label).members.push(member);
                    }
                }

                return {
                    unbookedGroups: Array.from(unbookedMap.values()),
                    reservedGroups: Array.from(reservedMap.values())
                };
            }
        };

        // ==================== CONNECTING ROOMS PARSER ====================
        const ConnectingRoomsParser = {
            async load(connectingUrl, codeMapUrl) {
                try {
                    const [connectingResp, codeMapResp] = await Promise.all([
                        fetch(connectingUrl),
                        fetch(codeMapUrl)
                    ]);
                    if (!connectingResp.ok || !codeMapResp.ok) throw new Error('Failed to load connecting rooms CSV');
                    const connectingText = await connectingResp.text();
                    const codeMapText = await codeMapResp.text();
                    return this.parse(connectingText, codeMapText);
                } catch (error) {
                    console.error('Error loading connecting rooms:', error);
                    return [];
                }
            },

            parse(connectingText, codeMapText) {
                // Build code-to-category map
                const codeToCategory = new Map();
                const codeMapLines = codeMapText.trim().split('\n');
                for (let i = 1; i < codeMapLines.length; i++) {
                    const vals = CSVParser.parseCSVLine(codeMapLines[i]);
                    if (vals[0] && vals[1]) {
                        codeToCategory.set(vals[0].trim(), vals[1].trim()); // code -> cabin type (e.g. "Balcony")
                    }
                }

                // Parse connecting pairs and deduplicate by cabin type pair
                const seen = new Map();
                const lines = connectingText.trim().split('\n');
                for (let i = 1; i < lines.length; i++) {
                    const vals = CSVParser.parseCSVLine(lines[i]);
                    if (!vals[0] || !vals[1]) continue;
                    const code1 = vals[0].trim();
                    const code2 = vals[1].trim();
                    const type1 = codeToCategory.get(code1);
                    const type2 = codeToCategory.get(code2);
                    if (!type1 || !type2) continue;

                    // Canonical key: sorted types
                    const key = [type1, type2].sort().join('|');
                    if (seen.has(key)) continue;
                    seen.set(key, { type1, type2 });
                }

                // Build pair objects from CABIN_DATA
                const pairs = [];
                let id = 1;
                for (const [key, { type1, type2 }] of seen) {
                    const cabin1 = CABIN_DATA.find(c => c.roomType === type1 && !c.isSolo);
                    const cabin2 = CABIN_DATA.find(c => c.roomType === type2 && !c.isSolo);
                    if (!cabin1 || !cabin2) continue;

                    const isSameType = type1 === type2;
                    const label = isSameType
                        ? `${type1} + ${type2}`
                        : `${type1} + ${type2}`;

                    pairs.push({
                        id: id++,
                        label,
                        room1Cabin: cabin1,
                        room2Cabin: cabin2,
                        isSameType
                    });
                }

                return pairs;
            }
        };

        const NCL_LINKS = {
            "Inside": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=INSIDE",
            "Oceanview": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=OCEANVIEW",
            "Balcony": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=BALCONY",
            "Club Balcony Suite": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=CLUB_BALCONY_SUITE",
            "Suite": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=SUITE",
            "The Haven": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=HAVEN"
        };

        // ==================== PRICE CALCULATOR ====================
        const PriceCalculator = {
            getTipPerPersonPerDay(roomType) {
                if (roomType === 'The Haven' || roomType === 'Suite') return 25;
                return 20;
            },

            getTipPerPerson(roomType) {
                return this.getTipPerPersonPerDay(roomType) * CRUISE_NIGHTS;
            },

            /**
             * Build guest list with positions.
             * Adults fill first, then children sorted by age descending.
             */
            buildGuestList() {
                const members = AppState.getSelectedMembers();
                const adults = members.filter(m => m.age >= 21).map(m => ({ type: 'adult', age: m.age, label: m.name, name: m.name }));
                const children = members.filter(m => m.age < 21).sort((a, b) => b.age - a.age).map(m => ({ type: 'child', age: m.age, label: `${m.name} (${m.age})`, name: m.name }));
                const guests = [...adults, ...children];
                if (guests.length === 0) {
                    for (let i = 0; i < AppState.adultCount; i++) {
                        guests.push({ type: 'adult', age: 21, label: 'Adult', name: 'Adult' });
                    }
                    const sortedAges = [...AppState.childAges].sort((a, b) => b - a);
                    for (const age of sortedAges) {
                        guests.push({ type: 'child', age, label: `Age ${age}`, name: `Child (${age})` });
                    }
                }
                return guests;
            },

            calculate(cabin, includeDrinks, includeDinner, tipsBeforeCruise) {
                const totalGuests = AppState.adultCount + AppState.childCount;
                const effectiveGuests = cabin.isSolo ? 1 : Math.min(totalGuests, cabin.maxGuests);
                const exceedsMax = totalGuests > cabin.maxGuests;

                // Build guest list (capped at cabin max)
                const allGuests = this.buildGuestList();
                const guests = allGuests.slice(0, effectiveGuests);

                // Base fare (with 50% off promo + 3rd/4th guest free)
                const discountedBase = cabin.basePrice * (1 - PROMO_DISCOUNT);
                const discountedExtra = EXTRA_GUEST_FARE * (1 - PROMO_DISCOUNT);
                let totalFare;
                if (cabin.isSolo) {
                    totalFare = discountedBase;
                } else {
                    // Count how many extra guests (position 3+) actually pay
                    let paidExtras = 0;
                    for (let p = 3; p <= effectiveGuests; p++) {
                        if (!FREE_GUEST_POSITIONS.includes(p)) paidExtras++;
                    }
                    totalFare = discountedBase + paidExtras * discountedExtra;
                }

                const tipPerPerson = this.getTipPerPerson(cabin.roomType);
                const isHighTier = cabin.roomType === "Suite" || cabin.roomType === "The Haven";

                // Per-guest calculations
                const guestDetails = guests.map((guest, idx) => {
                    const position = idx + 1; // 1-indexed

                    // Fare: 50% off promo + 3rd/4th guest free
                    let fare, originalFare, discountedFareBeforeFree;
                    const isFreeGuest = FREE_GUEST_POSITIONS.includes(position);
                    if (cabin.isSolo) {
                        fare = discountedBase;
                        originalFare = cabin.basePrice;
                        discountedFareBeforeFree = discountedBase;
                    } else if (effectiveGuests === 1) {
                        fare = discountedBase;
                        originalFare = cabin.basePrice;
                        discountedFareBeforeFree = discountedBase;
                    } else if (position <= 2) {
                        fare = discountedBase / 2;
                        originalFare = cabin.basePrice / 2;
                        discountedFareBeforeFree = discountedBase / 2;
                    } else if (isFreeGuest) {
                        fare = 0;
                        originalFare = EXTRA_GUEST_FARE;
                        discountedFareBeforeFree = discountedExtra;
                    } else {
                        fare = discountedExtra;
                        originalFare = EXTRA_GUEST_FARE;
                        discountedFareBeforeFree = discountedExtra;
                    }

                    const tax = TAX_PER_PERSON;

                    // Tips: guests aged 3+ pay (FAS Plus covers guests 1&2)
                    const tipEligible = guest.age >= 3;
                    let tip = tipEligible ? tipPerPerson : 0;
                    let fasPlusFee = 0;

                    if (AppState.freeAtSeaPlus && position <= 2) {
                        fasPlusFee = 150;
                        tip = 0; // Tips included in FAS Plus
                    }

                    // Drink package
                    let drink = 0;
                    if (includeDrinks) {
                        if (guest.age >= 21) {
                            drink = 85.50;
                        } else if (position <= 2) {
                            drink = 37.50; // juice/soda substitute
                        }
                        // position 3+ and under 21: $0
                    }

                    // Dinner package: only first 2 guests
                    let dinner = 0;
                    if (includeDinner && position <= 2) {
                        if (guest.age >= 13) {
                            dinner = 20;
                        }
                        // under 13 in position 1-2: free (kids' menu)
                    }

                    const tipPreCruise = tipsBeforeCruise ? tip : 0;
                    const tipOnboard = tipsBeforeCruise ? 0 : tip;

                    const guestTotal = fare + tax + tipPreCruise + drink + dinner + fasPlusFee;
                    const guestFullCost = fare + tax + tip + drink + dinner + fasPlusFee;

                    return {
                        position,
                        guest,
                        fare,
                        originalFare,
                        discountedFareBeforeFree,
                        isFreeGuest,
                        tax,
                        tip,
                        tipPreCruise,
                        tipOnboard,
                        drink,
                        dinner,
                        fasPlusFee,
                        total: guestTotal,
                        fullCost: guestFullCost
                    };
                });

                const taxes = guestDetails.reduce((sum, g) => sum + g.tax, 0);
                const tips = guestDetails.reduce((sum, g) => sum + g.tip, 0);
                const tipsPreCruise = tipsBeforeCruise ? tips : 0;
                const tipsOnboard = tipsBeforeCruise ? 0 : tips;
                const drinks = guestDetails.reduce((sum, g) => sum + g.drink, 0);
                const dinner = guestDetails.reduce((sum, g) => sum + g.dinner, 0);
                const fasPlusCost = guestDetails.reduce((sum, g) => sum + g.fasPlusFee, 0);

                // Deposit credit reduces what you owe
                let depositCredit = 0;
                if (AppState.depositOption === 'credit150') {
                    depositCredit = 150;
                }

                const grandTotalBeforeCredit = totalFare + taxes + tipsPreCruise + drinks + dinner + fasPlusCost;
                const grandTotal = grandTotalBeforeCredit - depositCredit;
                const fullTripCost = totalFare + taxes + tips + drinks + dinner + fasPlusCost - depositCredit;

                // Original (undiscounted) totals for strikethrough display
                const originalTotalFare = cabin.isSolo
                    ? cabin.basePrice
                    : cabin.basePrice + Math.max(0, effectiveGuests - 2) * EXTRA_GUEST_FARE;
                // 50% off but without free guest promo (intermediate strikethrough)
                const discountedTotalFare = cabin.isSolo
                    ? discountedBase
                    : discountedBase + Math.max(0, effectiveGuests - 2) * discountedExtra;
                const originalPerPersonAvg = effectiveGuests > 0 ? originalTotalFare / effectiveGuests : 0;

                // Deposit amount: with $150 credit, you pay $150 unless 10% exceeds $300
                const baseDeposit = isHighTier ? Math.round(totalFare * 0.10) : 100;
                const deposit = AppState.depositOption === 'credit150'
                    ? (isHighTier && baseDeposit > 300 ? baseDeposit : 150)
                    : baseDeposit;
                const balance = grandTotal - deposit;

                // Per-person average
                const perPersonAvg = effectiveGuests > 0 ? grandTotal / effectiveGuests : 0;
                const allSameCost = guestDetails.length > 1
                    ? guestDetails.every(g => Math.abs(g.total - guestDetails[0].total) < 0.01)
                    : true;

                return {
                    totalFare,
                    originalTotalFare,
                    discountedTotalFare,
                    originalPerPersonAvg,
                    taxes,
                    tips,
                    tipsPreCruise,
                    tipsOnboard,
                    drinks,
                    dinner,
                    fasPlusCost,
                    depositCredit,
                    grandTotalBeforeCredit,
                    grandTotal,
                    fullTripCost,
                    deposit,
                    balance,
                    perPersonAvg,
                    allSameCost,
                    effectiveGuests,
                    exceedsMax,
                    guestDetails,
                    tipsBeforeCruise,
                    isHighTier
                };
            },

            buildGuestListFromMembers(members) {
                const adults = members.filter(m => m.age >= 21).map(m => ({ type: 'adult', age: m.age, label: m.name, name: m.name }));
                const children = members.filter(m => m.age < 21).sort((a, b) => b.age - a.age).map(m => ({ type: 'child', age: m.age, label: `${m.name} (${m.age})`, name: m.name }));
                return [...adults, ...children];
            },

            calculateForMembers(cabin, members, includeDrinks, includeDinner, tipsBeforeCruise) {
                const totalGuests = members.length;
                if (totalGuests === 0) {
                    return {
                        totalFare: 0, originalTotalFare: 0, discountedTotalFare: 0, originalPerPersonAvg: 0,
                        taxes: 0, tips: 0, tipsPreCruise: 0, tipsOnboard: 0, drinks: 0, dinner: 0, fasPlusCost: 0,
                        depositCredit: 0, grandTotalBeforeCredit: 0, grandTotal: 0, fullTripCost: 0,
                        deposit: 0, balance: 0, perPersonAvg: 0, allSameCost: true, effectiveGuests: 0, exceedsMax: false,
                        guestDetails: [], tipsBeforeCruise, isHighTier: false
                    };
                }
                const effectiveGuests = cabin.isSolo ? 1 : Math.min(totalGuests, cabin.maxGuests);
                const exceedsMax = totalGuests > cabin.maxGuests;

                const allGuests = this.buildGuestListFromMembers(members);
                const guests = allGuests.slice(0, effectiveGuests);

                const discountedBase = cabin.basePrice * (1 - PROMO_DISCOUNT);
                const discountedExtra = EXTRA_GUEST_FARE * (1 - PROMO_DISCOUNT);
                let totalFare;
                if (cabin.isSolo) {
                    totalFare = discountedBase;
                } else {
                    let paidExtras = 0;
                    for (let p = 3; p <= effectiveGuests; p++) {
                        if (!FREE_GUEST_POSITIONS.includes(p)) paidExtras++;
                    }
                    totalFare = discountedBase + paidExtras * discountedExtra;
                }

                const tipPerPerson = this.getTipPerPerson(cabin.roomType);
                const isHighTier = cabin.roomType === "Suite" || cabin.roomType === "The Haven";

                const guestDetails = guests.map((guest, idx) => {
                    const position = idx + 1;
                    let fare, originalFare, discountedFareBeforeFree;
                    const isFreeGuest = FREE_GUEST_POSITIONS.includes(position);
                    if (cabin.isSolo) {
                        fare = discountedBase; originalFare = cabin.basePrice; discountedFareBeforeFree = discountedBase;
                    } else if (effectiveGuests === 1) {
                        fare = discountedBase; originalFare = cabin.basePrice; discountedFareBeforeFree = discountedBase;
                    } else if (position <= 2) {
                        fare = discountedBase / 2; originalFare = cabin.basePrice / 2; discountedFareBeforeFree = discountedBase / 2;
                    } else if (isFreeGuest) {
                        fare = 0; originalFare = EXTRA_GUEST_FARE; discountedFareBeforeFree = discountedExtra;
                    } else {
                        fare = discountedExtra; originalFare = EXTRA_GUEST_FARE; discountedFareBeforeFree = discountedExtra;
                    }

                    const tax = TAX_PER_PERSON;
                    const tipEligible = guest.age >= 3;
                    let tip = tipEligible ? tipPerPerson : 0;
                    let fasPlusFee = 0;
                    if (AppState.freeAtSeaPlus && position <= 2) {
                        fasPlusFee = 150; tip = 0;
                    }

                    let drink = 0;
                    if (includeDrinks) {
                        if (guest.age >= 21) drink = 85.50;
                        else if (position <= 2) drink = 37.50;
                    }

                    let dinner = 0;
                    if (includeDinner && position <= 2) {
                        if (guest.age >= 13) dinner = 20;
                    }

                    const tipPreCruise = tipsBeforeCruise ? tip : 0;
                    const tipOnboard = tipsBeforeCruise ? 0 : tip;
                    const guestTotal = fare + tax + tipPreCruise + drink + dinner + fasPlusFee;
                    const guestFullCost = fare + tax + tip + drink + dinner + fasPlusFee;

                    return {
                        position, guest, fare, originalFare, discountedFareBeforeFree, isFreeGuest,
                        tax, tip, tipPreCruise, tipOnboard, drink, dinner, fasPlusFee,
                        total: guestTotal, fullCost: guestFullCost
                    };
                });

                const taxes = guestDetails.reduce((sum, g) => sum + g.tax, 0);
                const tips = guestDetails.reduce((sum, g) => sum + g.tip, 0);
                const tipsPreCruise = tipsBeforeCruise ? tips : 0;
                const tipsOnboard = tipsBeforeCruise ? 0 : tips;
                const drinks = guestDetails.reduce((sum, g) => sum + g.drink, 0);
                const dinner = guestDetails.reduce((sum, g) => sum + g.dinner, 0);
                const fasPlusCost = guestDetails.reduce((sum, g) => sum + g.fasPlusFee, 0);

                let depositCredit = 0;
                if (AppState.depositOption === 'credit150') depositCredit = 150;

                const grandTotalBeforeCredit = totalFare + taxes + tipsPreCruise + drinks + dinner + fasPlusCost;
                const grandTotal = grandTotalBeforeCredit - depositCredit;
                const fullTripCost = totalFare + taxes + tips + drinks + dinner + fasPlusCost - depositCredit;

                const originalTotalFare = cabin.isSolo
                    ? cabin.basePrice
                    : cabin.basePrice + Math.max(0, effectiveGuests - 2) * EXTRA_GUEST_FARE;
                const discountedTotalFare = cabin.isSolo
                    ? discountedBase
                    : discountedBase + Math.max(0, effectiveGuests - 2) * discountedExtra;
                const originalPerPersonAvg = effectiveGuests > 0 ? originalTotalFare / effectiveGuests : 0;

                const baseDeposit = isHighTier ? Math.round(totalFare * 0.10) : 100;
                const deposit = AppState.depositOption === 'credit150'
                    ? (isHighTier && baseDeposit > 300 ? baseDeposit : 150)
                    : baseDeposit;
                const balance = grandTotal - deposit;
                const perPersonAvg = effectiveGuests > 0 ? grandTotal / effectiveGuests : 0;
                const allSameCost = guestDetails.length > 1
                    ? guestDetails.every(g => Math.abs(g.total - guestDetails[0].total) < 0.01) : true;

                return {
                    totalFare, originalTotalFare, discountedTotalFare, originalPerPersonAvg,
                    taxes, tips, tipsPreCruise, tipsOnboard, drinks, dinner, fasPlusCost,
                    depositCredit, grandTotalBeforeCredit, grandTotal, fullTripCost,
                    deposit, balance, perPersonAvg, allSameCost, effectiveGuests, exceedsMax,
                    guestDetails, tipsBeforeCruise, isHighTier
                };
            },

            calculateConnectingPair(pair, room1Members, room2Members, includeDrinks, includeDinner, tipsBeforeCruise) {
                const room1 = this.calculateForMembers(pair.room1Cabin, room1Members, includeDrinks, includeDinner, tipsBeforeCruise);
                const room2 = this.calculateForMembers(pair.room2Cabin, room2Members, includeDrinks, includeDinner, tipsBeforeCruise);

                return {
                    room1,
                    room2,
                    combinedGrandTotal: room1.grandTotal + room2.grandTotal,
                    combinedDeposit: room1.deposit + room2.deposit,
                    combinedBalance: room1.balance + room2.balance,
                    exceedsMax: room1.exceedsMax || room2.exceedsMax,
                    room1Empty: room1Members.length === 0,
                    room2Empty: room2Members.length === 0
                };
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: amount % 1 === 0 ? 0 : 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }
        };

        // ==================== APP STATE ====================
        const AppState = {
            lang: 'en',
            currentFilter: 'All',
            currentSort: 'price-asc',
            includeDrinks: false,
            includeDinner: false,
            tipsBeforeCruise: false,
            selectedCabins: new Set(),
            openBreakdowns: new Set(),
            adultCount: 0,
            childCount: 0,
            childAges: [],
            depositOption: 'regular',
            freeAtSeaPlus: false,
            selectedGroups: new Set(),
            familyGroups: [],
            reservedGroups: [],
            guestNames: [],
            connectingRoomsEnabled: false,
            connectingRoom1Groups: new Set(),
            connectingRoom2Groups: new Set(),
            connectingOpenBreakdowns: new Set(),

            recomputeGuests() {
                let adults = 0, children = 0, ages = [], names = [];
                for (const label of this.selectedGroups) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => {
                        names.push(m.name);
                        if (m.age >= 21) adults++;
                        else { children++; ages.push(m.age); }
                    });
                }
                this.adultCount = adults;
                this.childCount = children;
                this.childAges = ages;
                this.guestNames = names;
            },

            getSelectedMembers() {
                const members = [];
                for (const label of this.selectedGroups) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => members.push(m));
                }
                return members;
            },

            getSelectedGroupLabels() {
                return Array.from(this.selectedGroups);
            },

            getMembersForGroups(groupLabels) {
                const members = [];
                for (const label of groupLabels) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => members.push(m));
                }
                return members;
            },

            resetConnectingRooms() {
                this.connectingRoomsEnabled = false;
                this.connectingRoom1Groups.clear();
                this.connectingRoom2Groups.clear();
                this.connectingOpenBreakdowns.clear();
                const toggle = document.getElementById('connectingRoomsSwitch');
                if (toggle) toggle.checked = false;
            },

            autoAssignConnectingRooms() {
                this.connectingRoom1Groups.clear();
                this.connectingRoom2Groups.clear();
                const labels = this.getSelectedGroupLabels();
                if (labels.length >= 1) this.connectingRoom1Groups.add(labels[0]);
                if (labels.length >= 2) this.connectingRoom2Groups.add(labels[1]);
            }
        };

        // ==================== RENDERER ====================
        const Renderer = {
            renderCabinCard(cabin) {
                const pricing = PriceCalculator.calculate(cabin, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise);
                const isSelected = AppState.selectedCabins.has(cabin.id);
                const isBreakdownOpen = AppState.openBreakdowns.has(cabin.id);
                const badgeClass = cabin.roomType.replace(/\s+/g, '-');
                const totalGuests = AppState.adultCount + AppState.childCount;
                const isDimmed = totalGuests > cabin.maxGuests;

                let fitBadge = '';
                if (totalGuests > 0 && !isDimmed) {
                    if (cabin.maxGuests === totalGuests) {
                        fitBadge = `<span class="fit-badge perfect">${t('cabin.perfectFit')}</span>`;
                    } else if (cabin.maxGuests >= totalGuests && cabin.maxGuests <= totalGuests + 2) {
                        fitBadge = `<span class="fit-badge good">${t('cabin.goodFit')}</span>`;
                    }
                }

                const namesForLabel = AppState.guestNames.length > 0
                    ? AppState.guestNames.slice(0, 3).join(', ') + (AppState.guestNames.length > 3 ? ' +' + (AppState.guestNames.length - 3) : '')
                    : (totalGuests > 0 ? totalGuests + ' ' + (totalGuests !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')) : t('guest.guestsDefault', {count: 2}));

                const avgSuffix = pricing.allSameCost ? '' : ' ' + t('cabin.avg');
                const perPersonText = `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalPerPersonAvg)}</span>${PriceCalculator.formatCurrency(pricing.perPersonAvg)}${t('cabin.perPerson')}${avgSuffix}`;

                return `
                    <article class="cabin-card ${isSelected ? 'selected' : ''} ${isDimmed ? 'dimmed' : ''}" data-id="${cabin.id}">
                        ${fitBadge}
                        ${isDimmed ? `<div class="max-guests-note">${t('cabin.maxGuests', {count: cabin.maxGuests, guestWord: cabin.maxGuests !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')})}</div>` : ''}
                        <div class="cabin-header">
                            <span class="cabin-type-badge badge-${badgeClass}">${t('roomType.' + cabin.roomType)}</span>
                            <h3 class="cabin-name">${cabin.name}</h3>
                            <div class="cabin-specs">
                                <span class="cabin-spec">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                    ${cabin.sqft} ${t('cabin.sqft')}
                                </span>
                                ${cabin.balconySqft ? `
                                    <span class="cabin-spec">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        </svg>
                                        ${cabin.balconySqft} ${t('cabin.sqftBalcony')}
                                    </span>
                                ` : ''}
                                <span class="cabin-spec">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    ${t('cabin.upTo', {count: cabin.maxGuests})}
                                </span>
                            </div>
                        </div>

                        <div class="cabin-body">
                            <div class="price-display">
                                <div class="price-label">${isDimmed ? t('cabin.priceIf', {count: cabin.maxGuests}) : t('cabin.totalFor', {names: namesForLabel})}</div>
                                <div class="price-amount" data-cabin-id="${cabin.id}">${PriceCalculator.formatCurrency(pricing.grandTotal)}</div>
                                <div class="price-per-person">${perPersonText}</div>
                                ${!AppState.tipsBeforeCruise && pricing.tipsOnboard > 0 ? `
                                    <div class="tips-onboard-note">${t('cabin.tipsOnboard', {amount: PriceCalculator.formatCurrency(pricing.tipsOnboard)})}</div>
                                ` : ''}
                            </div>

                            <div class="deposit-info">
                                <span class="deposit-label">${t('cabin.payToday')}${pricing.depositCredit > 0 ? ' <span class="credit-badge">-$' + pricing.depositCredit + ' credit</span>' : ''}</span>
                                <span class="deposit-amount">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                            </div>

                            <div class="cabin-actions">
                                <button class="btn btn-secondary toggle-breakdown" data-id="${cabin.id}">
                                    ${isBreakdownOpen ? t('cabin.hideBreakdown') : t('cabin.viewBreakdown')}
                                </button>
                                <button class="btn btn-compare ${isSelected ? 'selected' : ''}" data-id="${cabin.id}">
                                    ${isSelected ? t('cabin.selected') : t('cabin.compare')}
                                </button>
                            </div>

                            ${AppState.selectedGroups.size > 0 && !isDimmed ? `
                                <button class="btn btn-select-cabin" data-id="${cabin.id}" data-mode="single">
                                    ${t('cabin.selectThis')}
                                </button>
                            ` : ''}

                            <div class="breakdown ${isBreakdownOpen ? 'open' : ''}" data-breakdown-id="${cabin.id}">
                                <div class="breakdown-content">
                                    ${this.renderBreakdown(cabin, pricing)}
                                </div>
                            </div>
                        </div>

                        <a href="${NCL_LINKS[cabin.roomType]}" target="_blank" rel="noopener" class="ncl-link">
                            ${t('cabin.viewNcl')} &rarr;
                        </a>
                    </article>
                `;
            },

            renderBreakdown(cabin, pricing) {
                const tipRate = PriceCalculator.getTipPerPersonPerDay(cabin.roomType);
                let html = '';

                // Summary section
                const hasFreeGuests = pricing.guestDetails.some(g => g.isFreeGuest);
                const promoLabels = hasFreeGuests ? t('breakdown.promoFull') : t('breakdown.promoHalf');
                const fareStrikethrough = hasFreeGuests && pricing.discountedTotalFare !== pricing.totalFare
                    ? `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalTotalFare)}</span><span class="original-price">${PriceCalculator.formatCurrency(pricing.discountedTotalFare)}</span> ${PriceCalculator.formatCurrency(pricing.totalFare)}`
                    : `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalTotalFare)}</span> ${PriceCalculator.formatCurrency(pricing.totalFare)}`;
                const guestCountLabel = cabin.isSolo ? t('breakdown.oneGuest') : t('breakdown.nGuests', {count: pricing.effectiveGuests});
                html += `
                    <div class="breakdown-row">
                        <span class="breakdown-label">${t('breakdown.baseFare', {count: guestCountLabel})} <span style="color:var(--teal);font-weight:600;font-size:0.75rem;">${promoLabels}</span></span>
                        <span class="breakdown-value">${fareStrikethrough}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">${t('breakdown.taxes', {rate: TAX_PER_PERSON, count: pricing.effectiveGuests})}</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.taxes)}</span>
                    </div>
                `;

                if (AppState.tipsBeforeCruise) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.gratuities', {rate: tipRate, nights: CRUISE_NIGHTS, count: pricing.guestDetails.filter(g => g.tip > 0).length})}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.tips)}</span>
                        </div>
                    `;
                }

                if (AppState.includeDrinks) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.drinkPkg')}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.drinks)}</span>
                        </div>
                    `;
                }

                if (AppState.includeDinner) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.dinnerPkg')}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.dinner)}</span>
                        </div>
                    `;
                }

                if (pricing.fasPlusCost > 0) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.fasPlus', {count: pricing.guestDetails.filter(g => g.fasPlusFee > 0).length})}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.fasPlusCost)}</span>
                        </div>
                    `;
                }

                if (pricing.depositCredit > 0) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.subtotal')}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.grandTotalBeforeCredit)}</span>
                        </div>
                        <div class="breakdown-row" style="color: var(--teal);">
                            <span class="breakdown-label">${t('breakdown.depositCredit')}</span>
                            <span class="breakdown-value">-${PriceCalculator.formatCurrency(pricing.depositCredit)}</span>
                        </div>
                    `;
                }

                html += `
                    <div class="breakdown-row total">
                        <span class="breakdown-label">${t('breakdown.totalDue')}</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.grandTotal)}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">${t('breakdown.deposit')}</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">${t('breakdown.balance')}</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.balance)}</span>
                    </div>
                    ${pricing.balance > 0 ? (() => {
                        const now = new Date();
                        const deadline = new Date(2026, 6, 23);
                        let months = 0;
                        let d = new Date(now.getFullYear(), now.getMonth(), 23);
                        if (d <= now) d.setMonth(d.getMonth() + 1);
                        while (d <= deadline) { months++; d.setMonth(d.getMonth() + 1); }
                        if (months > 0) {
                            const perMonth = pricing.balance / months;
                            return '<div class="breakdown-row" style="border-bottom:none;padding-top:0;"><span class="breakdown-label" style="font-size:0.75rem;font-style:italic;color:var(--gray-400);">' + t('breakdown.perMonth', {amount: PriceCalculator.formatCurrency(perMonth), months: months}) + '</span></div>';
                        }
                        return '';
                    })() : ''}
                `;

                if (!AppState.tipsBeforeCruise && pricing.tipsOnboard > 0) {
                    html += `
                        <div class="breakdown-row tips-onboard">
                            <span class="breakdown-label">${t('breakdown.gratOnboard')}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.tipsOnboard)}</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">${t('breakdown.fullTrip')}</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.fullTripCost)}</span>
                        </div>
                    `;
                }

                // Per-guest breakdown
                html += `<div class="breakdown-section-header">${t('breakdown.perGuest')}</div>`;

                pricing.guestDetails.forEach(gd => {
                    const items = [];
                    if (gd.isFreeGuest) {
                        items.push(`<span class="original-price">${PriceCalculator.formatCurrency(gd.originalFare)}</span><span class="original-price">${PriceCalculator.formatCurrency(gd.discountedFareBeforeFree)}</span>${t('breakdown.freeFare')}`);
                    } else {
                        items.push(`<span class="original-price">${PriceCalculator.formatCurrency(gd.originalFare)}</span>${PriceCalculator.formatCurrency(gd.fare)} ${t('breakdown.fare')}`);
                    }
                    items.push(`${PriceCalculator.formatCurrency(gd.tax)} ${t('breakdown.tax')}`);

                    if (gd.fasPlusFee > 0) {
                        items.push(`${PriceCalculator.formatCurrency(gd.fasPlusFee)} FAS+`);
                        items.push(t('breakdown.tipIncl'));
                    } else if (gd.tip > 0) {
                        if (!AppState.tipsBeforeCruise) {
                            items.push(`${PriceCalculator.formatCurrency(0)} ${t('breakdown.tipOnboard', {amount: PriceCalculator.formatCurrency(gd.tip)})}`);
                        } else {
                            items.push(`${PriceCalculator.formatCurrency(gd.tip)} ${t('breakdown.tip')}`);
                        }
                    } else {
                        items.push(t('breakdown.tipZero'));
                    }

                    if (AppState.includeDrinks) {
                        if (gd.drink > 0) {
                            if (gd.guest.age < 21 && gd.position <= 2) {
                                items.push(`${PriceCalculator.formatCurrency(gd.drink)} ${t('breakdown.sodaJuice')}`);
                            } else {
                                items.push(`${PriceCalculator.formatCurrency(gd.drink)} ${t('breakdown.drink')}`);
                            }
                        } else {
                            items.push(t('breakdown.drinkZero'));
                        }
                    }

                    if (AppState.includeDinner) {
                        if (gd.position <= 2) {
                            if (gd.dinner > 0) {
                                items.push(`${PriceCalculator.formatCurrency(gd.dinner)} ${t('breakdown.dinner')}`);
                            } else {
                                items.push(t('breakdown.dinnerZero'));
                            }
                        }
                    }

                    // Build free tags
                    const freeTags = [];
                    if (gd.isFreeGuest) freeTags.push(t('breakdown.freeCruiseFare'));
                    if (gd.tip === 0 && gd.guest.age < 3) freeTags.push(t('breakdown.freeTips'));
                    if (AppState.includeDrinks && gd.drink === 0 && gd.position > 2 && gd.guest.age < 21) freeTags.push(t('breakdown.freeDrinks'));
                    if (AppState.includeDinner && gd.dinner === 0 && gd.position <= 2 && gd.guest.age < 13) freeTags.push(t('breakdown.freeDinner'));

                    const freeTagsHtml = freeTags.map(tag => `<span class="free-tag">${t('breakdown.free', {item: tag})}</span>`).join(' ');

                    const guestTypeLabel = gd.guest.type === 'adult' ? t('breakdown.adult') : t('breakdown.ageN', {age: gd.guest.age});
                    html += `
                        <div class="guest-breakdown-row">
                            <div>
                                <div class="guest-breakdown-label">${gd.guest.name || 'Guest ' + gd.position} (${guestTypeLabel}) ${freeTagsHtml}</div>
                                <div class="guest-breakdown-detail">${items.join(' + ')}</div>
                            </div>
                            <div class="guest-breakdown-value">${PriceCalculator.formatCurrency(gd.total)}</div>
                        </div>
                    `;
                });

                return html;
            },

            renderGrid() {
                const grid = document.getElementById('cabinGrid');
                let filteredData = CABIN_DATA;

                // Apply filter
                if (AppState.currentFilter !== 'All') {
                    filteredData = filteredData.filter(c => c.roomType === AppState.currentFilter);
                }

                // Apply sort, pushing dimmed cabins (exceeding max guests) to the bottom
                const totalGuests = AppState.adultCount + AppState.childCount;
                filteredData = [...filteredData].sort((a, b) => {
                    const aDimmed = totalGuests > a.maxGuests ? 1 : 0;
                    const bDimmed = totalGuests > b.maxGuests ? 1 : 0;
                    if (aDimmed !== bDimmed) return aDimmed - bDimmed;

                    const priceA = PriceCalculator.calculate(a, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise).grandTotal;
                    const priceB = PriceCalculator.calculate(b, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise).grandTotal;
                    const sqftA = parseInt(a.sqft.split('-')[0].replace(/,/g, ''));
                    const sqftB = parseInt(b.sqft.split('-')[0].replace(/,/g, ''));

                    switch (AppState.currentSort) {
                        case 'price-asc': return priceA - priceB;
                        case 'price-desc': return priceB - priceA;
                        case 'sqft-asc': return sqftA - sqftB;
                        case 'sqft-desc': return sqftB - sqftA;
                        default: return 0;
                    }
                });

                if (filteredData.length === 0) {
                    grid.innerHTML = `
                        <div class="no-results">
                            <div class="no-results-icon">&#128674;</div>
                            <p>${t('noResults.text')}</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = filteredData.map(cabin => this.renderCabinCard(cabin)).join('');
            },

            updatePrices() {
                document.querySelectorAll('.price-amount').forEach(el => {
                    el.classList.add('flash');
                    setTimeout(() => el.classList.remove('flash'), 500);
                });

                this.renderGrid();
                this.updateToggleLabels();
                this.updateRunningTotals();
                this.renderConnectingPairsGrid();
            },

            updateToggleLabels() {
                // Drink toggle
                const guests = PriceCalculator.buildGuestList();
                const totalGuests = AppState.adultCount + AppState.childCount;

                let drinkTotal = 0;
                let drinkParts = [];
                const adultsCount = guests.filter(g => g.age >= 21).length;
                const under21Pos1or2 = guests.filter((g, i) => g.age < 21 && i < 2).length;

                if (adultsCount > 0) {
                    drinkTotal += adultsCount * 85.50;
                    drinkParts.push(t('toggle.drinkAdult', {count: adultsCount, word: adultsCount > 1 ? t('guest.adults_plural') : t('guest.adult')}));
                }
                if (under21Pos1or2 > 0) {
                    drinkTotal += under21Pos1or2 * 37.50;
                    drinkParts.push(t('toggle.drinkChild', {count: under21Pos1or2}));
                }

                document.getElementById('drinkToggleDesc').textContent = drinkParts.length > 0
                    ? `+${PriceCalculator.formatCurrency(drinkTotal)} (${drinkParts.join(', ')})`
                    : t('toggle.noEligible');

                // Dinner toggle
                const dinnerEligible = Math.min(totalGuests, 2);
                const dinnerGuests = guests.slice(0, 2);
                let dinnerTotal = 0;
                dinnerGuests.forEach(g => {
                    if (g.age >= 13) dinnerTotal += 20;
                });
                if (dinnerTotal > 0) {
                    document.getElementById('dinnerToggleDesc').textContent =
                        `+${PriceCalculator.formatCurrency(dinnerTotal)} (${t('toggle.dinnerDesc', {count: dinnerEligible})})`;
                } else if (dinnerEligible > 0) {
                    document.getElementById('dinnerToggleDesc').textContent = t('toggle.freeChildren');
                } else {
                    document.getElementById('dinnerToggleDesc').textContent = t('toggle.noEligible');
                }
            },

            updateRunningTotals() {
                const totalsEl = document.getElementById('runningTotals');
                const packageTotalEl = document.getElementById('packageTotal');

                // Calculate based on current guest config
                const guests = PriceCalculator.buildGuestList();
                let packageTotal = 0;

                if (AppState.includeDrinks) {
                    guests.forEach((g, i) => {
                        if (g.age >= 21) packageTotal += 85.50;
                        else if (i < 2) packageTotal += 37.50;
                    });
                }

                if (AppState.includeDinner) {
                    guests.slice(0, 2).forEach(g => {
                        if (g.age >= 13) packageTotal += 20;
                    });
                }

                if (AppState.freeAtSeaPlus) {
                    const fasGuests = Math.min(guests.length, 2);
                    packageTotal += fasGuests * 150;
                }

                if (packageTotal > 0) {
                    totalsEl.style.display = 'flex';
                    packageTotalEl.textContent = PriceCalculator.formatCurrency(packageTotal);
                } else {
                    totalsEl.style.display = 'none';
                }
            },

            updateComparisonTray() {
                const tray = document.getElementById('comparisonTray');
                const count = document.getElementById('trayCount');

                count.textContent = AppState.selectedCabins.size;

                if (AppState.selectedCabins.size > 0) {
                    tray.classList.add('visible');
                } else {
                    tray.classList.remove('visible');
                }
            },

            renderComparison() {
                const grid = document.getElementById('comparisonGrid');
                const selectedCabins = CABIN_DATA.filter(c => AppState.selectedCabins.has(c.id));

                grid.className = `comparison-grid cols-${selectedCabins.length}`;

                grid.innerHTML = selectedCabins.map(cabin => {
                    const pricing = PriceCalculator.calculate(cabin, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise);
                    const badgeClass = cabin.roomType.replace(/\s+/g, '-');

                    const perPersonText = pricing.allSameCost
                        ? PriceCalculator.formatCurrency(pricing.perPersonAvg)
                        : `${PriceCalculator.formatCurrency(pricing.perPersonAvg)} ${t('cabin.avg')}`;

                    return `
                        <div class="comparison-column">
                            <div class="comparison-cabin-header">
                                <span class="cabin-type-badge badge-${badgeClass}">${t('roomType.' + cabin.roomType)}</span>
                                <div class="comparison-cabin-name">${cabin.name}</div>
                            </div>
                            <div class="comparison-cabin-body">
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.cabinSize')}</span>
                                    <span class="comparison-value">${cabin.sqft} ${t('cabin.sqft')}</span>
                                </div>
                                ${cabin.balconySqft ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">${t('compare.balcony')}</span>
                                        <span class="comparison-value">${cabin.balconySqft} ${t('cabin.sqft')}</span>
                                    </div>
                                ` : `
                                    <div class="comparison-row">
                                        <span class="comparison-label">${t('compare.balcony')}</span>
                                        <span class="comparison-value">-</span>
                                    </div>
                                `}
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.maxGuests')}</span>
                                    <span class="comparison-value">${cabin.maxGuests}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.perPerson')}</span>
                                    <span class="comparison-value">${perPersonText}</span>
                                </div>
                                <div class="comparison-row highlight">
                                    <span class="comparison-label">${t('compare.baseFare')}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.totalFare)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.taxes')}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.taxes)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.gratuities')}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.tips)}</span>
                                </div>
                                ${pricing.fasPlusCost > 0 ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">${t('compare.fasPlus')}</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.fasPlusCost)}</span>
                                    </div>
                                ` : ''}
                                ${AppState.includeDrinks ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">${t('compare.drinkPkg')}</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.drinks)}</span>
                                    </div>
                                ` : ''}
                                ${AppState.includeDinner ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">${t('compare.dinnerPkg')}</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.dinner)}</span>
                                    </div>
                                ` : ''}
                                <div class="comparison-row highlight">
                                    <span class="comparison-label">${t('compare.deposit')}${pricing.depositCredit > 0 ? ' <span class="credit-badge">-$' + pricing.depositCredit + ' credit</span>' : ''}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">${t('compare.balanceDue')}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.balance)}</span>
                                </div>
                            </div>
                            <div class="comparison-total">
                                <div class="comparison-total-label">${t('compare.grandTotal')}</div>
                                <div class="comparison-total-amount">${PriceCalculator.formatCurrency(pricing.grandTotal)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderConnectingPairCard(pair, combinedPricing) {
                const { room1, room2, combinedGrandTotal, combinedDeposit, exceedsMax, room1Empty, room2Empty } = combinedPricing;
                const isOpen = AppState.connectingOpenBreakdowns.has(pair.id);
                const isDimmed = exceedsMax || room1Empty || room2Empty;

                const badgeClass1 = pair.room1Cabin.roomType.replace(/\s+/g, '-');
                const badgeClass2 = pair.room2Cabin.roomType.replace(/\s+/g, '-');

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);
                const room1Names = room1Members.map(m => m.name).join(', ') || t('connectPair.noGuests');
                const room2Names = room2Members.map(m => m.name).join(', ') || t('connectPair.noGuests');

                let warningHtml = '';
                if (room1Empty || room2Empty) {
                    warningHtml = `<div class="max-guests-note">${t('connectPair.assignBoth')}</div>`;
                } else if (room1.exceedsMax) {
                    warningHtml = `<div class="max-guests-note">${t('connectPair.roomMax', {room: '1', count: pair.room1Cabin.maxGuests})}</div>`;
                } else if (room2.exceedsMax) {
                    warningHtml = `<div class="max-guests-note">${t('connectPair.roomMax', {room: '2', count: pair.room2Cabin.maxGuests})}</div>`;
                }

                const room1Specs = `${pair.room1Cabin.sqft} ${t('cabin.sqft')}${pair.room1Cabin.balconySqft ? ', ' + pair.room1Cabin.balconySqft + ' ' + t('cabin.sqftBalcony') : ''} \u00B7 ${t('connectPair.max', {count: pair.room1Cabin.maxGuests})}`;
                const room2Specs = `${pair.room2Cabin.sqft} ${t('cabin.sqft')}${pair.room2Cabin.balconySqft ? ', ' + pair.room2Cabin.balconySqft + ' ' + t('cabin.sqftBalcony') : ''} \u00B7 ${t('connectPair.max', {count: pair.room2Cabin.maxGuests})}`;

                let breakdownHtml = '';
                if (isOpen && !room1Empty && !room2Empty) {
                    breakdownHtml = `
                        <div class="connecting-breakdown open">
                            <div class="connecting-breakdown-room-title">${t('connectPair.room1')}: ${pair.room1Cabin.name}</div>
                            ${Renderer.renderBreakdown(pair.room1Cabin, room1)}
                            <div class="connecting-breakdown-room-title" style="margin-top:1rem;">${t('connectPair.room2')}: ${pair.room2Cabin.name}</div>
                            ${Renderer.renderBreakdown(pair.room2Cabin, room2)}
                        </div>
                    `;
                }

                return `
                    <div class="connecting-card ${isDimmed ? 'dimmed' : ''}" data-pair-id="${pair.id}">
                        <div class="connecting-card-top"></div>
                        <div class="connecting-card-body">
                            ${warningHtml}
                            <div class="connecting-card-label">
                                <span class="connecting-link-icon">&#128279;</span>
                                ${t('roomType.' + pair.room1Cabin.roomType)} + ${t('roomType.' + pair.room2Cabin.roomType)}
                            </div>

                            <div class="connecting-room-row">
                                <div class="connecting-room-info">
                                    <div class="connecting-room-info-header">${t('connectPair.room1')}</div>
                                    <span class="connecting-room-type-badge cabin-type-badge badge-${badgeClass1}">${t('roomType.' + pair.room1Cabin.roomType)}</span>
                                    <div class="connecting-room-specs">${room1Specs}</div>
                                    <div class="connecting-room-guests">${room1Names}</div>
                                    ${!room1Empty ? `<div class="connecting-room-subtotal">${PriceCalculator.formatCurrency(room1.grandTotal)}</div>` : ''}
                                </div>
                                <div class="connecting-room-info">
                                    <div class="connecting-room-info-header">${t('connectPair.room2')}</div>
                                    <span class="connecting-room-type-badge cabin-type-badge badge-${badgeClass2}">${t('roomType.' + pair.room2Cabin.roomType)}</span>
                                    <div class="connecting-room-specs">${room2Specs}</div>
                                    <div class="connecting-room-guests">${room2Names}</div>
                                    ${!room2Empty ? `<div class="connecting-room-subtotal">${PriceCalculator.formatCurrency(room2.grandTotal)}</div>` : ''}
                                </div>
                            </div>

                            ${!isDimmed ? `
                                <div class="connecting-combined">
                                    <div>
                                        <div class="connecting-combined-label">${t('connectPair.combinedTotal')}</div>
                                        <div class="connecting-combined-deposit">${t('connectPair.deposit')} ${PriceCalculator.formatCurrency(combinedDeposit)}</div>
                                    </div>
                                    <div class="connecting-combined-total">${PriceCalculator.formatCurrency(combinedGrandTotal)}</div>
                                </div>
                            ` : ''}

                            <div class="connecting-card-actions">
                                <button class="btn btn-secondary toggle-connecting-breakdown" data-pair-id="${pair.id}">
                                    ${isOpen ? t('cabin.hideBreakdown') : t('cabin.viewBreakdown')}
                                </button>
                            </div>

                            ${!isDimmed && !room1Empty && !room2Empty ? `
                                <button class="btn btn-select-cabin" data-pair-id="${pair.id}" data-mode="connecting">
                                    ${t('cabin.selectThis')}
                                </button>
                            ` : ''}

                            ${breakdownHtml}
                        </div>
                    </div>
                `;
            },

            renderConnectingPairsGrid() {
                const section = document.getElementById('connectingPairsSection');
                const grid = document.getElementById('connectingPairsGrid');

                if (!AppState.connectingRoomsEnabled || CONNECTING_PAIRS.length === 0) {
                    section.classList.remove('visible');
                    return;
                }

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);

                if (room1Members.length === 0 && room2Members.length === 0) {
                    section.classList.remove('visible');
                    return;
                }

                section.classList.add('visible');

                const cards = CONNECTING_PAIRS.map(pair => {
                    const combinedPricing = PriceCalculator.calculateConnectingPair(
                        pair, room1Members, room2Members,
                        AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise
                    );
                    return { pair, combinedPricing };
                });

                // Sort: non-dimmed first by combined price, dimmed at end
                cards.sort((a, b) => {
                    const aDimmed = a.combinedPricing.exceedsMax || a.combinedPricing.room1Empty || a.combinedPricing.room2Empty ? 1 : 0;
                    const bDimmed = b.combinedPricing.exceedsMax || b.combinedPricing.room1Empty || b.combinedPricing.room2Empty ? 1 : 0;
                    if (aDimmed !== bDimmed) return aDimmed - bDimmed;
                    return a.combinedPricing.combinedGrandTotal - b.combinedPricing.combinedGrandTotal;
                });

                grid.innerHTML = cards.map(({ pair, combinedPricing }) =>
                    this.renderConnectingPairCard(pair, combinedPricing)
                ).join('');
            }
        };

        // ==================== APP CONTROLLER ====================
        const App = {
            async init() {
                CABIN_DATA = await CSVParser.load('cabin_base_price_20260131.csv');
                const familyData = await FamilyCSVParser.load('family_groups.csv');
                AppState.familyGroups = familyData.unbookedGroups;
                AppState.reservedGroups = familyData.reservedGroups;

                // Load connecting rooms data (requires CABIN_DATA to be loaded first)
                CONNECTING_PAIRS = await ConnectingRoomsParser.load('connectingRooms.csv', 'cabin_code_map.csv');

                if (CABIN_DATA.length === 0) {
                    document.getElementById('cabinGrid').innerHTML = `
                        <div class="no-results">
                            <div class="no-results-icon">&#9888;</div>
                            <p>${t('noResults.loadFail')}</p>
                        </div>
                    `;
                    return;
                }

                this.renderFamilyButtons();
                this.renderTracker();
                this.updateTabBadges();
                this.startCountdowns();
                this.initEasterEgg();
                this.bindEvents();
                Renderer.updateToggleLabels();
                this.updateFasPlusAvailability();
                this.updateFasPlusDisplay();
                this.updateGuestDisplay();
                Renderer.renderGrid();

                // Restore saved language preference
                const savedLang = localStorage.getItem('cruise-lang');
                if (savedLang && savedLang !== 'en') {
                    switchLanguage(savedLang);
                }

                // Load visitor counter (non-blocking)
                loadVisitorCounter();
            },

            renderFamilyButtons() {
                const container = document.getElementById('familyButtons');
                container.innerHTML = AppState.familyGroups.map((group, idx) => {
                    const color = FAMILY_COLORS[idx % FAMILY_COLORS.length];
                    return `<button class="family-btn" data-label="${group.label}" style="--family-color:${color}">
                        <span class="family-color-dot" style="background:${color}"></span>
                        ${group.label}
                        <span class="member-count">${group.members.length}</span>
                    </button>`;
                }).join('');
            },

            toggleFamilyGroup(label) {
                const wasSelected = AppState.selectedGroups.has(label);
                if (wasSelected) {
                    AppState.selectedGroups.delete(label);
                    // Remove from room assignments
                    AppState.connectingRoom1Groups.delete(label);
                    AppState.connectingRoom2Groups.delete(label);
                } else {
                    AppState.selectedGroups.add(label);
                }

                const groupCount = AppState.selectedGroups.size;
                const toggleEl = document.getElementById('connectingRoomsToggle');

                if (groupCount >= 2) {
                    toggleEl.classList.add('visible');
                } else {
                    toggleEl.classList.remove('visible');
                    if (AppState.connectingRoomsEnabled) {
                        AppState.resetConnectingRooms();
                    }
                }

                // Handle connecting room assignments
                if (AppState.connectingRoomsEnabled) {
                    if (groupCount < 2) {
                        AppState.resetConnectingRooms();
                    } else if (groupCount === 2) {
                        AppState.autoAssignConnectingRooms();
                    } else if (!wasSelected) {
                        // New group added with 3+ groups: add to Room 1 by default
                        AppState.connectingRoom1Groups.add(label);
                    }
                    this.updateRoomAssignmentUI();
                    this.renderRoomAssignmentChips();
                }

                AppState.recomputeGuests();
                this.updateGuestDisplay();
                this.updateGuestSummary();
                this.updateSuggestionBanner();
                this.updateGrandTotalFloat();
                this.updateFasPlusDisplay();
                Renderer.updatePrices();
                document.querySelectorAll('.family-btn').forEach(btn => {
                    btn.classList.toggle('active', AppState.selectedGroups.has(btn.dataset.label));
                });
            },

            updateGuestSummary() {
                const el = document.getElementById('guestSummary');
                const textEl = document.getElementById('guestSummaryText');
                const namesEl = document.getElementById('guestSummaryNames');
                const members = AppState.getSelectedMembers();
                if (members.length === 0) { el.style.display = 'none'; return; }
                el.style.display = 'block';
                const adults = members.filter(m => m.age >= 21).length;
                const children = members.filter(m => m.age < 21);
                let text = `${t('guest.selected')} <strong>${adults} ${adults !== 1 ? t('guest.adults_plural') : t('guest.adult')}</strong>`;
                if (children.length > 0) {
                    text += `, <strong>${children.length} ${children.length !== 1 ? t('guest.children_plural') : t('guest.child')}</strong> (${children.map(c => t('guest.age') + ' ' + c.age).join(', ')})`;
                }
                text += ` = <strong>${members.length} ${members.length !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')}</strong>`;
                textEl.innerHTML = text;
                namesEl.textContent = members.map(m => m.name).join(', ');
            },

            updateSuggestionBanner() {
                const banner = document.getElementById('suggestionBanner');
                const text = document.getElementById('suggestionText');
                const total = AppState.adultCount + AppState.childCount;
                if (total > 4 && AppState.selectedGroups.size >= 2) {
                    const maxCabin = Math.max(...CABIN_DATA.map(c => c.maxGuests));
                    if (total > maxCabin || CABIN_DATA.filter(c => c.maxGuests >= total).length <= 3) {
                        banner.style.display = 'block';
                        text.textContent = t('suggestion.split', {count: total});
                        return;
                    }
                }
                banner.style.display = 'none';
            },

            updateGrandTotalFloat() {
                const el = document.getElementById('grandTotalFloat');
                const labelEl = document.getElementById('grandTotalLabel');
                const amountEl = document.getElementById('grandTotalAmount');
                const total = AppState.adultCount + AppState.childCount;
                if (total === 0) { el.classList.remove('visible'); return; }
                const labels = AppState.getSelectedGroupLabels().join(' + ');
                labelEl.textContent = `${t('grandTotal.pricingFor')} ${labels}`;
                amountEl.textContent = `${total} ${total !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')}`;
                el.classList.add('visible');
            },

            updateGuestDisplay() {
                const total = AppState.adultCount + AppState.childCount;
                document.getElementById('adultCount').textContent = AppState.adultCount;
                document.getElementById('childCount').textContent = AppState.childCount;
                document.getElementById('guestTotal').textContent = total > 0
                    ? t('guest.total', {count: total, guestWord: total !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')})
                    : t('guest.selectFamily');
            },

            updateFasPlusAvailability() {
                const fasPlusToggle = document.getElementById('fasPlusToggle');
                const requiresEl = document.getElementById('fasPlusRequires');
                const bothSelected = AppState.includeDrinks && AppState.includeDinner;

                // If drink or dinner is turned off while FAS Plus is on, turn off FAS Plus
                if (!bothSelected && AppState.freeAtSeaPlus) {
                    fasPlusToggle.checked = false;
                    AppState.freeAtSeaPlus = false;
                }

                // Show/hide the note (toggle always stays enabled)
                if (bothSelected) {
                    requiresEl.style.display = 'none';
                } else {
                    requiresEl.style.display = 'block';
                }

                this.updateFasPlusDisplay();
                Renderer.updatePrices();
            },

            updateFasPlusDisplay() {
                const descEl = document.getElementById('fasPlusDesc');
                const savingsEl = document.getElementById('fasPlusSavings');
                const guests = PriceCalculator.buildGuestList();
                const fasGuestCount = Math.min(guests.length, 2);
                const fasCost = fasGuestCount * 150;

                descEl.textContent = t('fas.desc', {cost: PriceCalculator.formatCurrency(fasCost), count: fasGuestCount, guestWord: fasGuestCount !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')});

                if (AppState.freeAtSeaPlus) {
                    // Calculate tip savings
                    let tipSavings = 0;
                    guests.slice(0, 2).forEach(g => {
                        if (g.age >= 3) {
                            // Use a representative tip rate (we don't know the cabin here)
                            // Show generic savings message instead
                            tipSavings += 60; // minimum tip rate
                        }
                    });
                    if (tipSavings > 0) {
                        savingsEl.style.display = 'block';
                        savingsEl.textContent = t('fas.savings', {low: tipSavings, high: Math.round(tipSavings * 75/60)});
                    } else {
                        savingsEl.style.display = 'none';
                    }
                } else {
                    savingsEl.style.display = 'none';
                }
            },

            populateCostBenefitTable() {
                const table = document.getElementById('costBenefitTable');
                const guests = PriceCalculator.buildGuestList();
                const fasGuestCount = Math.min(guests.length, 2);
                const fasCost = fasGuestCount * 150;

                let html = `
                    <thead>
                        <tr>
                            <th>${t('cbt.item')}</th>
                            <th>${t('cbt.without')}</th>
                            <th>${t('cbt.with')}</th>
                        </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="3" style="font-weight:600;color:var(--ocean-blue);padding-top:0.5rem;">${t('cbt.packageCost')}</td></tr>
                    <tr>
                        <td>${t('cbt.fasLine', {nights: CRUISE_NIGHTS, guests: fasGuestCount})}</td>
                        <td>$0</td>
                        <td>+${PriceCalculator.formatCurrency(fasCost)}</td>
                    </tr>
                    <tr><td colspan="3" style="font-weight:600;color:var(--teal);padding-top:1rem;">${t('cbt.savingsValue')}</td></tr>
                `;

                // Tip savings per cabin tier
                const tiers = [
                    { label: t('cbt.standardCabins'), tipPerDay: 20 },
                    { label: t('cbt.suiteHaven'), tipPerDay: 25 }
                ];

                tiers.forEach(tier => {
                    const tipTotal = tier.tipPerDay * CRUISE_NIGHTS * fasGuestCount;
                    html += `
                        <tr>
                            <td>${t('cbt.prepaidGrat', {label: tier.label})}</td>
                            <td>${t('cbt.paySeparately')}</td>
                            <td class="savings">-${PriceCalculator.formatCurrency(tipTotal)} ${t('cbt.included')}</td>
                        </tr>
                    `;
                });

                html += `
                    <tr>
                        <td>${t('cbt.gscBar')}</td>
                        <td>${t('cbt.gscBarDesc')}</td>
                        <td class="savings">-$50 to -$100+ value</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.starbucks')}</td>
                        <td>$0</td>
                        <td class="savings">-$20 to -$40+ (~$6-8)</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.topShelf')}</td>
                        <td>$0</td>
                        <td class="savings">-$15 to -$50+ ($15+)</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.energy')}</td>
                        <td>$0</td>
                        <td class="savings">-$20 to -$40 (~$6.25)</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.water')}</td>
                        <td>$0</td>
                        <td class="savings">-$15 to -$30 ($4.50)</td>
                    </tr>
                    <tr><td colspan="3" style="font-weight:600;color:var(--ocean-blue);padding-top:1rem;">${t('cbt.gscPrices')}</td></tr>
                    <tr>
                        <td>${t('cbt.cocktails')}</td>
                        <td>${t('cbt.cocktailPrice')}</td>
                        <td class="savings">${t('cbt.included')}</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.beer')}</td>
                        <td>${t('cbt.beerPrice')}</td>
                        <td class="savings">${t('cbt.included')}</td>
                    </tr>
                    <tr>
                        <td>${t('cbt.soda')}</td>
                        <td>${t('cbt.sodaPrice')}</td>
                        <td class="savings">${t('cbt.included')}</td>
                    </tr>
                    <tr>
                        <td><em>${t('cbt.example')}</em></td>
                        <td><em>${t('cbt.examplePrice')}</em></td>
                        <td class="savings"><em>$0</em></td>
                    </tr>
                `;

                // Net cost summary
                const tipSavingsLow = 20 * CRUISE_NIGHTS * fasGuestCount;
                const tipSavingsHigh = 25 * CRUISE_NIGHTS * fasGuestCount;
                const netLow = fasCost - tipSavingsHigh;
                const netHigh = fasCost - tipSavingsLow;

                html += `
                    <tr class="total-row" style="background: rgba(13,148,136,0.1);">
                        <td>${t('cbt.netCost')}</td>
                        <td>&mdash;</td>
                        <td>${PriceCalculator.formatCurrency(netLow)}-${PriceCalculator.formatCurrency(netHigh)} + all the extras above</td>
                    </tr>
                    </tbody>
                `;

                table.innerHTML = html;
            },

            renderChildAgeInputs() {
                const container = document.getElementById('childAgesInline');

                if (AppState.childCount === 0) {
                    container.innerHTML = '';
                    return;
                }

                // Ensure childAges array matches childCount
                while (AppState.childAges.length < AppState.childCount) {
                    AppState.childAges.push(10);
                }

                let html = '';
                for (let i = 0; i < AppState.childCount; i++) {
                    html += `
                        <div class="child-age-card">
                            <span class="child-age-card-label">${t('childAge.child', {n: i + 1})}</span>
                            <div class="child-age-card-row">
                                ${t('childAge.age')} <input type="number" class="child-age-inline-input" data-index="${i}"
                                       min="0" max="20" value="${AppState.childAges[i]}">
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

                // Bind change events
                container.querySelectorAll('.child-age-inline-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.index);
                        let age = parseInt(e.target.value) || 0;
                        if (age < 0) age = 0;
                        if (age > 20) age = 20;
                        e.target.value = age;
                        AppState.childAges[idx] = age;
                        Renderer.updatePrices();
                    });
                });
            },

            // ==================== TAB NAVIGATION ====================
            updateTabBadges() {
                const unbookedCount = AppState.familyGroups.reduce((sum, g) => sum + g.members.length, 0);
                const reservedCount = AppState.reservedGroups.reduce((sum, g) => sum + g.members.length, 0);
                document.getElementById('tabBadgeUnbooked').textContent = unbookedCount;
                document.getElementById('tabBadgeReserved').textContent = reservedCount;
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                document.querySelectorAll('.tab-page').forEach(page => {
                    page.classList.toggle('active', page.id === 'page-' + tabName);
                });
            },

            // ==================== TRACKER PAGE ====================
            renderTracker() {
                this.renderReservedCards();
                this.renderUnbookedPills();
                this.updateProgress();
            },

            renderReservedCards() {
                const grid = document.getElementById('reservedGrid');
                grid.innerHTML = AppState.reservedGroups.map((group, idx) => {
                    const memberNames = group.members.map(m => m.name).join(', ');
                    const color = FAMILY_COLORS[(AppState.familyGroups.length + idx) % FAMILY_COLORS.length];
                    return `<div class="reserved-card" data-cabin-type="${group.cabinType}" style="border-left:4px solid ${color}">
                        <div class="reserved-card-body">
                            <div class="reserved-card-label"><span class="family-color-dot" style="background:${color}"></span>${group.label}</div>
                            <div class="reserved-card-members">${memberNames}</div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">${t('reserved.cabin')}</span>
                                <span class="reserved-detail-value">${t('roomType.' + group.cabinType) || group.cabinType}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">${t('reserved.room')}</span>
                                <span class="reserved-detail-value">#${group.roomNumber}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">${t('reserved.price')}</span>
                                <span class="reserved-detail-value">${PriceCalculator.formatCurrency(group.pricePaid)}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">${t('reserved.deposit')}</span>
                                <span class="reserved-detail-value ${group.depositPaid ? 'deposit-yes' : 'deposit-no'}">${group.depositPaid ? t('reserved.paid') : t('reserved.notPaid')}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            renderUnbookedPills() {
                const container = document.getElementById('unbookedPills');
                container.innerHTML = AppState.familyGroups.map((group, idx) => {
                    const color = FAMILY_COLORS[idx % FAMILY_COLORS.length];
                    const firstName = group.members[0]?.name || group.label;
                    return `<span class="unbooked-pill">
                        <span class="family-color-dot" style="background:${color}"></span>
                        ${group.label}
                        <button class="nudge-btn" data-name="${firstName}" title="${t('nudge.title')}">${t('nudge.btn')}</button>
                    </span>`;
                }).join('');
            },

            updateProgress() {
                const totalGroups = AppState.familyGroups.length + AppState.reservedGroups.length;
                const reserved = AppState.reservedGroups.length;
                const pct = totalGroups > 0 ? Math.round((reserved / totalGroups) * 100) : 0;
                document.getElementById('progressBarFill').style.width = pct + '%';
                document.getElementById('progressCount').textContent = t('tracker.familiesBooked', {reserved, total: totalGroups});
                const remaining = totalGroups - reserved;
                let message = '';
                if (pct === 100) { message = t('tracker.progressFull'); this.triggerConfetti(); }
                else if (pct >= 75) { message = t('tracker.progressAlmost', {count: remaining, familyWord: remaining === 1 ? t('tracker.familySingular') : t('tracker.familyPlural')}); }
                else if (pct >= 50) { message = t('tracker.progressHalf'); }
                else if (pct >= 25) { message = t('tracker.progressQuarter', {count: remaining}); }
                else { message = t('tracker.progressStart', {count: reserved, familyWord: reserved === 1 ? t('tracker.familyHas') : t('tracker.familiesHave')}); }
                document.getElementById('progressMessage').textContent = message;
            },

            // ==================== COUNTDOWNS ====================
            countdownInterval: null,
            startCountdowns() {
                this.updateCountdowns();
                this.countdownInterval = setInterval(() => this.updateCountdowns(), 1000);
            },
            updateCountdowns() {
                const now = new Date();
                this.renderCountdown('cruiseCountdownDigits', CRUISE_DATE, now);
                this.renderCountdown('paymentCountdownDigits', PAYMENT_DATE, now, true);
            },
            renderCountdown(containerId, targetDate, now, isPayment) {
                const container = document.getElementById(containerId);
                const diff = targetDate - now;
                if (diff <= 0 && isPayment) { container.innerHTML = `<div class="countdown-alert">${t('countdown.paymentDue')}</div>`; return; }
                if (diff <= 0) { container.innerHTML = `<div class="countdown-alert">${t('countdown.bonVoyage')}</div>`; return; }
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                let colorClass = 'green';
                if (days < 7) colorClass = 'pulse';
                else if (days < 30) colorClass = 'red';
                else if (days < 90) colorClass = 'yellow';
                container.innerHTML = [
                    { val: days, label: t('countdown.days') }, { val: hours, label: t('countdown.hrs') },
                    { val: minutes, label: t('countdown.min') }, { val: seconds, label: t('countdown.sec') }
                ].map(u => `<div class="countdown-unit">
                    <div class="countdown-number ${colorClass}">${String(u.val).padStart(2, '0')}</div>
                    <div class="countdown-unit-label">${u.label}</div>
                </div>`).join('');
            },

            // ==================== CONFETTI ====================
            triggerConfetti() {
                const canvas = document.getElementById('confettiCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const pieces = [];
                const colors = ['#f97316','#06b6d4','#ec4899','#8b5cf6','#84cc16','#f59e0b','#3b82f6','#22c55e'];
                for (let i = 0; i < 150; i++) {
                    pieces.push({
                        x: Math.random() * canvas.width, y: Math.random() * -canvas.height,
                        w: Math.random() * 10 + 5, h: Math.random() * 6 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        vy: Math.random() * 3 + 2, vx: Math.random() * 2 - 1,
                        rot: Math.random() * 360, rotSpeed: Math.random() * 6 - 3
                    });
                }
                let frame = 0;
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = false;
                    pieces.forEach(p => {
                        p.y += p.vy; p.x += p.vx; p.rot += p.rotSpeed;
                        if (p.y < canvas.height + 20) alive = true;
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                    });
                    frame++;
                    if (alive && frame < 300) requestAnimationFrame(animate);
                    else ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                animate();
            },

            // ==================== EASTER EGG ====================
            shipClickCount: 0,
            initEasterEgg() { this.shipClickCount = 0; },
            handleShipClick() {
                this.shipClickCount++;
                if (this.shipClickCount >= 5) {
                    this.shipClickCount = 0;
                    this.triggerConfetti();
                    const ship = document.querySelector('.ship-icon');
                    if (ship) {
                        ship.style.transition = 'transform 2s ease-in';
                        ship.style.transform = 'scale(5, 2) translateX(60vw)';
                        setTimeout(() => {
                            ship.style.transition = 'none'; ship.style.transform = '';
                            setTimeout(() => { ship.style.transition = ''; }, 50);
                        }, 2200);
                    }
                }
            },

            updateRoomAssignmentUI() {
                const assignmentEl = document.getElementById('roomAssignment');
                if (!AppState.connectingRoomsEnabled) {
                    assignmentEl.classList.remove('visible');
                    return;
                }
                if (AppState.selectedGroups.size >= 3) {
                    assignmentEl.classList.add('visible');
                } else {
                    assignmentEl.classList.remove('visible');
                }
            },

            renderRoomAssignmentChips() {
                const room1Container = document.getElementById('room1Chips');
                const room2Container = document.getElementById('room2Chips');
                const room1CountEl = document.getElementById('room1GuestCount');
                const room2CountEl = document.getElementById('room2GuestCount');

                const renderChips = (groups, targetRoom) => {
                    if (groups.size === 0) {
                        return `<div class="room-empty-msg">${t('roomAssign.clickToMove')}</div>`;
                    }
                    return Array.from(groups).map(label => {
                        const idx = AppState.familyGroups.findIndex(g => g.label === label);
                        const color = FAMILY_COLORS[idx >= 0 ? idx % FAMILY_COLORS.length : 0];
                        const arrow = targetRoom === 1 ? '&#8594;' : '&#8592;';
                        return `<span class="room-group-chip" data-label="${label}" data-from-room="${targetRoom}" style="background:${color}">${label} <span class="chip-arrow">${arrow}</span></span>`;
                    }).join('');
                };

                room1Container.innerHTML = renderChips(AppState.connectingRoom1Groups, 1);
                room2Container.innerHTML = renderChips(AppState.connectingRoom2Groups, 2);

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);
                room1CountEl.textContent = room1Members.length > 0 ? `${room1Members.length} ${room1Members.length !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')}` : '';
                room2CountEl.textContent = room2Members.length > 0 ? `${room2Members.length} ${room2Members.length !== 1 ? t('guest.guestPlural') : t('guest.guestSingular')}` : '';
            },

            bindEvents() {
                // Language toggle
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
                });

                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });

                // Family group buttons
                document.getElementById('familyButtons').addEventListener('click', (e) => {
                    const btn = e.target.closest('.family-btn');
                    if (btn) this.toggleFamilyGroup(btn.dataset.label);
                });

                // Connecting rooms toggle
                document.getElementById('connectingRoomsSwitch').addEventListener('change', (e) => {
                    AppState.connectingRoomsEnabled = e.target.checked;
                    if (e.target.checked) {
                        if (AppState.selectedGroups.size === 2) {
                            AppState.autoAssignConnectingRooms();
                        } else if (AppState.selectedGroups.size >= 3) {
                            // Put all in Room 1 initially, let user assign
                            AppState.connectingRoom1Groups.clear();
                            AppState.connectingRoom2Groups.clear();
                            const labels = AppState.getSelectedGroupLabels();
                            labels.forEach((l, i) => {
                                if (i === 0) AppState.connectingRoom1Groups.add(l);
                                else if (i === 1) AppState.connectingRoom2Groups.add(l);
                                else AppState.connectingRoom1Groups.add(l);
                            });
                        }
                    } else {
                        AppState.connectingRoom1Groups.clear();
                        AppState.connectingRoom2Groups.clear();
                        AppState.connectingOpenBreakdowns.clear();
                    }
                    this.updateRoomAssignmentUI();
                    this.renderRoomAssignmentChips();
                    Renderer.renderConnectingPairsGrid();
                    document.getElementById('connectingPairsSection').classList.toggle('visible', e.target.checked && CONNECTING_PAIRS.length > 0);
                });

                // Room assignment chip clicks (delegation)
                document.getElementById('roomAssignment').addEventListener('click', (e) => {
                    const chip = e.target.closest('.room-group-chip');
                    if (!chip) return;
                    const label = chip.dataset.label;
                    const fromRoom = parseInt(chip.dataset.fromRoom);
                    if (fromRoom === 1) {
                        AppState.connectingRoom1Groups.delete(label);
                        AppState.connectingRoom2Groups.add(label);
                    } else {
                        AppState.connectingRoom2Groups.delete(label);
                        AppState.connectingRoom1Groups.add(label);
                    }
                    this.renderRoomAssignmentChips();
                    Renderer.renderConnectingPairsGrid();
                });

                // Connecting pair card breakdown toggle (delegation)
                document.getElementById('connectingPairsGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-connecting-breakdown')) {
                        const pairId = parseInt(e.target.dataset.pairId);
                        if (AppState.connectingOpenBreakdowns.has(pairId)) {
                            AppState.connectingOpenBreakdowns.delete(pairId);
                        } else {
                            AppState.connectingOpenBreakdowns.add(pairId);
                        }
                        Renderer.renderConnectingPairsGrid();
                    }

                    if (e.target.classList.contains('btn-select-cabin') && e.target.dataset.mode === 'connecting') {
                        const pairId = parseInt(e.target.dataset.pairId);
                        showSelectionModal(pairId, 'connecting');
                    }
                });

                // Easter egg
                document.getElementById('shipNameLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleShipClick();
                });

                // Share buttons
                document.getElementById('copyLinkBtn').addEventListener('click', () => {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        const btn = document.getElementById('copyLinkBtn');
                        btn.textContent = t('tracker.copied');
                        setTimeout(() => { btn.textContent = t('tracker.copyLink'); }, 2000);
                    });
                });

                document.getElementById('whatsappShareBtn').addEventListener('click', () => {
                    const msg = encodeURIComponent(t('whatsapp.msg', {url: window.location.href}));
                    window.open('https://wa.me/?text=' + msg, '_blank');
                });

                // Nudge buttons
                document.getElementById('unbookedPills').addEventListener('click', (e) => {
                    if (e.target.classList.contains('nudge-btn')) {
                        const name = e.target.dataset.name;
                        const msg = encodeURIComponent(t('nudge.msg', {name, url: window.location.href}));
                        window.open('https://wa.me/?text=' + msg, '_blank');
                    }
                });

                // Filter tabs
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        AppState.currentFilter = e.target.dataset.filter;
                        Renderer.renderGrid();
                    });
                });

                // Sort select
                document.getElementById('sortSelect').addEventListener('change', (e) => {
                    AppState.currentSort = e.target.value;
                    Renderer.renderGrid();
                });

                // Package toggles
                document.getElementById('drinkToggle').addEventListener('change', (e) => {
                    AppState.includeDrinks = e.target.checked;
                    this.updateFasPlusAvailability();
                });

                document.getElementById('dinnerToggle').addEventListener('change', (e) => {
                    AppState.includeDinner = e.target.checked;
                    this.updateFasPlusAvailability();
                });

                document.getElementById('tipsToggle').addEventListener('change', (e) => {
                    AppState.tipsBeforeCruise = e.target.checked;
                    document.getElementById('tipsToggleDesc').textContent = e.target.checked
                        ? t('toggle.tipsBefore')
                        : t('toggle.tipsOnboard');
                    Renderer.updatePrices();
                });

                // FAS Plus toggle
                document.getElementById('fasPlusToggle').addEventListener('change', (e) => {
                    if (!AppState.includeDrinks || !AppState.includeDinner) {
                        // Auto-enable drink + dinner when FAS Plus is turned on
                        if (e.target.checked) {
                            AppState.includeDrinks = true;
                            AppState.includeDinner = true;
                            document.getElementById('drinkToggle').checked = true;
                            document.getElementById('dinnerToggle').checked = true;
                        }
                    }
                    AppState.freeAtSeaPlus = e.target.checked;
                    this.updateFasPlusDisplay();
                    Renderer.updatePrices();
                });

                // FAS Plus info button
                document.getElementById('fasPlusInfoBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.populateCostBenefitTable();
                    document.getElementById('fasPlusModal').classList.add('visible');
                });

                document.getElementById('closeFasModal').addEventListener('click', () => {
                    document.getElementById('fasPlusModal').classList.remove('visible');
                });

                document.getElementById('fasPlusModal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('fas-modal-overlay')) {
                        document.getElementById('fasPlusModal').classList.remove('visible');
                    }
                });

                // Deposit option radio buttons
                document.querySelectorAll('input[name="depositOption"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        AppState.depositOption = e.target.value;
                        document.querySelectorAll('.deposit-radio-label').forEach(label => {
                            label.classList.toggle('active', label.dataset.option === e.target.value);
                        });
                        Renderer.updatePrices();
                    });
                });

                // Cabin grid event delegation
                document.getElementById('cabinGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-breakdown')) {
                        if (AppState.selectedGroups.size === 0) {
                            showToast(t('toast.selectGroup'));
                            return;
                        }
                        const id = parseInt(e.target.dataset.id);
                        if (AppState.openBreakdowns.has(id)) {
                            AppState.openBreakdowns.delete(id);
                        } else {
                            AppState.openBreakdowns.add(id);
                        }
                        Renderer.renderGrid();
                    }

                    if (e.target.classList.contains('btn-compare')) {
                        if (AppState.selectedGroups.size === 0) {
                            showToast(t('toast.selectGroup'));
                            return;
                        }
                        const id = parseInt(e.target.dataset.id);
                        if (AppState.selectedCabins.has(id)) {
                            AppState.selectedCabins.delete(id);
                        } else if (AppState.selectedCabins.size < 3) {
                            AppState.selectedCabins.add(id);
                        }
                        Renderer.renderGrid();
                        Renderer.updateComparisonTray();
                    }

                    if (e.target.classList.contains('btn-select-cabin') && e.target.dataset.mode === 'single') {
                        const id = parseInt(e.target.dataset.id);
                        showSelectionModal(id, 'single');
                    }
                });

                // Comparison tray
                document.getElementById('clearComparison').addEventListener('click', () => {
                    AppState.selectedCabins.clear();
                    Renderer.renderGrid();
                    Renderer.updateComparisonTray();
                });

                document.getElementById('compareNow').addEventListener('click', () => {
                    if (AppState.selectedCabins.size > 0) {
                        Renderer.renderComparison();
                        document.getElementById('comparisonModal').classList.add('visible');
                    }
                });

                // Comparison Modal
                document.getElementById('closeModal').addEventListener('click', () => {
                    document.getElementById('comparisonModal').classList.remove('visible');
                });

                document.getElementById('comparisonModal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        document.getElementById('comparisonModal').classList.remove('visible');
                    }
                });

                // Selection modal
                document.getElementById('selectionConfirm').addEventListener('click', () => submitSelection());
                document.getElementById('selectionCancel').addEventListener('click', () => {
                    document.getElementById('selectionModal').classList.remove('visible');
                    selectionPayload = null;
                });
                document.getElementById('selectionModalClose').addEventListener('click', () => {
                    document.getElementById('selectionModal').classList.remove('visible');
                    selectionPayload = null;
                });
                document.getElementById('selectionModal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('selection-modal')) {
                        document.getElementById('selectionModal').classList.remove('visible');
                        selectionPayload = null;
                    }
                });

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.getElementById('comparisonModal').classList.remove('visible');
                        document.getElementById('fasPlusModal').classList.remove('visible');
                        document.getElementById('selectionModal').classList.remove('visible');
                        selectionPayload = null;
                    }
                });

                // Initial stepper state
                this.updateGuestDisplay();
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
