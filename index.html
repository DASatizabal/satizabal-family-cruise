<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satizabal Family Cruise 2026 - Norwegian Joy | Nov 20-23, 2026</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --deep-ocean: #0a2540;
            --ocean-blue: #1e3a5f;
            --teal: #0d9488;
            --teal-light: #14b8a6;
            --gold: #f59e0b;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Room type colors */
            --inside-color: #6b7280;
            --oceanview-color: #0ea5e9;
            --balcony-color: #22c55e;
            --club-balcony-color: #8b5cf6;
            --suite-color: #f59e0b;
            --haven-color: #ec4899;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* Hero Header */
        .hero {
            background: linear-gradient(135deg, var(--deep-ocean) 0%, var(--ocean-blue) 100%);
            color: var(--white);
            padding: 2rem 1rem 6rem;
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .version-badge {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.5;
            letter-spacing: 0.025em;
        }

        .ship-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .ship-name a {
            color: var(--white);
            text-decoration: none;
            transition: color 0.2s;
        }

        .ship-name a:hover {
            color: var(--teal-light);
        }

        .cruise-dates {
            font-size: 1.25rem;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .itinerary-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--teal-light);
            margin-bottom: 1.5rem;
        }

        .itinerary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .itinerary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .itinerary-grid {
                grid-template-columns: 1fr;
            }
        }

        .port-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            backdrop-filter: blur(10px);
        }

        .port-day {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .port-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .port-time {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .validity-banner {
            background: linear-gradient(90deg, var(--gold), #fbbf24);
            color: var(--gray-900);
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.5); }
        }

        .validity-icon {
            font-size: 1.25rem;
        }

        /* Wave Animation */
        .wave-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            overflow: hidden;
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 80'%3E%3Cpath d='M0 20 Q25 8 50 20 Q75 8 100 20 Q125 8 150 20 Q175 8 200 20 L200 35 Q175 23 150 35 Q125 23 100 35 Q75 23 50 35 Q25 23 0 35 Z' fill='%235b9cd9'/%3E%3Cpath d='M0 18 Q25 6 50 18 Q75 6 100 18 Q125 6 150 18 Q175 6 200 18' fill='none' stroke='%2393c5f7' stroke-width='2'/%3E%3Cpath d='M0 35 Q25 23 50 35 Q75 23 100 35 Q125 23 150 35 Q175 23 200 35 L200 50 Q175 38 150 50 Q125 38 100 50 Q75 38 50 50 Q25 38 0 50 Z' fill='%234a8bc9'/%3E%3Cpath d='M0 33 Q25 21 50 33 Q75 21 100 33 Q125 21 150 33 Q175 21 200 33' fill='none' stroke='%237db5e9' stroke-width='2'/%3E%3Cpath d='M0 50 Q25 38 50 50 Q75 38 100 50 Q125 38 150 50 Q175 38 200 50 L200 65 Q175 53 150 65 Q125 53 100 65 Q75 53 50 65 Q25 53 0 65 Z' fill='%233a7ab9'/%3E%3Cpath d='M0 48 Q25 36 50 48 Q75 36 100 48 Q125 36 150 48 Q175 36 200 48' fill='none' stroke='%236aa5d9' stroke-width='2'/%3E%3Cpath d='M0 65 Q25 53 50 65 Q75 53 100 65 Q125 53 150 65 Q175 53 200 65 L200 80 L0 80 Z' fill='%232a69a9'/%3E%3Cpath d='M0 63 Q25 51 50 63 Q75 51 100 63 Q125 51 150 63 Q175 51 200 63' fill='none' stroke='%235795c9' stroke-width='2'/%3E%3C/svg%3E") repeat-x;
            background-size: 200px 100%;
            animation: wave 25s linear infinite;
        }

        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Controls Panel */
        .controls {
            max-width: 1200px;
            margin: 0.5rem auto 2rem;
            padding: 0 1rem;
            position: relative;
            z-index: 10;
        }

        .controls-panel {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-start;
        }

        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex: 1;
        }

        .filter-tab {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 9999px;
            background: var(--white);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-tab:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .filter-tab.active {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--white);
        }

        .filter-tab[data-filter="Inside"].active { background: var(--inside-color); border-color: var(--inside-color); }
        .filter-tab[data-filter="Oceanview"].active { background: var(--oceanview-color); border-color: var(--oceanview-color); }
        .filter-tab[data-filter="Balcony"].active { background: var(--balcony-color); border-color: var(--balcony-color); }
        .filter-tab[data-filter="Club Balcony Suite"].active { background: var(--club-balcony-color); border-color: var(--club-balcony-color); }
        .filter-tab[data-filter="Suite"].active { background: var(--suite-color); border-color: var(--suite-color); }
        .filter-tab[data-filter="The Haven"].active { background: var(--haven-color); border-color: var(--haven-color); }

        .sort-select {
            padding: 0.5rem 2rem 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            background: var(--white);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
        }

        /* Guest Count Section */
        .guest-section {
            display: flex;
            gap: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .guest-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .guest-input-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 0;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .stepper-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gray-50);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray-700);
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stepper-btn:hover:not(:disabled) {
            background: var(--gray-200);
        }

        .stepper-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stepper-value {
            width: 36px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            border-left: 1px solid var(--gray-200);
            border-right: 1px solid var(--gray-200);
            height: 36px;
            line-height: 36px;
        }

        .guest-total {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-500);
            padding-bottom: 0.4rem;
        }

        .package-toggles {
            display: flex;
            gap: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        .toggle-price {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* iOS-style Toggle */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            appearance: none;
            background: var(--gray-300);
            border-radius: 9999px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch:checked {
            background: var(--teal);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .toggle-switch:checked::before {
            transform: translateX(22px);
        }

        /* Cabin Grid */
        .cabin-grid {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem 2rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .cabin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .cabin-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cabin Card */
        .cabin-card {
            background: var(--white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s;
            position: relative;
        }

        .cabin-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }

        .cabin-card.selected {
            outline: 3px solid var(--teal);
            outline-offset: -3px;
        }

        .cabin-card.dimmed {
            opacity: 0.5;
        }

        .cabin-card.dimmed:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .max-guests-note {
            background: var(--gray-100);
            color: var(--gray-500);
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .cabin-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .cabin-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            margin-bottom: 0.75rem;
        }

        .badge-Inside { background: #f3f4f6; color: var(--inside-color); }
        .badge-Oceanview { background: #e0f2fe; color: #0369a1; }
        .badge-Balcony { background: #dcfce7; color: #166534; }
        .badge-Club-Balcony-Suite { background: #ede9fe; color: #6d28d9; }
        .badge-Suite { background: #fef3c7; color: #b45309; }
        .badge-The-Haven { background: #fce7f3; color: #be185d; }

        .cabin-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .cabin-specs {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray-500);
            flex-wrap: wrap;
        }

        .cabin-spec {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .cabin-body {
            padding: 1.25rem;
        }

        .price-display {
            text-align: center;
            margin-bottom: 1rem;
        }

        .price-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-ocean);
        }

        .price-amount.flash {
            animation: price-flash 0.5s ease;
        }

        @keyframes price-flash {
            0%, 100% { color: var(--deep-ocean); }
            50% { color: var(--teal); }
        }

        .price-per-person {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .tips-onboard-note {
            font-size: 0.8rem;
            color: var(--suite-color);
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .deposit-info {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .deposit-label {
            color: var(--gray-600);
        }

        .deposit-amount {
            font-weight: 600;
            color: var(--teal);
        }

        .cabin-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--teal);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--teal-light);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-compare {
            background: var(--white);
            border: 2px solid var(--teal);
            color: var(--teal);
        }

        .btn-compare:hover {
            background: var(--teal);
            color: var(--white);
        }

        .btn-compare.selected {
            background: var(--teal);
            color: var(--white);
        }

        .ncl-link {
            display: block;
            text-align: center;
            padding: 0.75rem;
            color: var(--ocean-blue);
            font-size: 0.875rem;
            text-decoration: none;
            border-top: 1px solid var(--gray-100);
            transition: background 0.2s;
        }

        .ncl-link:hover {
            background: var(--gray-50);
        }

        /* Breakdown */
        .breakdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .breakdown.open {
            max-height: 2000px;
        }

        .breakdown-content {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .breakdown-row:last-child {
            border-bottom: none;
        }

        .breakdown-row.total {
            font-weight: 700;
            font-size: 1rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--gray-300);
            margin-top: 0.5rem;
        }

        .breakdown-label {
            color: var(--gray-600);
        }

        .breakdown-value {
            color: var(--gray-900);
            font-weight: 500;
        }

        .breakdown-section-header {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--ocean-blue);
            padding: 1rem 0 0.5rem;
            margin-top: 0.75rem;
            border-top: 2px dashed var(--gray-300);
        }

        .breakdown-row.tips-onboard {
            background: #fef3c7;
            margin: 0 -1rem;
            padding: 0.5rem 1rem;
            font-style: italic;
        }

        .breakdown-row.tips-onboard .breakdown-label {
            color: var(--suite-color);
        }

        .breakdown-row.tips-onboard .breakdown-value {
            color: var(--suite-color);
        }

        .guest-breakdown-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.825rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .guest-breakdown-row:last-child {
            border-bottom: none;
        }

        .guest-breakdown-label {
            color: var(--gray-700);
            font-weight: 500;
        }

        .guest-breakdown-detail {
            color: var(--gray-500);
            font-size: 0.75rem;
            margin-top: 0.125rem;
        }

        .guest-breakdown-value {
            font-weight: 600;
            color: var(--gray-900);
            white-space: nowrap;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--gray-400);
            font-size: 0.8em;
            font-weight: 400;
            margin-right: 0.35rem;
        }

        .free-tag {
            display: inline-block;
            background: var(--teal);
            color: var(--white);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.25rem;
            vertical-align: middle;
        }

        /* Comparison Tray */
        .comparison-tray {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--deep-ocean);
            color: var(--white);
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
        }

        .comparison-tray.visible {
            transform: translateY(0);
        }

        .tray-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .tray-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tray-count {
            background: var(--teal);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .tray-text {
            font-size: 0.875rem;
        }

        .tray-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-tray {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-compare-now {
            background: var(--teal);
            color: var(--white);
        }

        .btn-compare-now:hover {
            background: var(--teal-light);
        }

        .btn-clear {
            background: transparent;
            color: var(--gray-300);
            border: 1px solid var(--gray-600);
        }

        .btn-clear:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 200;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: translateY(0);
        }

        .modal-header {
            position: sticky;
            top: 0;
            background: var(--white);
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gray-500);
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .comparison-grid {
            display: grid;
            gap: 1rem;
        }

        .comparison-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .comparison-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }

        @media (max-width: 768px) {
            .comparison-grid.cols-2,
            .comparison-grid.cols-3 {
                grid-template-columns: 1fr;
            }
        }

        .comparison-column {
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            overflow: hidden;
        }

        .comparison-cabin-header {
            padding: 1rem;
            background: var(--gray-50);
            text-align: center;
        }

        .comparison-cabin-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-top: 0.5rem;
        }

        .comparison-cabin-body {
            padding: 1rem;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 0.625rem 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-row.highlight {
            background: var(--gray-50);
            margin: 0 -1rem;
            padding: 0.625rem 1rem;
            font-weight: 600;
        }

        .comparison-label {
            color: var(--gray-500);
        }

        .comparison-value {
            font-weight: 500;
            color: var(--gray-900);
        }

        .comparison-total {
            text-align: center;
            padding: 1rem;
            background: var(--deep-ocean);
            color: var(--white);
        }

        .comparison-total-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        .comparison-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Inline Child Age Inputs */
        .child-ages-inline {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .child-age-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }

        .child-age-card-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .child-age-card-row {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .child-age-inline-input {
            width: 50px;
            padding: 0.35rem;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
            font-weight: 600;
            color: var(--gray-900);
        }

        .child-age-inline-input:focus {
            outline: none;
            border-color: var(--teal);
        }

        /* Footer */
        .footer {
            background: var(--deep-ocean);
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .payment-due {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .payment-due-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .payment-due-date {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .footer-note {
            font-size: 0.875rem;
            opacity: 0.7;
            margin-top: 1rem;
        }

        /* No results */
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Running totals display */
        .running-totals {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .running-total-item {
            font-size: 0.875rem;
        }

        .running-total-label {
            color: var(--gray-500);
        }

        .running-total-value {
            font-weight: 600;
            color: var(--teal);
        }

        /* Deposit Options */
        .deposit-options-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .deposit-options-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .deposit-radio-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .deposit-radio-label {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 200px;
        }

        .deposit-radio-label:hover:not(.disabled) {
            border-color: var(--teal);
        }

        .deposit-radio-label.active {
            border-color: var(--teal);
            background: rgba(13, 148, 136, 0.05);
        }

        .deposit-radio-label.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .deposit-radio-label input[type="radio"] {
            margin-top: 0.2rem;
            accent-color: var(--teal);
        }

        .deposit-radio-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .deposit-radio-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .deposit-radio-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Free at Sea Plus */
        .fas-plus-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .fas-plus-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .fas-plus-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .fas-plus-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fas-plus-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .fas-plus-savings {
            font-size: 0.75rem;
            color: var(--teal);
            font-weight: 600;
        }

        .fas-plus-requires {
            font-size: 0.7rem;
            color: var(--suite-color);
            font-weight: 500;
        }

        .fas-plus-info-btn {
            background: none;
            border: 2px solid var(--teal);
            color: var(--teal);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .fas-plus-info-btn:hover {
            background: var(--teal);
            color: var(--white);
        }

        .toggle-switch.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* FAS Plus Info Modal */
        .fas-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fas-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .fas-modal {
            background: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .fas-modal-overlay.visible .fas-modal {
            transform: scale(1);
        }

        .fas-modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fas-modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .fas-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fas-modal-close:hover {
            background: var(--gray-200);
        }

        .fas-modal-body {
            padding: 1.5rem;
        }

        .fas-modal-body p {
            color: var(--gray-600);
            margin-bottom: 1rem;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .cost-benefit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .cost-benefit-table th {
            background: var(--gray-50);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }

        .cost-benefit-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .cost-benefit-table tr.total-row td {
            font-weight: 700;
            border-top: 2px solid var(--gray-300);
            color: var(--gray-900);
        }

        .cost-benefit-table .savings {
            color: var(--teal);
            font-weight: 600;
        }

        .credit-badge {
            display: inline-block;
            background: var(--gold);
            color: var(--gray-900);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.25rem;
            vertical-align: middle;
        }
        /* Dark mode variables */
        body.dark-mode {
            --white: #1a1a2e;
            --gray-50: #16213e;
            --gray-100: #1a1a2e;
            --gray-200: #2a2a4a;
            --gray-300: #3a3a5a;
            --gray-400: #6a6a8a;
            --gray-500: #9a9ab0;
            --gray-600: #b0b0c8;
            --gray-700: #d0d0e0;
            --gray-800: #e8e8f0;
            --gray-900: #f0f0f8;
        }

        body.dark-mode .hero {
            background: linear-gradient(135deg, #050a18 0%, #0a1628 100%);
        }

        body.dark-mode .controls-panel,
        body.dark-mode .cabin-card,
        body.dark-mode .modal,
        body.dark-mode .fas-modal {
            background: #1a1a2e;
        }

        body.dark-mode .comparison-tray {
            background: #050a18;
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            position: absolute;
            top: 0.5rem;
            right: 4rem;
            background: rgba(255,255,255,0.15);
            border: none;
            color: var(--white);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 5;
        }

        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Tab Navigation */
        .tab-nav {
            max-width: 1200px;
            margin: -2.5rem auto 0;
            padding: 0 1rem;
            position: relative;
            z-index: 11;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px 12px 0 0;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.7);
            color: var(--gray-600);
            position: relative;
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.9);
            color: var(--teal);
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--teal);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--teal);
            border-radius: 3px 3px 0 0;
        }

        .tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            padding: 0 6px;
            border-radius: 11px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .tab-badge-unbooked {
            background: var(--gold);
            color: var(--gray-900);
        }

        .tab-badge-reserved {
            background: var(--teal);
            color: white;
        }

        .tab-page {
            display: none;
        }

        .tab-page.active {
            display: block;
        }

        /* Family Group Buttons */
        .family-section {
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            margin-top: 1rem;
        }

        .family-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .family-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .family-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 9999px;
            background: var(--white);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s;
            white-space: nowrap;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .family-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .family-btn.active {
            background: var(--teal);
            border-color: var(--teal);
            color: white;
            transform: scale(1.03);
        }

        .family-btn .member-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .family-btn.active .member-count {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .guest-summary {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .guest-summary-names {
            font-weight: 500;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .guest-summary strong {
            color: var(--teal);
        }

        /* Fit badges on cabin cards */
        .fit-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            z-index: 2;
        }

        .fit-badge.perfect {
            background: var(--teal);
            color: white;
        }

        .fit-badge.good {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        /* Suggestion banner */
        .suggestion-banner {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
        }

        .suggestion-content {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-size: 0.875rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Tracker Page Styles */
        .tracker-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem 3rem;
        }

        /* Countdown Section */
        .countdown-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 640px) {
            .countdown-section {
                grid-template-columns: 1fr;
            }
        }

        .countdown-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }

        .countdown-label {
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .countdown-date {
            font-size: 0.8rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
        }

        .countdown-digits {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
        }

        .countdown-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .countdown-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            color: var(--deep-ocean);
            background: var(--gray-50);
            padding: 0.5rem 0.75rem;
            border-radius: 10px;
            min-width: 60px;
            transition: color 0.5s;
        }

        body.dark-mode .countdown-number {
            color: var(--gray-900);
        }

        .countdown-number.green { color: #16a34a; }
        .countdown-number.yellow { color: #ca8a04; }
        .countdown-number.red { color: #dc2626; }
        .countdown-number.pulse { animation: pulse-red 1s ease-in-out infinite; }

        @keyframes pulse-red {
            0%, 100% { color: #dc2626; }
            50% { color: #fca5a5; }
        }

        .countdown-unit-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--gray-400);
            margin-top: 0.35rem;
            font-weight: 600;
        }

        .countdown-alert {
            background: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            animation: pulse-red-bg 1.5s ease-in-out infinite;
        }

        @keyframes pulse-red-bg {
            0%, 100% { background: #dc2626; }
            50% { background: #ef4444; }
        }

        /* Progress Bar */
        .progress-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
        }

        .progress-bar-track {
            width: 100%;
            height: 24px;
            background: var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal), var(--teal-light));
            border-radius: 12px;
            transition: width 1s ease-out;
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-message {
            font-size: 0.85rem;
            color: var(--gray-500);
            font-style: italic;
        }

        /* Reserved Family Cards */
        .tracker-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .reserved-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .reserved-card {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-top: 4px solid var(--gray-300);
        }

        .reserved-card[data-cabin-type="Inside"] { border-top-color: var(--inside-color); }
        .reserved-card[data-cabin-type="Oceanview"] { border-top-color: var(--oceanview-color); }
        .reserved-card[data-cabin-type="Balcony"] { border-top-color: var(--balcony-color); }
        .reserved-card[data-cabin-type="Club Balcony Suite"] { border-top-color: var(--club-balcony-color); }
        .reserved-card[data-cabin-type="Suite"] { border-top-color: var(--suite-color); }
        .reserved-card[data-cabin-type="The Haven"] { border-top-color: var(--haven-color); }

        .reserved-card-body {
            padding: 1rem;
        }

        .reserved-card-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }

        .reserved-card-members {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .reserved-card-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .reserved-card-detail:last-child {
            border-bottom: none;
        }

        .reserved-detail-label {
            color: var(--gray-500);
        }

        .reserved-detail-value {
            font-weight: 600;
            color: var(--gray-700);
        }

        .deposit-yes {
            color: #16a34a;
        }

        .deposit-no {
            color: #dc2626;
        }

        /* Unbooked Section */
        .unbooked-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .unbooked-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .unbooked-pill {
            padding: 0.4rem 0.8rem;
            background: var(--gray-100);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: var(--gray-500);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nudge-btn {
            background: none;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            cursor: pointer;
            color: var(--gray-500);
            transition: all 0.2s;
        }

        .nudge-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .share-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            min-height: 44px;
        }

        .share-btn-copy {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .share-btn-copy:hover {
            background: var(--gray-200);
        }

        .share-btn-whatsapp {
            background: #25d366;
            color: white;
        }

        .share-btn-whatsapp:hover {
            background: #1da851;
        }

        /* Family color coding */
        .family-color-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.25rem;
        }

        /* Ship bobbing animation on wave */
        .ship-icon {
            position: absolute;
            bottom: 40px;
            left: 15%;
            font-size: 1.5rem;
            z-index: 1;
            animation: bob 3s ease-in-out infinite;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-8px) rotate(2deg); }
        }

        /* Grand total floating summary */
        .grand-total-float {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
            display: none;
        }

        .grand-total-float.visible {
            display: block;
        }

        .grand-total-content {
            background: linear-gradient(135deg, var(--deep-ocean), var(--ocean-blue));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .grand-total-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .grand-total-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ==================== CONNECTING ROOMS ==================== */
        .connecting-rooms-toggle {
            display: none;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(13,148,136,0.08), rgba(30,58,95,0.08));
            border: 1px solid rgba(13,148,136,0.2);
            border-radius: 10px;
        }

        .connecting-rooms-toggle.visible {
            display: flex;
        }

        .connecting-rooms-toggle .toggle-label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .connecting-rooms-toggle .toggle-desc {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .room-assignment {
            display: none;
            gap: 0.75rem;
            margin-top: 0.75rem;
            grid-template-columns: 1fr 1fr;
        }

        .room-assignment.visible {
            display: grid;
        }

        .room-column {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 10px;
            padding: 0.75rem;
            min-height: 80px;
        }

        .room-column-header {
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .room-column-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .room-group-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            color: white;
            transition: all 0.2s;
        }

        .room-group-chip:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .room-group-chip .chip-arrow {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .room-empty-msg {
            font-size: 0.8rem;
            color: var(--gray-400);
            font-style: italic;
            padding: 0.5rem 0;
        }

        .room-guest-count {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.35rem;
        }

        .connecting-pairs-section {
            max-width: 1200px;
            margin: 0 auto 1rem;
            padding: 0 1rem;
            display: none;
        }

        .connecting-pairs-section.visible {
            display: block;
        }

        .connecting-pairs-header {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--gray-800);
        }

        .connecting-pairs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .connecting-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .connecting-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .connecting-card.dimmed {
            opacity: 0.55;
            order: 99;
        }

        .connecting-card-top {
            height: 4px;
            background: linear-gradient(90deg, var(--teal), var(--ocean-blue));
        }

        .connecting-card-body {
            padding: 1rem;
        }

        .connecting-card-label {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .connecting-link-icon {
            font-size: 0.8rem;
            color: var(--teal);
        }

        .connecting-room-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .connecting-room-info {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
        }

        .connecting-room-info-header {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .connecting-room-type-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.25rem;
        }

        .connecting-room-specs {
            font-size: 0.75rem;
            color: var(--gray-500);
            line-height: 1.4;
        }

        .connecting-room-guests {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
            font-weight: 500;
        }

        .connecting-room-subtotal {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.35rem;
        }

        .connecting-combined {
            border-top: 2px solid var(--gray-200);
            padding-top: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connecting-combined-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .connecting-combined-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--deep-ocean);
        }

        .connecting-combined-deposit {
            font-size: 0.8rem;
            color: var(--gray-500);
            text-align: right;
        }

        .connecting-card-actions {
            margin-top: 0.75rem;
        }

        .connecting-card .max-guests-note {
            font-size: 0.75rem;
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .connecting-breakdown {
            display: none;
            margin-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 0.75rem;
        }

        .connecting-breakdown.open {
            display: block;
        }

        .connecting-breakdown-room-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--ocean-blue);
            margin: 0.5rem 0 0.25rem;
        }

        /* Dark mode overrides for connecting rooms */
        .dark-mode .connecting-rooms-toggle {
            background: linear-gradient(135deg, rgba(13,148,136,0.15), rgba(30,58,95,0.15));
            border-color: rgba(13,148,136,0.3);
        }

        .dark-mode .room-column {
            background: var(--gray-800);
            border-color: var(--gray-600);
        }

        .dark-mode .connecting-card {
            background: var(--gray-800);
            border-color: var(--gray-700);
        }

        .dark-mode .connecting-room-info {
            background: var(--gray-700);
        }

        .dark-mode .connecting-combined-total {
            color: var(--teal-light);
        }

        .dark-mode .connecting-pairs-header {
            color: var(--gray-200);
        }

        @media (max-width: 600px) {
            .room-assignment {
                grid-template-columns: 1fr;
            }
            .connecting-room-row {
                grid-template-columns: 1fr;
            }
            .connecting-pairs-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Hero Header -->
    <header class="hero">
        <div class="hero-content">
            <span class="version-badge">v1.1.0</span>
            <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle dark mode">&#9790;</button>
            <h1 class="ship-name">
                <a href="https://www.ncl.com/cruise-ships/norwegian-joy" target="_blank" rel="noopener" id="shipNameLink">Norwegian Joy</a>
            </h1>
            <p class="cruise-dates">Satizabal Family Cruise &middot; Fri, Nov 20 - Mon, Nov 23, 2026</p>
            <p class="itinerary-title">3-Day Bahamas Round-trip Miami: Great Stirrup Cay &amp; Nassau</p>

            <div class="itinerary-grid">
                <div class="port-card">
                    <div class="port-day">Friday</div>
                    <div class="port-name">Miami, Florida</div>
                    <div class="port-time">Embark 4:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day">Saturday</div>
                    <div class="port-name">Nassau, Bahamas</div>
                    <div class="port-time">7:00 AM - 5:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day">Sunday</div>
                    <div class="port-name">Great Stirrup Cay</div>
                    <div class="port-time">7:00 AM - 5:00 PM</div>
                </div>
                <div class="port-card">
                    <div class="port-day">Monday</div>
                    <div class="port-name">Miami, Florida</div>
                    <div class="port-time">Debark 7:00 AM</div>
                </div>
            </div>

            <div class="validity-banner">
                <span class="validity-icon">&#9888;</span>
                <span>Prices valid as of <strong>February 1, 2026</strong></span>
            </div>
        </div>

        <div class="wave-container">
            <span class="ship-icon">&#9972;</span>
            <div class="wave"></div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="selector">Cabin Selector <span class="tab-badge tab-badge-unbooked" id="tabBadgeUnbooked">0</span></button>
        <button class="tab-btn" data-tab="tracker">Reservation Tracker <span class="tab-badge tab-badge-reserved" id="tabBadgeReserved">0</span></button>
    </nav>

    <!-- Page: Selector -->
    <div class="tab-page active" id="page-selector">

    <!-- Controls Panel -->
    <section class="controls">
        <div class="controls-panel">
            <div class="controls-row">
                <div class="filter-tabs">
                    <button class="filter-tab active" data-filter="All">All</button>
                    <button class="filter-tab" data-filter="Inside">Inside</button>
                    <button class="filter-tab" data-filter="Oceanview">Oceanview</button>
                    <button class="filter-tab" data-filter="Balcony">Balcony</button>
                    <button class="filter-tab" data-filter="Club Balcony Suite">Club Balcony</button>
                    <button class="filter-tab" data-filter="Suite">Suite</button>
                    <button class="filter-tab" data-filter="The Haven">The Haven</button>
                </div>

                <select class="sort-select" id="sortSelect">
                    <option value="price-asc">Price: Low to High</option>
                    <option value="price-desc">Price: High to Low</option>
                    <option value="sqft-desc">Sq Ft: Large to Small</option>
                    <option value="sqft-asc">Sq Ft: Small to Large</option>
                </select>
            </div>

            <!-- Family Group Selection -->
            <div class="family-section" id="familySection">
                <div class="family-section-title">Select your travel group</div>
                <div class="family-buttons" id="familyButtons"></div>
                <div class="guest-summary" id="guestSummary" style="display:none;">
                    <div id="guestSummaryText"></div>
                    <div class="guest-summary-names" id="guestSummaryNames"></div>
                </div>

                <!-- Connecting Rooms Toggle -->
                <div class="connecting-rooms-toggle" id="connectingRoomsToggle">
                    <input type="checkbox" class="toggle-switch" id="connectingRoomsSwitch">
                    <div>
                        <div class="toggle-label">Connecting Rooms</div>
                        <div class="toggle-desc">Price two adjacent cabins with a shared door</div>
                    </div>
                </div>

                <!-- Room Assignment UI (for 3+ groups) -->
                <div class="room-assignment" id="roomAssignment">
                    <div class="room-column" id="room1Column">
                        <div class="room-column-header">Room 1</div>
                        <div class="room-column-chips" id="room1Chips"></div>
                        <div class="room-guest-count" id="room1GuestCount"></div>
                    </div>
                    <div class="room-column" id="room2Column">
                        <div class="room-column-header">Room 2</div>
                        <div class="room-column-chips" id="room2Chips"></div>
                        <div class="room-guest-count" id="room2GuestCount"></div>
                    </div>
                </div>
            </div>

            <div class="guest-section">
                <div class="guest-input-group">
                    <label class="guest-input-label">Adults (21+)</label>
                    <div class="stepper" style="opacity:0.6; pointer-events:none;">
                        <button class="stepper-btn" id="adultDec" disabled>-</button>
                        <div class="stepper-value" id="adultCount">0</div>
                        <button class="stepper-btn" id="adultInc" disabled>+</button>
                    </div>
                </div>
                <div class="guest-input-group">
                    <label class="guest-input-label">Children (0-20)</label>
                    <div class="stepper" style="opacity:0.6; pointer-events:none;">
                        <button class="stepper-btn" id="childDec" disabled>-</button>
                        <div class="stepper-value" id="childCount">0</div>
                        <button class="stepper-btn" id="childInc" disabled>+</button>
                    </div>
                </div>
                <div class="guest-total" id="guestTotal">Select a family group above</div>
                <div class="child-ages-inline" id="childAgesInline"></div>
            </div>

            <div class="package-toggles">
                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="drinkToggle">
                    <div>
                        <div class="toggle-label">Drink Package</div>
                        <div class="toggle-price" id="drinkToggleDesc">+$171 (2 adults x $85.50)</div>
                    </div>
                </div>

                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="dinnerToggle">
                    <div>
                        <div class="toggle-label">Dinner Package</div>
                        <div class="toggle-price" id="dinnerToggleDesc">+$40 (2 guests x $20)</div>
                    </div>
                </div>

                <div class="toggle-container">
                    <input type="checkbox" class="toggle-switch" id="tipsToggle" checked>
                    <div>
                        <div class="toggle-label">When to Pay Tips</div>
                        <div class="toggle-price" id="tipsToggleDesc">Before cruise (by 7/23/2026)</div>
                    </div>
                </div>
            </div>

            <!-- Free at Sea Plus -->
            <div class="fas-plus-section" id="fasPlusSection">
                <div class="fas-plus-toggle">
                    <input type="checkbox" class="toggle-switch" id="fasPlusToggle">
                    <div class="fas-plus-info">
                        <div class="fas-plus-title">
                            Free at Sea Plus
                            <button class="fas-plus-info-btn" id="fasPlusInfoBtn" title="What's included?">?</button>
                        </div>
                        <div class="fas-plus-desc" id="fasPlusDesc">+$300 (2 guests x $150) &mdash; Includes prepaid gratuities</div>
                        <div class="fas-plus-requires" id="fasPlusRequires" style="display: none;">Enabling will auto-select Drink &amp; Dinner packages if not already selected</div>
                        <div class="fas-plus-savings" id="fasPlusSavings" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Deposit Options -->
            <div class="deposit-options-section" id="depositOptionsSection">
                <div class="deposit-options-title">Deposit Option</div>
                <div class="deposit-radio-group" id="depositRadioGroup">
                    <label class="deposit-radio-label active" data-option="regular">
                        <input type="radio" name="depositOption" value="regular" checked>
                        <div class="deposit-radio-info">
                            <span class="deposit-radio-name">Regular Deposit</span>
                            <span class="deposit-radio-desc">Suite/Haven: 10% of fare | Others: $100</span>
                        </div>
                    </label>
                    <label class="deposit-radio-label" data-option="credit150">
                        <input type="radio" name="depositOption" value="credit150">
                        <div class="deposit-radio-info">
                            <span class="deposit-radio-name">$150 Credit Deposit</span>
                            <span class="deposit-radio-desc">Pay $150 deposit, receive $150 credit toward your cruise</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="running-totals" id="runningTotals" style="display: none;">
                <div class="running-total-item">
                    <span class="running-total-label">Package additions: </span>
                    <span class="running-total-value" id="packageTotal">$0</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Suggestion Banner -->
    <div class="suggestion-banner" id="suggestionBanner" style="display:none;">
        <div class="suggestion-content">
            <span class="suggestion-icon">&#128161;</span>
            <span id="suggestionText"></span>
        </div>
    </div>

    <!-- Grand Total Float -->
    <div class="grand-total-float" id="grandTotalFloat">
        <div class="grand-total-content">
            <span class="grand-total-label" id="grandTotalLabel"></span>
            <span class="grand-total-amount" id="grandTotalAmount"></span>
        </div>
    </div>

    <!-- Connecting Room Pairs -->
    <div class="connecting-pairs-section" id="connectingPairsSection">
        <div class="connecting-pairs-header">Connecting Room Options</div>
        <div class="connecting-pairs-grid" id="connectingPairsGrid"></div>
    </div>

    <!-- Cabin Grid -->
    <main class="cabin-grid" id="cabinGrid">
        <!-- Cabins will be rendered here -->
    </main>

    </div><!-- /page-selector -->

    <!-- Comparison Tray (outside pages so it's always accessible) -->
    <div class="comparison-tray" id="comparisonTray">
        <div class="tray-content">
            <div class="tray-info">
                <div class="tray-count" id="trayCount">0</div>
                <div class="tray-text">cabins selected for comparison (max 3)</div>
            </div>
            <div class="tray-actions">
                <button class="btn-tray btn-clear" id="clearComparison">Clear All</button>
                <button class="btn-tray btn-compare-now" id="compareNow">Compare Now</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal-overlay" id="comparisonModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Side-by-Side Comparison</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="comparison-grid" id="comparisonGrid"></div>
            </div>
        </div>
    </div>

    <!-- FAS Plus Info Modal -->
    <div class="fas-modal-overlay" id="fasPlusModal">
        <div class="fas-modal">
            <div class="fas-modal-header">
                <h3 class="fas-modal-title">Free at Sea Plus &mdash; Cost/Benefit Analysis</h3>
                <button class="fas-modal-close" id="closeFasModal">&times;</button>
            </div>
            <div class="fas-modal-body">
                <p>
                    Free at Sea Plus is an upgrade package that adds premium perks on top of the standard
                    Free at Sea benefits. It costs <strong>$49.99/person/day</strong>, totaling approximately
                    <strong>$300 for a 3-day cruise (2 guests)</strong>.
                </p>
                <p style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; font-size: 0.8rem;">
                    Free at Sea Plus applies ONLY to Guests 1 &amp; 2.
                </p>
                <table class="cost-benefit-table" id="costBenefitTable"></table>
                <p style="margin-top: 1.5rem; font-size: 0.8rem;">
                    <strong>Resources:</strong><br>
                    <a href="https://www.ncl.com/content/dam/ncl/us/en/promo/cruise-deals/Free_at_sea_Plus_ver_11042025.pdf" target="_blank" rel="noopener" style="color: var(--teal);">Free at Sea Plus Comparison (PDF)</a><br>
                    <a href="https://www.ncl.com/faq/what-is-included-in-free-at-sea-plus-and-how-much-does-it-cost-" target="_blank" rel="noopener" style="color: var(--teal);">What is included in Free at Sea Plus? (NCL FAQ)</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Page: Tracker -->
    <div class="tab-page" id="page-tracker">
        <div class="tracker-container">
            <div class="countdown-section" id="countdownSection">
                <div class="countdown-card" id="cruiseCountdown">
                    <div class="countdown-label">Cruise Day</div>
                    <div class="countdown-date">November 20, 2026</div>
                    <div class="countdown-digits" id="cruiseCountdownDigits"></div>
                </div>
                <div class="countdown-card" id="paymentCountdown">
                    <div class="countdown-label">Final Payment</div>
                    <div class="countdown-date">July 23, 2026</div>
                    <div class="countdown-digits" id="paymentCountdownDigits"></div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-title">Reunion Progress</div>
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progressBarFill" style="width:0%"></div>
                </div>
                <div class="progress-stats">
                    <span class="progress-count" id="progressCount">0/0 families booked</span>
                    <span class="progress-message" id="progressMessage"></span>
                </div>
            </div>

            <h3 class="tracker-section-title">Reserved Families</h3>
            <div class="reserved-grid" id="reservedGrid"></div>

            <div class="unbooked-section">
                <h3 class="tracker-section-title" style="border:none;margin:0 0 0.75rem;padding:0;">Still Deciding</h3>
                <div class="unbooked-pills" id="unbookedPills"></div>
                <p style="font-size:0.85rem;color:var(--gray-500);margin-bottom:1rem;">Share this page to help them pick a cabin!</p>
                <div class="share-actions">
                    <button class="share-btn share-btn-copy" id="copyLinkBtn">Copy Link</button>
                    <button class="share-btn share-btn-whatsapp" id="whatsappShareBtn">Share via WhatsApp</button>
                </div>
            </div>
        </div>
    </div><!-- /page-tracker -->

    <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="payment-due">
                <div class="payment-due-label">Final Payment Due</div>
                <div class="payment-due-date">July 23, 2026</div>
            </div>
            <p class="footer-note">Satizabal Family Cruise 2026 &middot; Deposits are refundable if canceled by July 23, 2026</p>
        </div>
    </footer>

    <script>
        // ==================== CABIN DATA (loaded from CSV) ====================
        let CABIN_DATA = [];
        let CONNECTING_PAIRS = [];

        const CRUISE_NIGHTS = 3;
        const TAX_PER_PERSON = 150;
        const EXTRA_GUEST_FARE = 438;
        const PROMO_DISCOUNT = 0.50;
        const FREE_GUEST_POSITIONS = [3, 4];

        const CRUISE_DATE = new Date('2026-11-20T16:00:00');
        const PAYMENT_DATE = new Date('2026-07-23T23:59:59');

        const FAMILY_COLORS = [
            '#f97316', '#06b6d4', '#ec4899', '#8b5cf6',
            '#84cc16', '#f59e0b', '#3b82f6', '#ef4444',
            '#14b8a6', '#a855f7', '#f43f5e', '#22c55e'
        ];

        // CSV Parser for new format
        const CSVParser = {
            async load(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load CSV');
                    const text = await response.text();
                    return this.parse(text);
                } catch (error) {
                    console.error('Error loading CSV:', error);
                    return [];
                }
            },

            parse(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                const cabins = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);

                    if (!values[0] || !values[1] || !values[2]) continue;

                    const cabin = {
                        id: i,
                        roomType: values[0].trim(),
                        name: values[1].trim(),
                        basePrice: parseFloat(values[2]) || 0,
                        maxGuests: parseInt(values[3]) || 2,
                        sqft: values[4] ? values[4].trim() : '',
                        balconySqft: values[5] ? values[5].trim() : null
                    };

                    if (cabin.balconySqft === 'N/A' || cabin.balconySqft === '') {
                        cabin.balconySqft = null;
                    }

                    // Determine if solo cabin
                    cabin.isSolo = cabin.maxGuests === 1;

                    cabins.push(cabin);
                }

                return cabins;
            },

            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);
                return values;
            }
        };

        // ==================== FAMILY CSV PARSER ====================
        const FamilyCSVParser = {
            async load(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to load family CSV');
                    const text = await response.text();
                    return this.parse(text);
                } catch (error) {
                    console.error('Error loading family CSV:', error);
                    return { unbookedGroups: [], reservedGroups: [] };
                }
            },

            parse(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return { unbookedGroups: [], reservedGroups: [] };

                const unbookedMap = new Map();
                const reservedMap = new Map();

                for (let i = 1; i < lines.length; i++) {
                    const values = CSVParser.parseCSVLine(lines[i]);
                    if (!values[0] || !values[1]) continue;

                    const label = values[0].trim();
                    const name = values[1].trim();
                    const age = parseInt(values[2]) || 0;
                    const status = (values[3] || '').trim().toLowerCase();
                    const cabinType = (values[4] || '').trim();
                    const roomNumber = (values[5] || '').trim();
                    const pricePaid = parseFloat(values[6]) || 0;
                    const depositPaid = (values[7] || '').trim().toLowerCase() === 'yes';

                    const member = { name, age };

                    if (status === 'reserved') {
                        if (!reservedMap.has(label)) {
                            reservedMap.set(label, {
                                label, members: [], cabinType, roomNumber, pricePaid, depositPaid
                            });
                        }
                        const group = reservedMap.get(label);
                        group.members.push(member);
                        if (pricePaid > 0) group.pricePaid = pricePaid;
                        if (depositPaid) group.depositPaid = true;
                    } else {
                        if (!unbookedMap.has(label)) {
                            unbookedMap.set(label, { label, members: [] });
                        }
                        unbookedMap.get(label).members.push(member);
                    }
                }

                return {
                    unbookedGroups: Array.from(unbookedMap.values()),
                    reservedGroups: Array.from(reservedMap.values())
                };
            }
        };

        // ==================== CONNECTING ROOMS PARSER ====================
        const ConnectingRoomsParser = {
            async load(connectingUrl, codeMapUrl) {
                try {
                    const [connectingResp, codeMapResp] = await Promise.all([
                        fetch(connectingUrl),
                        fetch(codeMapUrl)
                    ]);
                    if (!connectingResp.ok || !codeMapResp.ok) throw new Error('Failed to load connecting rooms CSV');
                    const connectingText = await connectingResp.text();
                    const codeMapText = await codeMapResp.text();
                    return this.parse(connectingText, codeMapText);
                } catch (error) {
                    console.error('Error loading connecting rooms:', error);
                    return [];
                }
            },

            parse(connectingText, codeMapText) {
                // Build code-to-category map
                const codeToCategory = new Map();
                const codeMapLines = codeMapText.trim().split('\n');
                for (let i = 1; i < codeMapLines.length; i++) {
                    const vals = CSVParser.parseCSVLine(codeMapLines[i]);
                    if (vals[0] && vals[1]) {
                        codeToCategory.set(vals[0].trim(), vals[1].trim()); // code -> cabin type (e.g. "Balcony")
                    }
                }

                // Parse connecting pairs and deduplicate by cabin type pair
                const seen = new Map();
                const lines = connectingText.trim().split('\n');
                for (let i = 1; i < lines.length; i++) {
                    const vals = CSVParser.parseCSVLine(lines[i]);
                    if (!vals[0] || !vals[1]) continue;
                    const code1 = vals[0].trim();
                    const code2 = vals[1].trim();
                    const type1 = codeToCategory.get(code1);
                    const type2 = codeToCategory.get(code2);
                    if (!type1 || !type2) continue;

                    // Canonical key: sorted types
                    const key = [type1, type2].sort().join('|');
                    if (seen.has(key)) continue;
                    seen.set(key, { type1, type2 });
                }

                // Build pair objects from CABIN_DATA
                const pairs = [];
                let id = 1;
                for (const [key, { type1, type2 }] of seen) {
                    const cabin1 = CABIN_DATA.find(c => c.roomType === type1 && !c.isSolo);
                    const cabin2 = CABIN_DATA.find(c => c.roomType === type2 && !c.isSolo);
                    if (!cabin1 || !cabin2) continue;

                    const isSameType = type1 === type2;
                    const label = isSameType
                        ? `${type1} + ${type2}`
                        : `${type1} + ${type2}`;

                    pairs.push({
                        id: id++,
                        label,
                        room1Cabin: cabin1,
                        room2Cabin: cabin2,
                        isSameType
                    });
                }

                return pairs;
            }
        };

        const NCL_LINKS = {
            "Inside": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=INSIDE",
            "Oceanview": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=OCEANVIEW",
            "Balcony": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=BALCONY",
            "Club Balcony Suite": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=CLUB_BALCONY_SUITE",
            "Suite": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=SUITE",
            "The Haven": "https://www.ncl.com/cruise-ships/norwegian-joy/staterooms/options#filter=HAVEN"
        };

        // ==================== PRICE CALCULATOR ====================
        const PriceCalculator = {
            getTipPerPersonPerDay(roomType) {
                if (roomType === 'The Haven' || roomType === 'Suite') return 25;
                return 20;
            },

            getTipPerPerson(roomType) {
                return this.getTipPerPersonPerDay(roomType) * CRUISE_NIGHTS;
            },

            /**
             * Build guest list with positions.
             * Adults fill first, then children sorted by age descending.
             */
            buildGuestList() {
                const members = AppState.getSelectedMembers();
                const adults = members.filter(m => m.age >= 21).map(m => ({ type: 'adult', age: m.age, label: m.name, name: m.name }));
                const children = members.filter(m => m.age < 21).sort((a, b) => b.age - a.age).map(m => ({ type: 'child', age: m.age, label: `${m.name} (${m.age})`, name: m.name }));
                const guests = [...adults, ...children];
                if (guests.length === 0) {
                    for (let i = 0; i < AppState.adultCount; i++) {
                        guests.push({ type: 'adult', age: 21, label: 'Adult', name: 'Adult' });
                    }
                    const sortedAges = [...AppState.childAges].sort((a, b) => b - a);
                    for (const age of sortedAges) {
                        guests.push({ type: 'child', age, label: `Age ${age}`, name: `Child (${age})` });
                    }
                }
                return guests;
            },

            calculate(cabin, includeDrinks, includeDinner, tipsBeforeCruise) {
                const totalGuests = AppState.adultCount + AppState.childCount;
                const effectiveGuests = cabin.isSolo ? 1 : Math.min(totalGuests, cabin.maxGuests);
                const exceedsMax = totalGuests > cabin.maxGuests;

                // Build guest list (capped at cabin max)
                const allGuests = this.buildGuestList();
                const guests = allGuests.slice(0, effectiveGuests);

                // Base fare (with 50% off promo + 3rd/4th guest free)
                const discountedBase = cabin.basePrice * (1 - PROMO_DISCOUNT);
                const discountedExtra = EXTRA_GUEST_FARE * (1 - PROMO_DISCOUNT);
                let totalFare;
                if (cabin.isSolo) {
                    totalFare = discountedBase;
                } else {
                    // Count how many extra guests (position 3+) actually pay
                    let paidExtras = 0;
                    for (let p = 3; p <= effectiveGuests; p++) {
                        if (!FREE_GUEST_POSITIONS.includes(p)) paidExtras++;
                    }
                    totalFare = discountedBase + paidExtras * discountedExtra;
                }

                const tipPerPerson = this.getTipPerPerson(cabin.roomType);
                const isHighTier = cabin.roomType === "Suite" || cabin.roomType === "The Haven";

                // Per-guest calculations
                const guestDetails = guests.map((guest, idx) => {
                    const position = idx + 1; // 1-indexed

                    // Fare: 50% off promo + 3rd/4th guest free
                    let fare, originalFare, discountedFareBeforeFree;
                    const isFreeGuest = FREE_GUEST_POSITIONS.includes(position);
                    if (cabin.isSolo) {
                        fare = discountedBase;
                        originalFare = cabin.basePrice;
                        discountedFareBeforeFree = discountedBase;
                    } else if (effectiveGuests === 1) {
                        fare = discountedBase;
                        originalFare = cabin.basePrice;
                        discountedFareBeforeFree = discountedBase;
                    } else if (position <= 2) {
                        fare = discountedBase / 2;
                        originalFare = cabin.basePrice / 2;
                        discountedFareBeforeFree = discountedBase / 2;
                    } else if (isFreeGuest) {
                        fare = 0;
                        originalFare = EXTRA_GUEST_FARE;
                        discountedFareBeforeFree = discountedExtra;
                    } else {
                        fare = discountedExtra;
                        originalFare = EXTRA_GUEST_FARE;
                        discountedFareBeforeFree = discountedExtra;
                    }

                    const tax = TAX_PER_PERSON;

                    // Tips: guests aged 3+ pay (FAS Plus covers guests 1&2)
                    const tipEligible = guest.age >= 3;
                    let tip = tipEligible ? tipPerPerson : 0;
                    let fasPlusFee = 0;

                    if (AppState.freeAtSeaPlus && position <= 2) {
                        fasPlusFee = 150;
                        tip = 0; // Tips included in FAS Plus
                    }

                    // Drink package
                    let drink = 0;
                    if (includeDrinks) {
                        if (guest.age >= 21) {
                            drink = 85.50;
                        } else if (position <= 2) {
                            drink = 37.50; // juice/soda substitute
                        }
                        // position 3+ and under 21: $0
                    }

                    // Dinner package: only first 2 guests
                    let dinner = 0;
                    if (includeDinner && position <= 2) {
                        if (guest.age >= 13) {
                            dinner = 20;
                        }
                        // under 13 in position 1-2: free (kids' menu)
                    }

                    const tipPreCruise = tipsBeforeCruise ? tip : 0;
                    const tipOnboard = tipsBeforeCruise ? 0 : tip;

                    const guestTotal = fare + tax + tipPreCruise + drink + dinner + fasPlusFee;
                    const guestFullCost = fare + tax + tip + drink + dinner + fasPlusFee;

                    return {
                        position,
                        guest,
                        fare,
                        originalFare,
                        discountedFareBeforeFree,
                        isFreeGuest,
                        tax,
                        tip,
                        tipPreCruise,
                        tipOnboard,
                        drink,
                        dinner,
                        fasPlusFee,
                        total: guestTotal,
                        fullCost: guestFullCost
                    };
                });

                const taxes = guestDetails.reduce((sum, g) => sum + g.tax, 0);
                const tips = guestDetails.reduce((sum, g) => sum + g.tip, 0);
                const tipsPreCruise = tipsBeforeCruise ? tips : 0;
                const tipsOnboard = tipsBeforeCruise ? 0 : tips;
                const drinks = guestDetails.reduce((sum, g) => sum + g.drink, 0);
                const dinner = guestDetails.reduce((sum, g) => sum + g.dinner, 0);
                const fasPlusCost = guestDetails.reduce((sum, g) => sum + g.fasPlusFee, 0);

                // Deposit credit reduces what you owe
                let depositCredit = 0;
                if (AppState.depositOption === 'credit150') {
                    depositCredit = 150;
                }

                const grandTotalBeforeCredit = totalFare + taxes + tipsPreCruise + drinks + dinner + fasPlusCost;
                const grandTotal = grandTotalBeforeCredit - depositCredit;
                const fullTripCost = totalFare + taxes + tips + drinks + dinner + fasPlusCost - depositCredit;

                // Original (undiscounted) totals for strikethrough display
                const originalTotalFare = cabin.isSolo
                    ? cabin.basePrice
                    : cabin.basePrice + Math.max(0, effectiveGuests - 2) * EXTRA_GUEST_FARE;
                // 50% off but without free guest promo (intermediate strikethrough)
                const discountedTotalFare = cabin.isSolo
                    ? discountedBase
                    : discountedBase + Math.max(0, effectiveGuests - 2) * discountedExtra;
                const originalPerPersonAvg = effectiveGuests > 0 ? originalTotalFare / effectiveGuests : 0;

                // Deposit (based on discounted fare) - credit does not change the deposit amount
                const deposit = isHighTier ? Math.round(totalFare * 0.10) : 100;
                const balance = grandTotal - deposit;

                // Per-person average
                const perPersonAvg = effectiveGuests > 0 ? grandTotal / effectiveGuests : 0;
                const allSameCost = guestDetails.length > 1
                    ? guestDetails.every(g => Math.abs(g.total - guestDetails[0].total) < 0.01)
                    : true;

                return {
                    totalFare,
                    originalTotalFare,
                    discountedTotalFare,
                    originalPerPersonAvg,
                    taxes,
                    tips,
                    tipsPreCruise,
                    tipsOnboard,
                    drinks,
                    dinner,
                    fasPlusCost,
                    depositCredit,
                    grandTotalBeforeCredit,
                    grandTotal,
                    fullTripCost,
                    deposit,
                    balance,
                    perPersonAvg,
                    allSameCost,
                    effectiveGuests,
                    exceedsMax,
                    guestDetails,
                    tipsBeforeCruise,
                    isHighTier
                };
            },

            buildGuestListFromMembers(members) {
                const adults = members.filter(m => m.age >= 21).map(m => ({ type: 'adult', age: m.age, label: m.name, name: m.name }));
                const children = members.filter(m => m.age < 21).sort((a, b) => b.age - a.age).map(m => ({ type: 'child', age: m.age, label: `${m.name} (${m.age})`, name: m.name }));
                return [...adults, ...children];
            },

            calculateForMembers(cabin, members, includeDrinks, includeDinner, tipsBeforeCruise) {
                const totalGuests = members.length;
                if (totalGuests === 0) {
                    return {
                        totalFare: 0, originalTotalFare: 0, discountedTotalFare: 0, originalPerPersonAvg: 0,
                        taxes: 0, tips: 0, tipsPreCruise: 0, tipsOnboard: 0, drinks: 0, dinner: 0, fasPlusCost: 0,
                        depositCredit: 0, grandTotalBeforeCredit: 0, grandTotal: 0, fullTripCost: 0,
                        deposit: 0, balance: 0, perPersonAvg: 0, allSameCost: true, effectiveGuests: 0, exceedsMax: false,
                        guestDetails: [], tipsBeforeCruise, isHighTier: false
                    };
                }
                const effectiveGuests = cabin.isSolo ? 1 : Math.min(totalGuests, cabin.maxGuests);
                const exceedsMax = totalGuests > cabin.maxGuests;

                const allGuests = this.buildGuestListFromMembers(members);
                const guests = allGuests.slice(0, effectiveGuests);

                const discountedBase = cabin.basePrice * (1 - PROMO_DISCOUNT);
                const discountedExtra = EXTRA_GUEST_FARE * (1 - PROMO_DISCOUNT);
                let totalFare;
                if (cabin.isSolo) {
                    totalFare = discountedBase;
                } else {
                    let paidExtras = 0;
                    for (let p = 3; p <= effectiveGuests; p++) {
                        if (!FREE_GUEST_POSITIONS.includes(p)) paidExtras++;
                    }
                    totalFare = discountedBase + paidExtras * discountedExtra;
                }

                const tipPerPerson = this.getTipPerPerson(cabin.roomType);
                const isHighTier = cabin.roomType === "Suite" || cabin.roomType === "The Haven";

                const guestDetails = guests.map((guest, idx) => {
                    const position = idx + 1;
                    let fare, originalFare, discountedFareBeforeFree;
                    const isFreeGuest = FREE_GUEST_POSITIONS.includes(position);
                    if (cabin.isSolo) {
                        fare = discountedBase; originalFare = cabin.basePrice; discountedFareBeforeFree = discountedBase;
                    } else if (effectiveGuests === 1) {
                        fare = discountedBase; originalFare = cabin.basePrice; discountedFareBeforeFree = discountedBase;
                    } else if (position <= 2) {
                        fare = discountedBase / 2; originalFare = cabin.basePrice / 2; discountedFareBeforeFree = discountedBase / 2;
                    } else if (isFreeGuest) {
                        fare = 0; originalFare = EXTRA_GUEST_FARE; discountedFareBeforeFree = discountedExtra;
                    } else {
                        fare = discountedExtra; originalFare = EXTRA_GUEST_FARE; discountedFareBeforeFree = discountedExtra;
                    }

                    const tax = TAX_PER_PERSON;
                    const tipEligible = guest.age >= 3;
                    let tip = tipEligible ? tipPerPerson : 0;
                    let fasPlusFee = 0;
                    if (AppState.freeAtSeaPlus && position <= 2) {
                        fasPlusFee = 150; tip = 0;
                    }

                    let drink = 0;
                    if (includeDrinks) {
                        if (guest.age >= 21) drink = 85.50;
                        else if (position <= 2) drink = 37.50;
                    }

                    let dinner = 0;
                    if (includeDinner && position <= 2) {
                        if (guest.age >= 13) dinner = 20;
                    }

                    const tipPreCruise = tipsBeforeCruise ? tip : 0;
                    const tipOnboard = tipsBeforeCruise ? 0 : tip;
                    const guestTotal = fare + tax + tipPreCruise + drink + dinner + fasPlusFee;
                    const guestFullCost = fare + tax + tip + drink + dinner + fasPlusFee;

                    return {
                        position, guest, fare, originalFare, discountedFareBeforeFree, isFreeGuest,
                        tax, tip, tipPreCruise, tipOnboard, drink, dinner, fasPlusFee,
                        total: guestTotal, fullCost: guestFullCost
                    };
                });

                const taxes = guestDetails.reduce((sum, g) => sum + g.tax, 0);
                const tips = guestDetails.reduce((sum, g) => sum + g.tip, 0);
                const tipsPreCruise = tipsBeforeCruise ? tips : 0;
                const tipsOnboard = tipsBeforeCruise ? 0 : tips;
                const drinks = guestDetails.reduce((sum, g) => sum + g.drink, 0);
                const dinner = guestDetails.reduce((sum, g) => sum + g.dinner, 0);
                const fasPlusCost = guestDetails.reduce((sum, g) => sum + g.fasPlusFee, 0);

                let depositCredit = 0;
                if (AppState.depositOption === 'credit150') depositCredit = 150;

                const grandTotalBeforeCredit = totalFare + taxes + tipsPreCruise + drinks + dinner + fasPlusCost;
                const grandTotal = grandTotalBeforeCredit - depositCredit;
                const fullTripCost = totalFare + taxes + tips + drinks + dinner + fasPlusCost - depositCredit;

                const originalTotalFare = cabin.isSolo
                    ? cabin.basePrice
                    : cabin.basePrice + Math.max(0, effectiveGuests - 2) * EXTRA_GUEST_FARE;
                const discountedTotalFare = cabin.isSolo
                    ? discountedBase
                    : discountedBase + Math.max(0, effectiveGuests - 2) * discountedExtra;
                const originalPerPersonAvg = effectiveGuests > 0 ? originalTotalFare / effectiveGuests : 0;

                const deposit = isHighTier ? Math.round(totalFare * 0.10) : 100;
                const balance = grandTotal - deposit;
                const perPersonAvg = effectiveGuests > 0 ? grandTotal / effectiveGuests : 0;
                const allSameCost = guestDetails.length > 1
                    ? guestDetails.every(g => Math.abs(g.total - guestDetails[0].total) < 0.01) : true;

                return {
                    totalFare, originalTotalFare, discountedTotalFare, originalPerPersonAvg,
                    taxes, tips, tipsPreCruise, tipsOnboard, drinks, dinner, fasPlusCost,
                    depositCredit, grandTotalBeforeCredit, grandTotal, fullTripCost,
                    deposit, balance, perPersonAvg, allSameCost, effectiveGuests, exceedsMax,
                    guestDetails, tipsBeforeCruise, isHighTier
                };
            },

            calculateConnectingPair(pair, room1Members, room2Members, includeDrinks, includeDinner, tipsBeforeCruise) {
                const room1 = this.calculateForMembers(pair.room1Cabin, room1Members, includeDrinks, includeDinner, tipsBeforeCruise);
                const room2 = this.calculateForMembers(pair.room2Cabin, room2Members, includeDrinks, includeDinner, tipsBeforeCruise);

                return {
                    room1,
                    room2,
                    combinedGrandTotal: room1.grandTotal + room2.grandTotal,
                    combinedDeposit: room1.deposit + room2.deposit,
                    combinedBalance: room1.balance + room2.balance,
                    exceedsMax: room1.exceedsMax || room2.exceedsMax,
                    room1Empty: room1Members.length === 0,
                    room2Empty: room2Members.length === 0
                };
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: amount % 1 === 0 ? 0 : 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }
        };

        // ==================== APP STATE ====================
        const AppState = {
            currentFilter: 'All',
            currentSort: 'price-asc',
            includeDrinks: false,
            includeDinner: false,
            tipsBeforeCruise: true,
            selectedCabins: new Set(),
            openBreakdowns: new Set(),
            adultCount: 0,
            childCount: 0,
            childAges: [],
            depositOption: 'regular',
            freeAtSeaPlus: false,
            selectedGroups: new Set(),
            familyGroups: [],
            reservedGroups: [],
            guestNames: [],
            connectingRoomsEnabled: false,
            connectingRoom1Groups: new Set(),
            connectingRoom2Groups: new Set(),
            connectingOpenBreakdowns: new Set(),

            recomputeGuests() {
                let adults = 0, children = 0, ages = [], names = [];
                for (const label of this.selectedGroups) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => {
                        names.push(m.name);
                        if (m.age >= 21) adults++;
                        else { children++; ages.push(m.age); }
                    });
                }
                this.adultCount = adults;
                this.childCount = children;
                this.childAges = ages;
                this.guestNames = names;
            },

            getSelectedMembers() {
                const members = [];
                for (const label of this.selectedGroups) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => members.push(m));
                }
                return members;
            },

            getSelectedGroupLabels() {
                return Array.from(this.selectedGroups);
            },

            getMembersForGroups(groupLabels) {
                const members = [];
                for (const label of groupLabels) {
                    const group = this.familyGroups.find(g => g.label === label);
                    if (!group) continue;
                    group.members.forEach(m => members.push(m));
                }
                return members;
            },

            resetConnectingRooms() {
                this.connectingRoomsEnabled = false;
                this.connectingRoom1Groups.clear();
                this.connectingRoom2Groups.clear();
                this.connectingOpenBreakdowns.clear();
                const toggle = document.getElementById('connectingRoomsSwitch');
                if (toggle) toggle.checked = false;
            },

            autoAssignConnectingRooms() {
                this.connectingRoom1Groups.clear();
                this.connectingRoom2Groups.clear();
                const labels = this.getSelectedGroupLabels();
                if (labels.length >= 1) this.connectingRoom1Groups.add(labels[0]);
                if (labels.length >= 2) this.connectingRoom2Groups.add(labels[1]);
            }
        };

        // ==================== RENDERER ====================
        const Renderer = {
            renderCabinCard(cabin) {
                const pricing = PriceCalculator.calculate(cabin, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise);
                const isSelected = AppState.selectedCabins.has(cabin.id);
                const isBreakdownOpen = AppState.openBreakdowns.has(cabin.id);
                const badgeClass = cabin.roomType.replace(/\s+/g, '-');
                const totalGuests = AppState.adultCount + AppState.childCount;
                const isDimmed = totalGuests > cabin.maxGuests;

                let fitBadge = '';
                if (totalGuests > 0 && !isDimmed) {
                    if (cabin.maxGuests === totalGuests) {
                        fitBadge = '<span class="fit-badge perfect">Perfect fit</span>';
                    } else if (cabin.maxGuests >= totalGuests && cabin.maxGuests <= totalGuests + 2) {
                        fitBadge = '<span class="fit-badge good">Good fit</span>';
                    }
                }

                const namesForLabel = AppState.guestNames.length > 0
                    ? AppState.guestNames.slice(0, 3).join(', ') + (AppState.guestNames.length > 3 ? ' +' + (AppState.guestNames.length - 3) : '')
                    : (totalGuests > 0 ? totalGuests + ' guest' + (totalGuests !== 1 ? 's' : '') : '2 guests (default)');

                const avgSuffix = pricing.allSameCost ? '' : ' (avg)';
                const perPersonText = `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalPerPersonAvg)}</span>${PriceCalculator.formatCurrency(pricing.perPersonAvg)}/person${avgSuffix}`;

                return `
                    <article class="cabin-card ${isSelected ? 'selected' : ''} ${isDimmed ? 'dimmed' : ''}" data-id="${cabin.id}">
                        ${fitBadge}
                        ${isDimmed ? `<div class="max-guests-note">Max ${cabin.maxGuests} guest${cabin.maxGuests !== 1 ? 's' : ''}</div>` : ''}
                        <div class="cabin-header">
                            <span class="cabin-type-badge badge-${badgeClass}">${cabin.roomType}</span>
                            <h3 class="cabin-name">${cabin.name}</h3>
                            <div class="cabin-specs">
                                <span class="cabin-spec">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    </svg>
                                    ${cabin.sqft} sq ft
                                </span>
                                ${cabin.balconySqft ? `
                                    <span class="cabin-spec">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        </svg>
                                        ${cabin.balconySqft} sq ft balcony
                                    </span>
                                ` : ''}
                                <span class="cabin-spec">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    Up to ${cabin.maxGuests}
                                </span>
                            </div>
                        </div>

                        <div class="cabin-body">
                            <div class="price-display">
                                <div class="price-label">${isDimmed ? 'Price (if ' + cabin.maxGuests + ' guests)' : 'Total for ' + namesForLabel}</div>
                                <div class="price-amount" data-cabin-id="${cabin.id}">${PriceCalculator.formatCurrency(pricing.grandTotal)}</div>
                                <div class="price-per-person">${perPersonText}</div>
                                ${!AppState.tipsBeforeCruise && pricing.tipsOnboard > 0 ? `
                                    <div class="tips-onboard-note">+ ${PriceCalculator.formatCurrency(pricing.tipsOnboard)} tips paid onboard</div>
                                ` : ''}
                            </div>

                            <div class="deposit-info">
                                <span class="deposit-label">Pay today (deposit)${pricing.depositCredit > 0 ? ' <span class="credit-badge">-$' + pricing.depositCredit + ' credit</span>' : ''}</span>
                                <span class="deposit-amount">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                            </div>

                            <div class="cabin-actions">
                                <button class="btn btn-secondary toggle-breakdown" data-id="${cabin.id}">
                                    ${isBreakdownOpen ? 'Hide' : 'View'} Breakdown
                                </button>
                                <button class="btn btn-compare ${isSelected ? 'selected' : ''}" data-id="${cabin.id}">
                                    ${isSelected ? 'Selected' : 'Compare'}
                                </button>
                            </div>

                            <div class="breakdown ${isBreakdownOpen ? 'open' : ''}" data-breakdown-id="${cabin.id}">
                                <div class="breakdown-content">
                                    ${this.renderBreakdown(cabin, pricing)}
                                </div>
                            </div>
                        </div>

                        <a href="${NCL_LINKS[cabin.roomType]}" target="_blank" rel="noopener" class="ncl-link">
                            View on NCL &rarr;
                        </a>
                    </article>
                `;
            },

            renderBreakdown(cabin, pricing) {
                const tipRate = PriceCalculator.getTipPerPersonPerDay(cabin.roomType);
                let html = '';

                // Summary section
                const hasFreeGuests = pricing.guestDetails.some(g => g.isFreeGuest);
                const promoLabels = hasFreeGuests ? '50% OFF + 3rd/4th FREE' : '50% OFF';
                const fareStrikethrough = hasFreeGuests && pricing.discountedTotalFare !== pricing.totalFare
                    ? `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalTotalFare)}</span><span class="original-price">${PriceCalculator.formatCurrency(pricing.discountedTotalFare)}</span> ${PriceCalculator.formatCurrency(pricing.totalFare)}`
                    : `<span class="original-price">${PriceCalculator.formatCurrency(pricing.originalTotalFare)}</span> ${PriceCalculator.formatCurrency(pricing.totalFare)}`;
                html += `
                    <div class="breakdown-row">
                        <span class="breakdown-label">Base Fare (${cabin.isSolo ? '1 guest' : pricing.effectiveGuests + ' guests'}) <span style="color:var(--teal);font-weight:600;font-size:0.75rem;">${promoLabels}</span></span>
                        <span class="breakdown-value">${fareStrikethrough}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Taxes ($${TAX_PER_PERSON} x ${pricing.effectiveGuests})</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.taxes)}</span>
                    </div>
                `;

                if (AppState.tipsBeforeCruise) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">Gratuities ($${tipRate}/day x ${CRUISE_NIGHTS} nights x ${pricing.guestDetails.filter(g => g.tip > 0).length} guests)</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.tips)}</span>
                        </div>
                    `;
                }

                if (AppState.includeDrinks) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">Drink Package</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.drinks)}</span>
                        </div>
                    `;
                }

                if (AppState.includeDinner) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">Dinner Package</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.dinner)}</span>
                        </div>
                    `;
                }

                if (pricing.fasPlusCost > 0) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">Free at Sea Plus ($150 x ${pricing.guestDetails.filter(g => g.fasPlusFee > 0).length} guests)</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.fasPlusCost)}</span>
                        </div>
                    `;
                }

                if (pricing.depositCredit > 0) {
                    html += `
                        <div class="breakdown-row">
                            <span class="breakdown-label">Subtotal</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.grandTotalBeforeCredit)}</span>
                        </div>
                        <div class="breakdown-row" style="color: var(--teal);">
                            <span class="breakdown-label">Deposit Credit</span>
                            <span class="breakdown-value">-${PriceCalculator.formatCurrency(pricing.depositCredit)}</span>
                        </div>
                    `;
                }

                html += `
                    <div class="breakdown-row total">
                        <span class="breakdown-label">Total Due by 7/23/2026</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.grandTotal)}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Deposit (pay today)</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                    </div>
                    <div class="breakdown-row">
                        <span class="breakdown-label">Balance (due 7/23/2026)</span>
                        <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.balance)}</span>
                    </div>
                `;

                if (!AppState.tipsBeforeCruise && pricing.tipsOnboard > 0) {
                    html += `
                        <div class="breakdown-row tips-onboard">
                            <span class="breakdown-label">Gratuities (pay onboard)</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.tipsOnboard)}</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">Full Trip Cost</span>
                            <span class="breakdown-value">${PriceCalculator.formatCurrency(pricing.fullTripCost)}</span>
                        </div>
                    `;
                }

                // Per-guest breakdown
                html += `<div class="breakdown-section-header">Per-Guest Breakdown</div>`;

                pricing.guestDetails.forEach(gd => {
                    const items = [];
                    if (gd.isFreeGuest) {
                        items.push(`<span class="original-price">${PriceCalculator.formatCurrency(gd.originalFare)}</span><span class="original-price">${PriceCalculator.formatCurrency(gd.discountedFareBeforeFree)}</span>FREE fare`);
                    } else {
                        items.push(`<span class="original-price">${PriceCalculator.formatCurrency(gd.originalFare)}</span>${PriceCalculator.formatCurrency(gd.fare)} fare`);
                    }
                    items.push(`${PriceCalculator.formatCurrency(gd.tax)} tax`);

                    if (gd.fasPlusFee > 0) {
                        items.push(`${PriceCalculator.formatCurrency(gd.fasPlusFee)} FAS+`);
                        items.push(`$0 tip (incl.)`);
                    } else if (gd.tip > 0) {
                        items.push(`${PriceCalculator.formatCurrency(AppState.tipsBeforeCruise ? gd.tip : 0)} tip${!AppState.tipsBeforeCruise ? ' (onboard: ' + PriceCalculator.formatCurrency(gd.tip) + ')' : ''}`);
                    } else {
                        items.push(`$0 tip`);
                    }

                    if (AppState.includeDrinks) {
                        if (gd.drink > 0) {
                            if (gd.guest.age < 21 && gd.position <= 2) {
                                items.push(`${PriceCalculator.formatCurrency(gd.drink)} soda/juice`);
                            } else {
                                items.push(`${PriceCalculator.formatCurrency(gd.drink)} drink`);
                            }
                        } else {
                            items.push(`$0 drink`);
                        }
                    }

                    if (AppState.includeDinner) {
                        if (gd.position <= 2) {
                            if (gd.dinner > 0) {
                                items.push(`${PriceCalculator.formatCurrency(gd.dinner)} dinner`);
                            } else {
                                items.push(`$0 dinner`);
                            }
                        }
                    }

                    // Build free tags
                    const freeTags = [];
                    if (gd.isFreeGuest) freeTags.push('Cruise Fare');
                    if (gd.tip === 0 && gd.guest.age < 3) freeTags.push('Tips');
                    if (AppState.includeDrinks && gd.drink === 0 && gd.position > 2 && gd.guest.age < 21) freeTags.push('Drinks');
                    if (AppState.includeDinner && gd.dinner === 0 && gd.position <= 2 && gd.guest.age < 13) freeTags.push('Dinner');

                    const freeTagsHtml = freeTags.map(t => `<span class="free-tag">FREE ${t}</span>`).join(' ');

                    html += `
                        <div class="guest-breakdown-row">
                            <div>
                                <div class="guest-breakdown-label">${gd.guest.name || 'Guest ' + gd.position} (${gd.guest.type === 'adult' ? 'Adult' : 'Age ' + gd.guest.age}) ${freeTagsHtml}</div>
                                <div class="guest-breakdown-detail">${items.join(' + ')}</div>
                            </div>
                            <div class="guest-breakdown-value">${PriceCalculator.formatCurrency(gd.total)}</div>
                        </div>
                    `;
                });

                return html;
            },

            renderGrid() {
                const grid = document.getElementById('cabinGrid');
                let filteredData = CABIN_DATA;

                // Apply filter
                if (AppState.currentFilter !== 'All') {
                    filteredData = filteredData.filter(c => c.roomType === AppState.currentFilter);
                }

                // Apply sort, pushing dimmed cabins (exceeding max guests) to the bottom
                const totalGuests = AppState.adultCount + AppState.childCount;
                filteredData = [...filteredData].sort((a, b) => {
                    const aDimmed = totalGuests > a.maxGuests ? 1 : 0;
                    const bDimmed = totalGuests > b.maxGuests ? 1 : 0;
                    if (aDimmed !== bDimmed) return aDimmed - bDimmed;

                    const priceA = PriceCalculator.calculate(a, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise).grandTotal;
                    const priceB = PriceCalculator.calculate(b, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise).grandTotal;
                    const sqftA = parseInt(a.sqft.split('-')[0].replace(/,/g, ''));
                    const sqftB = parseInt(b.sqft.split('-')[0].replace(/,/g, ''));

                    switch (AppState.currentSort) {
                        case 'price-asc': return priceA - priceB;
                        case 'price-desc': return priceB - priceA;
                        case 'sqft-asc': return sqftA - sqftB;
                        case 'sqft-desc': return sqftB - sqftA;
                        default: return 0;
                    }
                });

                if (filteredData.length === 0) {
                    grid.innerHTML = `
                        <div class="no-results">
                            <div class="no-results-icon">&#128674;</div>
                            <p>No cabins found for this filter.</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = filteredData.map(cabin => this.renderCabinCard(cabin)).join('');
            },

            updatePrices() {
                document.querySelectorAll('.price-amount').forEach(el => {
                    el.classList.add('flash');
                    setTimeout(() => el.classList.remove('flash'), 500);
                });

                this.renderGrid();
                this.updateToggleLabels();
                this.updateRunningTotals();
                this.renderConnectingPairsGrid();
            },

            updateToggleLabels() {
                // Drink toggle
                const guests = PriceCalculator.buildGuestList();
                const totalGuests = AppState.adultCount + AppState.childCount;

                let drinkTotal = 0;
                let drinkParts = [];
                const adultsCount = guests.filter(g => g.age >= 21).length;
                const under21Pos1or2 = guests.filter((g, i) => g.age < 21 && i < 2).length;

                if (adultsCount > 0) {
                    drinkTotal += adultsCount * 85.50;
                    drinkParts.push(`${adultsCount} adult${adultsCount > 1 ? 's' : ''} x $85.50`);
                }
                if (under21Pos1or2 > 0) {
                    drinkTotal += under21Pos1or2 * 37.50;
                    drinkParts.push(`${under21Pos1or2} child x $37.50 soda`);
                }

                document.getElementById('drinkToggleDesc').textContent = drinkParts.length > 0
                    ? `+${PriceCalculator.formatCurrency(drinkTotal)} (${drinkParts.join(', ')})`
                    : 'No eligible guests';

                // Dinner toggle
                const dinnerEligible = Math.min(totalGuests, 2);
                const dinnerGuests = guests.slice(0, 2);
                let dinnerTotal = 0;
                dinnerGuests.forEach(g => {
                    if (g.age >= 13) dinnerTotal += 20;
                });
                if (dinnerTotal > 0) {
                    document.getElementById('dinnerToggleDesc').textContent =
                        `+${PriceCalculator.formatCurrency(dinnerTotal)} (first ${dinnerEligible} guests x $20)`;
                } else if (dinnerEligible > 0) {
                    document.getElementById('dinnerToggleDesc').textContent =
                        `FREE for children under 13`;
                } else {
                    document.getElementById('dinnerToggleDesc').textContent = 'No eligible guests';
                }
            },

            updateRunningTotals() {
                const totalsEl = document.getElementById('runningTotals');
                const packageTotalEl = document.getElementById('packageTotal');

                // Calculate based on current guest config
                const guests = PriceCalculator.buildGuestList();
                let packageTotal = 0;

                if (AppState.includeDrinks) {
                    guests.forEach((g, i) => {
                        if (g.age >= 21) packageTotal += 85.50;
                        else if (i < 2) packageTotal += 37.50;
                    });
                }

                if (AppState.includeDinner) {
                    guests.slice(0, 2).forEach(g => {
                        if (g.age >= 13) packageTotal += 20;
                    });
                }

                if (AppState.freeAtSeaPlus) {
                    const fasGuests = Math.min(guests.length, 2);
                    packageTotal += fasGuests * 150;
                }

                if (packageTotal > 0) {
                    totalsEl.style.display = 'flex';
                    packageTotalEl.textContent = PriceCalculator.formatCurrency(packageTotal);
                } else {
                    totalsEl.style.display = 'none';
                }
            },

            updateComparisonTray() {
                const tray = document.getElementById('comparisonTray');
                const count = document.getElementById('trayCount');

                count.textContent = AppState.selectedCabins.size;

                if (AppState.selectedCabins.size > 0) {
                    tray.classList.add('visible');
                } else {
                    tray.classList.remove('visible');
                }
            },

            renderComparison() {
                const grid = document.getElementById('comparisonGrid');
                const selectedCabins = CABIN_DATA.filter(c => AppState.selectedCabins.has(c.id));

                grid.className = `comparison-grid cols-${selectedCabins.length}`;

                grid.innerHTML = selectedCabins.map(cabin => {
                    const pricing = PriceCalculator.calculate(cabin, AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise);
                    const badgeClass = cabin.roomType.replace(/\s+/g, '-');

                    const perPersonText = pricing.allSameCost
                        ? PriceCalculator.formatCurrency(pricing.perPersonAvg)
                        : `${PriceCalculator.formatCurrency(pricing.perPersonAvg)} (avg)`;

                    return `
                        <div class="comparison-column">
                            <div class="comparison-cabin-header">
                                <span class="cabin-type-badge badge-${badgeClass}">${cabin.roomType}</span>
                                <div class="comparison-cabin-name">${cabin.name}</div>
                            </div>
                            <div class="comparison-cabin-body">
                                <div class="comparison-row">
                                    <span class="comparison-label">Cabin Size</span>
                                    <span class="comparison-value">${cabin.sqft} sq ft</span>
                                </div>
                                ${cabin.balconySqft ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">Balcony</span>
                                        <span class="comparison-value">${cabin.balconySqft} sq ft</span>
                                    </div>
                                ` : `
                                    <div class="comparison-row">
                                        <span class="comparison-label">Balcony</span>
                                        <span class="comparison-value">-</span>
                                    </div>
                                `}
                                <div class="comparison-row">
                                    <span class="comparison-label">Max Guests</span>
                                    <span class="comparison-value">${cabin.maxGuests}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">Per Person</span>
                                    <span class="comparison-value">${perPersonText}</span>
                                </div>
                                <div class="comparison-row highlight">
                                    <span class="comparison-label">Base Fare</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.totalFare)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">Taxes</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.taxes)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">Gratuities</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.tips)}</span>
                                </div>
                                ${pricing.fasPlusCost > 0 ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">Free at Sea Plus</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.fasPlusCost)}</span>
                                    </div>
                                ` : ''}
                                ${AppState.includeDrinks ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">Drink Package</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.drinks)}</span>
                                    </div>
                                ` : ''}
                                ${AppState.includeDinner ? `
                                    <div class="comparison-row">
                                        <span class="comparison-label">Dinner Package</span>
                                        <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.dinner)}</span>
                                    </div>
                                ` : ''}
                                <div class="comparison-row highlight">
                                    <span class="comparison-label">Deposit${pricing.depositCredit > 0 ? ' <span class="credit-badge">-$' + pricing.depositCredit + ' credit</span>' : ''}</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.deposit)}</span>
                                </div>
                                <div class="comparison-row">
                                    <span class="comparison-label">Balance Due</span>
                                    <span class="comparison-value">${PriceCalculator.formatCurrency(pricing.balance)}</span>
                                </div>
                            </div>
                            <div class="comparison-total">
                                <div class="comparison-total-label">Grand Total</div>
                                <div class="comparison-total-amount">${PriceCalculator.formatCurrency(pricing.grandTotal)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderConnectingPairCard(pair, combinedPricing) {
                const { room1, room2, combinedGrandTotal, combinedDeposit, exceedsMax, room1Empty, room2Empty } = combinedPricing;
                const isOpen = AppState.connectingOpenBreakdowns.has(pair.id);
                const isDimmed = exceedsMax || room1Empty || room2Empty;

                const badgeClass1 = pair.room1Cabin.roomType.replace(/\s+/g, '-');
                const badgeClass2 = pair.room2Cabin.roomType.replace(/\s+/g, '-');

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);
                const room1Names = room1Members.map(m => m.name).join(', ') || 'No guests';
                const room2Names = room2Members.map(m => m.name).join(', ') || 'No guests';

                let warningHtml = '';
                if (room1Empty || room2Empty) {
                    warningHtml = '<div class="max-guests-note">Assign guests to both rooms</div>';
                } else if (room1.exceedsMax) {
                    warningHtml = `<div class="max-guests-note">Room 1: max ${pair.room1Cabin.maxGuests} guests</div>`;
                } else if (room2.exceedsMax) {
                    warningHtml = `<div class="max-guests-note">Room 2: max ${pair.room2Cabin.maxGuests} guests</div>`;
                }

                const room1Specs = `${pair.room1Cabin.sqft} sq ft${pair.room1Cabin.balconySqft ? ', ' + pair.room1Cabin.balconySqft + ' sq ft balcony' : ''}  Max ${pair.room1Cabin.maxGuests}`;
                const room2Specs = `${pair.room2Cabin.sqft} sq ft${pair.room2Cabin.balconySqft ? ', ' + pair.room2Cabin.balconySqft + ' sq ft balcony' : ''}  Max ${pair.room2Cabin.maxGuests}`;

                let breakdownHtml = '';
                if (isOpen && !room1Empty && !room2Empty) {
                    breakdownHtml = `
                        <div class="connecting-breakdown open">
                            <div class="connecting-breakdown-room-title">Room 1: ${pair.room1Cabin.name}</div>
                            ${Renderer.renderBreakdown(pair.room1Cabin, room1)}
                            <div class="connecting-breakdown-room-title" style="margin-top:1rem;">Room 2: ${pair.room2Cabin.name}</div>
                            ${Renderer.renderBreakdown(pair.room2Cabin, room2)}
                        </div>
                    `;
                }

                return `
                    <div class="connecting-card ${isDimmed ? 'dimmed' : ''}" data-pair-id="${pair.id}">
                        <div class="connecting-card-top"></div>
                        <div class="connecting-card-body">
                            ${warningHtml}
                            <div class="connecting-card-label">
                                <span class="connecting-link-icon">&#128279;</span>
                                ${pair.label}
                            </div>

                            <div class="connecting-room-row">
                                <div class="connecting-room-info">
                                    <div class="connecting-room-info-header">Room 1</div>
                                    <span class="connecting-room-type-badge cabin-type-badge badge-${badgeClass1}">${pair.room1Cabin.roomType}</span>
                                    <div class="connecting-room-specs">${room1Specs}</div>
                                    <div class="connecting-room-guests">${room1Names}</div>
                                    ${!room1Empty ? `<div class="connecting-room-subtotal">${PriceCalculator.formatCurrency(room1.grandTotal)}</div>` : ''}
                                </div>
                                <div class="connecting-room-info">
                                    <div class="connecting-room-info-header">Room 2</div>
                                    <span class="connecting-room-type-badge cabin-type-badge badge-${badgeClass2}">${pair.room2Cabin.roomType}</span>
                                    <div class="connecting-room-specs">${room2Specs}</div>
                                    <div class="connecting-room-guests">${room2Names}</div>
                                    ${!room2Empty ? `<div class="connecting-room-subtotal">${PriceCalculator.formatCurrency(room2.grandTotal)}</div>` : ''}
                                </div>
                            </div>

                            ${!isDimmed ? `
                                <div class="connecting-combined">
                                    <div>
                                        <div class="connecting-combined-label">Combined Total</div>
                                        <div class="connecting-combined-deposit">Deposit: ${PriceCalculator.formatCurrency(combinedDeposit)}</div>
                                    </div>
                                    <div class="connecting-combined-total">${PriceCalculator.formatCurrency(combinedGrandTotal)}</div>
                                </div>
                            ` : ''}

                            <div class="connecting-card-actions">
                                <button class="btn btn-secondary toggle-connecting-breakdown" data-pair-id="${pair.id}">
                                    ${isOpen ? 'Hide' : 'View'} Breakdown
                                </button>
                            </div>

                            ${breakdownHtml}
                        </div>
                    </div>
                `;
            },

            renderConnectingPairsGrid() {
                const section = document.getElementById('connectingPairsSection');
                const grid = document.getElementById('connectingPairsGrid');

                if (!AppState.connectingRoomsEnabled || CONNECTING_PAIRS.length === 0) {
                    section.classList.remove('visible');
                    return;
                }

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);

                if (room1Members.length === 0 && room2Members.length === 0) {
                    section.classList.remove('visible');
                    return;
                }

                section.classList.add('visible');

                const cards = CONNECTING_PAIRS.map(pair => {
                    const combinedPricing = PriceCalculator.calculateConnectingPair(
                        pair, room1Members, room2Members,
                        AppState.includeDrinks, AppState.includeDinner, AppState.tipsBeforeCruise
                    );
                    return { pair, combinedPricing };
                });

                // Sort: non-dimmed first by combined price, dimmed at end
                cards.sort((a, b) => {
                    const aDimmed = a.combinedPricing.exceedsMax || a.combinedPricing.room1Empty || a.combinedPricing.room2Empty ? 1 : 0;
                    const bDimmed = b.combinedPricing.exceedsMax || b.combinedPricing.room1Empty || b.combinedPricing.room2Empty ? 1 : 0;
                    if (aDimmed !== bDimmed) return aDimmed - bDimmed;
                    return a.combinedPricing.combinedGrandTotal - b.combinedPricing.combinedGrandTotal;
                });

                grid.innerHTML = cards.map(({ pair, combinedPricing }) =>
                    this.renderConnectingPairCard(pair, combinedPricing)
                ).join('');
            }
        };

        // ==================== APP CONTROLLER ====================
        const App = {
            async init() {
                CABIN_DATA = await CSVParser.load('cabin_base_price_20260131.csv');
                const familyData = await FamilyCSVParser.load('family_groups.csv');
                AppState.familyGroups = familyData.unbookedGroups;
                AppState.reservedGroups = familyData.reservedGroups;

                // Load connecting rooms data (requires CABIN_DATA to be loaded first)
                CONNECTING_PAIRS = await ConnectingRoomsParser.load('connectingRooms.csv', 'cabin_code_map.csv');

                if (CABIN_DATA.length === 0) {
                    document.getElementById('cabinGrid').innerHTML = `
                        <div class="no-results">
                            <div class="no-results-icon">&#9888;</div>
                            <p>Failed to load cabin data. Please refresh the page.</p>
                        </div>
                    `;
                    return;
                }

                this.renderFamilyButtons();
                this.renderTracker();
                this.updateTabBadges();
                this.startCountdowns();
                this.initDarkMode();
                this.initEasterEgg();
                this.bindEvents();
                Renderer.updateToggleLabels();
                this.updateFasPlusAvailability();
                this.updateFasPlusDisplay();
                this.updateGuestDisplay();
                Renderer.renderGrid();
            },

            renderFamilyButtons() {
                const container = document.getElementById('familyButtons');
                container.innerHTML = AppState.familyGroups.map((group, idx) => {
                    const color = FAMILY_COLORS[idx % FAMILY_COLORS.length];
                    return `<button class="family-btn" data-label="${group.label}" style="--family-color:${color}">
                        <span class="family-color-dot" style="background:${color}"></span>
                        ${group.label}
                        <span class="member-count">${group.members.length}</span>
                    </button>`;
                }).join('');
            },

            toggleFamilyGroup(label) {
                const wasSelected = AppState.selectedGroups.has(label);
                if (wasSelected) {
                    AppState.selectedGroups.delete(label);
                    // Remove from room assignments
                    AppState.connectingRoom1Groups.delete(label);
                    AppState.connectingRoom2Groups.delete(label);
                } else {
                    AppState.selectedGroups.add(label);
                }

                const groupCount = AppState.selectedGroups.size;
                const toggleEl = document.getElementById('connectingRoomsToggle');

                if (groupCount >= 2) {
                    toggleEl.classList.add('visible');
                } else {
                    toggleEl.classList.remove('visible');
                    if (AppState.connectingRoomsEnabled) {
                        AppState.resetConnectingRooms();
                    }
                }

                // Handle connecting room assignments
                if (AppState.connectingRoomsEnabled) {
                    if (groupCount < 2) {
                        AppState.resetConnectingRooms();
                    } else if (groupCount === 2) {
                        AppState.autoAssignConnectingRooms();
                    } else if (!wasSelected) {
                        // New group added with 3+ groups: add to Room 1 by default
                        AppState.connectingRoom1Groups.add(label);
                    }
                    this.updateRoomAssignmentUI();
                    this.renderRoomAssignmentChips();
                }

                AppState.recomputeGuests();
                this.updateGuestDisplay();
                this.updateGuestSummary();
                this.updateSuggestionBanner();
                this.updateGrandTotalFloat();
                this.updateFasPlusDisplay();
                Renderer.updatePrices();
                document.querySelectorAll('.family-btn').forEach(btn => {
                    btn.classList.toggle('active', AppState.selectedGroups.has(btn.dataset.label));
                });
            },

            updateGuestSummary() {
                const el = document.getElementById('guestSummary');
                const textEl = document.getElementById('guestSummaryText');
                const namesEl = document.getElementById('guestSummaryNames');
                const members = AppState.getSelectedMembers();
                if (members.length === 0) { el.style.display = 'none'; return; }
                el.style.display = 'block';
                const adults = members.filter(m => m.age >= 21).length;
                const children = members.filter(m => m.age < 21);
                let text = `Selected: <strong>${adults} adult${adults !== 1 ? 's' : ''}</strong>`;
                if (children.length > 0) {
                    text += `, <strong>${children.length} child${children.length !== 1 ? 'ren' : ''}</strong> (${children.map(c => 'age ' + c.age).join(', ')})`;
                }
                text += ` = <strong>${members.length} guest${members.length !== 1 ? 's' : ''}</strong>`;
                textEl.innerHTML = text;
                namesEl.textContent = members.map(m => m.name).join(', ');
            },

            updateSuggestionBanner() {
                const banner = document.getElementById('suggestionBanner');
                const text = document.getElementById('suggestionText');
                const total = AppState.adultCount + AppState.childCount;
                if (total > 4 && AppState.selectedGroups.size >= 2) {
                    const maxCabin = Math.max(...CABIN_DATA.map(c => c.maxGuests));
                    if (total > maxCabin || CABIN_DATA.filter(c => c.maxGuests >= total).length <= 3) {
                        banner.style.display = 'block';
                        text.textContent = `With ${total} guests, consider splitting into 2 cabins for more options and better prices.`;
                        return;
                    }
                }
                banner.style.display = 'none';
            },

            updateGrandTotalFloat() {
                const el = document.getElementById('grandTotalFloat');
                const labelEl = document.getElementById('grandTotalLabel');
                const amountEl = document.getElementById('grandTotalAmount');
                const total = AppState.adultCount + AppState.childCount;
                if (total === 0) { el.classList.remove('visible'); return; }
                const labels = AppState.getSelectedGroupLabels().join(' + ');
                labelEl.textContent = `Pricing for: ${labels}`;
                amountEl.textContent = `${total} guest${total !== 1 ? 's' : ''}`;
                el.classList.add('visible');
            },

            updateGuestDisplay() {
                const total = AppState.adultCount + AppState.childCount;
                document.getElementById('adultCount').textContent = AppState.adultCount;
                document.getElementById('childCount').textContent = AppState.childCount;
                document.getElementById('guestTotal').textContent = total > 0
                    ? `Total: ${total} guest${total !== 1 ? 's' : ''}`
                    : 'Select a family group above';
            },

            updateFasPlusAvailability() {
                const fasPlusToggle = document.getElementById('fasPlusToggle');
                const requiresEl = document.getElementById('fasPlusRequires');
                const bothSelected = AppState.includeDrinks && AppState.includeDinner;

                // If drink or dinner is turned off while FAS Plus is on, turn off FAS Plus
                if (!bothSelected && AppState.freeAtSeaPlus) {
                    fasPlusToggle.checked = false;
                    AppState.freeAtSeaPlus = false;
                }

                // Show/hide the note (toggle always stays enabled)
                if (bothSelected) {
                    requiresEl.style.display = 'none';
                } else {
                    requiresEl.style.display = 'block';
                }

                this.updateFasPlusDisplay();
                Renderer.updatePrices();
            },

            updateFasPlusDisplay() {
                const descEl = document.getElementById('fasPlusDesc');
                const savingsEl = document.getElementById('fasPlusSavings');
                const guests = PriceCalculator.buildGuestList();
                const fasGuestCount = Math.min(guests.length, 2);
                const fasCost = fasGuestCount * 150;

                descEl.textContent = `+${PriceCalculator.formatCurrency(fasCost)} (${fasGuestCount} guest${fasGuestCount !== 1 ? 's' : ''} x $150) \u2014 Includes prepaid gratuities`;

                if (AppState.freeAtSeaPlus) {
                    // Calculate tip savings
                    let tipSavings = 0;
                    guests.slice(0, 2).forEach(g => {
                        if (g.age >= 3) {
                            // Use a representative tip rate (we don't know the cabin here)
                            // Show generic savings message instead
                            tipSavings += 60; // minimum tip rate
                        }
                    });
                    if (tipSavings > 0) {
                        savingsEl.style.display = 'block';
                        savingsEl.textContent = `Includes $${tipSavings}-$${Math.round(tipSavings * 75/60)} in prepaid gratuities (varies by cabin)`;
                    } else {
                        savingsEl.style.display = 'none';
                    }
                } else {
                    savingsEl.style.display = 'none';
                }
            },

            populateCostBenefitTable() {
                const table = document.getElementById('costBenefitTable');
                const guests = PriceCalculator.buildGuestList();
                const fasGuestCount = Math.min(guests.length, 2);
                const fasCost = fasGuestCount * 150;

                let html = `
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Without FAS Plus</th>
                            <th>With FAS Plus</th>
                        </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="3" style="font-weight:600;color:var(--ocean-blue);padding-top:0.5rem;">Package Cost</td></tr>
                    <tr>
                        <td>Free at Sea Plus (${CRUISE_NIGHTS} days x ${fasGuestCount} guests)</td>
                        <td>$0</td>
                        <td>+${PriceCalculator.formatCurrency(fasCost)}</td>
                    </tr>
                    <tr><td colspan="3" style="font-weight:600;color:var(--teal);padding-top:1rem;">Savings &amp; Value</td></tr>
                `;

                // Tip savings per cabin tier
                const tiers = [
                    { label: 'Standard cabins ($20/day)', tipPerDay: 20 },
                    { label: 'Suite/Haven ($25/day)', tipPerDay: 25 }
                ];

                tiers.forEach(tier => {
                    const tipTotal = tier.tipPerDay * CRUISE_NIGHTS * fasGuestCount;
                    html += `
                        <tr>
                            <td>Prepaid Gratuities - ${tier.label}</td>
                            <td>$0 (pay separately)</td>
                            <td class="savings">-${PriceCalculator.formatCurrency(tipTotal)} (included)</td>
                        </tr>
                    `;
                });

                html += `
                    <tr>
                        <td>Unlimited Bar at Great Stirrup Cay</td>
                        <td>$0 (standard packages NOT valid on island after March 2026)</td>
                        <td class="savings">-$50 to -$100+ value</td>
                    </tr>
                    <tr>
                        <td>Unlimited Starbucks (1 drink per visit)</td>
                        <td>$0</td>
                        <td class="savings">-$20 to -$40+ (~$6-8 per specialty drink)</td>
                    </tr>
                    <tr>
                        <td>Premium Top-Shelf Spirits (Patr&oacute;n A&ntilde;ejo, Macallan 12-Year, etc.)</td>
                        <td>$0</td>
                        <td class="savings">-$15 to -$50+ ($15+ per drink)</td>
                    </tr>
                    <tr>
                        <td>Energy Drinks &amp; Fresh Juices</td>
                        <td>$0</td>
                        <td class="savings">-$20 to -$40 (~$6.25 each)</td>
                    </tr>
                    <tr>
                        <td>Bottled Water (Bars &amp; Restaurants)</td>
                        <td>$0</td>
                        <td class="savings">-$15 to -$30 ($4.50 per bottle)</td>
                    </tr>
                    <tr><td colspan="3" style="font-weight:600;color:var(--ocean-blue);padding-top:1rem;">Great Stirrup Cay Drink Prices (If No Plus Package)</td></tr>
                    <tr>
                        <td>Cocktails</td>
                        <td>$12.50+ each (plus 20% gratuity)</td>
                        <td class="savings">Included</td>
                    </tr>
                    <tr>
                        <td>Beer</td>
                        <td>$7.50+ each (plus 20% gratuity)</td>
                        <td class="savings">Included</td>
                    </tr>
                    <tr>
                        <td>Soda</td>
                        <td>$3.50 each (plus 20% gratuity)</td>
                        <td class="savings">Included</td>
                    </tr>
                    <tr>
                        <td><em>Example: 4 cocktails + 4 beers on island</em></td>
                        <td><em>~$96 + tip per couple</em></td>
                        <td class="savings"><em>$0</em></td>
                    </tr>
                `;

                // Net cost summary
                const tipSavingsLow = 20 * CRUISE_NIGHTS * fasGuestCount;
                const tipSavingsHigh = 25 * CRUISE_NIGHTS * fasGuestCount;
                const netLow = fasCost - tipSavingsHigh;
                const netHigh = fasCost - tipSavingsLow;

                html += `
                    <tr class="total-row" style="background: rgba(13,148,136,0.1);">
                        <td>Net Cost After Tip Savings</td>
                        <td>&mdash;</td>
                        <td>${PriceCalculator.formatCurrency(netLow)}-${PriceCalculator.formatCurrency(netHigh)} + all the extras above</td>
                    </tr>
                    </tbody>
                `;

                table.innerHTML = html;
            },

            renderChildAgeInputs() {
                const container = document.getElementById('childAgesInline');

                if (AppState.childCount === 0) {
                    container.innerHTML = '';
                    return;
                }

                // Ensure childAges array matches childCount
                while (AppState.childAges.length < AppState.childCount) {
                    AppState.childAges.push(10);
                }

                let html = '';
                for (let i = 0; i < AppState.childCount; i++) {
                    html += `
                        <div class="child-age-card">
                            <span class="child-age-card-label">Child ${i + 1}</span>
                            <div class="child-age-card-row">
                                Age: <input type="number" class="child-age-inline-input" data-index="${i}"
                                       min="0" max="20" value="${AppState.childAges[i]}">
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = html;

                // Bind change events
                container.querySelectorAll('.child-age-inline-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const idx = parseInt(e.target.dataset.index);
                        let age = parseInt(e.target.value) || 0;
                        if (age < 0) age = 0;
                        if (age > 20) age = 20;
                        e.target.value = age;
                        AppState.childAges[idx] = age;
                        Renderer.updatePrices();
                    });
                });
            },

            // ==================== TAB NAVIGATION ====================
            updateTabBadges() {
                const unbookedCount = AppState.familyGroups.reduce((sum, g) => sum + g.members.length, 0);
                const reservedCount = AppState.reservedGroups.reduce((sum, g) => sum + g.members.length, 0);
                document.getElementById('tabBadgeUnbooked').textContent = unbookedCount;
                document.getElementById('tabBadgeReserved').textContent = reservedCount;
            },

            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                document.querySelectorAll('.tab-page').forEach(page => {
                    page.classList.toggle('active', page.id === 'page-' + tabName);
                });
            },

            // ==================== TRACKER PAGE ====================
            renderTracker() {
                this.renderReservedCards();
                this.renderUnbookedPills();
                this.updateProgress();
            },

            renderReservedCards() {
                const grid = document.getElementById('reservedGrid');
                grid.innerHTML = AppState.reservedGroups.map((group, idx) => {
                    const memberNames = group.members.map(m => m.name).join(', ');
                    const color = FAMILY_COLORS[(AppState.familyGroups.length + idx) % FAMILY_COLORS.length];
                    return `<div class="reserved-card" data-cabin-type="${group.cabinType}" style="border-left:4px solid ${color}">
                        <div class="reserved-card-body">
                            <div class="reserved-card-label"><span class="family-color-dot" style="background:${color}"></span>${group.label}</div>
                            <div class="reserved-card-members">${memberNames}</div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">Cabin</span>
                                <span class="reserved-detail-value">${group.cabinType}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">Room</span>
                                <span class="reserved-detail-value">#${group.roomNumber}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">Price</span>
                                <span class="reserved-detail-value">${PriceCalculator.formatCurrency(group.pricePaid)}</span>
                            </div>
                            <div class="reserved-card-detail">
                                <span class="reserved-detail-label">Deposit</span>
                                <span class="reserved-detail-value ${group.depositPaid ? 'deposit-yes' : 'deposit-no'}">${group.depositPaid ? 'Paid' : 'Not paid'}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            renderUnbookedPills() {
                const container = document.getElementById('unbookedPills');
                container.innerHTML = AppState.familyGroups.map((group, idx) => {
                    const color = FAMILY_COLORS[idx % FAMILY_COLORS.length];
                    const firstName = group.members[0]?.name || group.label;
                    return `<span class="unbooked-pill">
                        <span class="family-color-dot" style="background:${color}"></span>
                        ${group.label}
                        <button class="nudge-btn" data-name="${firstName}" title="Send a nudge">Nudge</button>
                    </span>`;
                }).join('');
            },

            updateProgress() {
                const totalGroups = AppState.familyGroups.length + AppState.reservedGroups.length;
                const reserved = AppState.reservedGroups.length;
                const pct = totalGroups > 0 ? Math.round((reserved / totalGroups) * 100) : 0;
                document.getElementById('progressBarFill').style.width = pct + '%';
                document.getElementById('progressCount').textContent = `${reserved}/${totalGroups} families booked`;
                let message = '';
                if (pct === 100) { message = 'FULL REUNION! All families are booked!'; this.triggerConfetti(); }
                else if (pct >= 75) { message = `Almost there! Just ${totalGroups - reserved} famil${totalGroups - reserved === 1 ? 'y' : 'ies'} left`; }
                else if (pct >= 50) { message = 'Over halfway there!'; }
                else if (pct >= 25) { message = `Gaining momentum! ${totalGroups - reserved} more to go`; }
                else { message = `The adventure begins! ${reserved} famil${reserved === 1 ? 'y has' : 'ies have'} booked`; }
                document.getElementById('progressMessage').textContent = message;
            },

            // ==================== COUNTDOWNS ====================
            countdownInterval: null,
            startCountdowns() {
                this.updateCountdowns();
                this.countdownInterval = setInterval(() => this.updateCountdowns(), 1000);
            },
            updateCountdowns() {
                const now = new Date();
                this.renderCountdown('cruiseCountdownDigits', CRUISE_DATE, now);
                this.renderCountdown('paymentCountdownDigits', PAYMENT_DATE, now, true);
            },
            renderCountdown(containerId, targetDate, now, isPayment) {
                const container = document.getElementById(containerId);
                const diff = targetDate - now;
                if (diff <= 0 && isPayment) { container.innerHTML = '<div class="countdown-alert">PAYMENT DUE</div>'; return; }
                if (diff <= 0) { container.innerHTML = '<div class="countdown-alert">BON VOYAGE!</div>'; return; }
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                let colorClass = 'green';
                if (days < 7) colorClass = 'pulse';
                else if (days < 30) colorClass = 'red';
                else if (days < 90) colorClass = 'yellow';
                container.innerHTML = [
                    { val: days, label: 'Days' }, { val: hours, label: 'Hrs' },
                    { val: minutes, label: 'Min' }, { val: seconds, label: 'Sec' }
                ].map(u => `<div class="countdown-unit">
                    <div class="countdown-number ${colorClass}">${String(u.val).padStart(2, '0')}</div>
                    <div class="countdown-unit-label">${u.label}</div>
                </div>`).join('');
            },

            // ==================== DARK MODE ====================
            initDarkMode() {
                if (localStorage.getItem('darkMode') === 'true') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('darkModeToggle').textContent = '\u2600';
                }
            },
            toggleDarkMode() {
                const isDark = document.body.classList.toggle('dark-mode');
                document.getElementById('darkModeToggle').textContent = isDark ? '\u2600' : '\u263E';
                localStorage.setItem('darkMode', isDark);
            },

            // ==================== CONFETTI ====================
            triggerConfetti() {
                const canvas = document.getElementById('confettiCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const pieces = [];
                const colors = ['#f97316','#06b6d4','#ec4899','#8b5cf6','#84cc16','#f59e0b','#3b82f6','#22c55e'];
                for (let i = 0; i < 150; i++) {
                    pieces.push({
                        x: Math.random() * canvas.width, y: Math.random() * -canvas.height,
                        w: Math.random() * 10 + 5, h: Math.random() * 6 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        vy: Math.random() * 3 + 2, vx: Math.random() * 2 - 1,
                        rot: Math.random() * 360, rotSpeed: Math.random() * 6 - 3
                    });
                }
                let frame = 0;
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    let alive = false;
                    pieces.forEach(p => {
                        p.y += p.vy; p.x += p.vx; p.rot += p.rotSpeed;
                        if (p.y < canvas.height + 20) alive = true;
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                    });
                    frame++;
                    if (alive && frame < 300) requestAnimationFrame(animate);
                    else ctx.clearRect(0, 0, canvas.width, canvas.height);
                };
                animate();
            },

            // ==================== EASTER EGG ====================
            shipClickCount: 0,
            initEasterEgg() { this.shipClickCount = 0; },
            handleShipClick() {
                this.shipClickCount++;
                if (this.shipClickCount >= 5) {
                    this.shipClickCount = 0;
                    this.triggerConfetti();
                    const ship = document.querySelector('.ship-icon');
                    if (ship) {
                        ship.style.transition = 'transform 2s ease-in';
                        ship.style.transform = 'translateX(300vw)';
                        setTimeout(() => {
                            ship.style.transition = 'none'; ship.style.transform = '';
                            setTimeout(() => { ship.style.transition = ''; }, 50);
                        }, 2200);
                    }
                }
            },

            updateRoomAssignmentUI() {
                const assignmentEl = document.getElementById('roomAssignment');
                if (!AppState.connectingRoomsEnabled) {
                    assignmentEl.classList.remove('visible');
                    return;
                }
                if (AppState.selectedGroups.size >= 3) {
                    assignmentEl.classList.add('visible');
                } else {
                    assignmentEl.classList.remove('visible');
                }
            },

            renderRoomAssignmentChips() {
                const room1Container = document.getElementById('room1Chips');
                const room2Container = document.getElementById('room2Chips');
                const room1CountEl = document.getElementById('room1GuestCount');
                const room2CountEl = document.getElementById('room2GuestCount');

                const renderChips = (groups, targetRoom) => {
                    if (groups.size === 0) {
                        return '<div class="room-empty-msg">Click a group chip to move it here</div>';
                    }
                    return Array.from(groups).map(label => {
                        const idx = AppState.familyGroups.findIndex(g => g.label === label);
                        const color = FAMILY_COLORS[idx >= 0 ? idx % FAMILY_COLORS.length : 0];
                        const arrow = targetRoom === 1 ? '&#8594;' : '&#8592;';
                        return `<span class="room-group-chip" data-label="${label}" data-from-room="${targetRoom}" style="background:${color}">${label} <span class="chip-arrow">${arrow}</span></span>`;
                    }).join('');
                };

                room1Container.innerHTML = renderChips(AppState.connectingRoom1Groups, 1);
                room2Container.innerHTML = renderChips(AppState.connectingRoom2Groups, 2);

                const room1Members = AppState.getMembersForGroups(AppState.connectingRoom1Groups);
                const room2Members = AppState.getMembersForGroups(AppState.connectingRoom2Groups);
                room1CountEl.textContent = room1Members.length > 0 ? `${room1Members.length} guest${room1Members.length !== 1 ? 's' : ''}` : '';
                room2CountEl.textContent = room2Members.length > 0 ? `${room2Members.length} guest${room2Members.length !== 1 ? 's' : ''}` : '';
            },

            bindEvents() {
                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });

                // Family group buttons
                document.getElementById('familyButtons').addEventListener('click', (e) => {
                    const btn = e.target.closest('.family-btn');
                    if (btn) this.toggleFamilyGroup(btn.dataset.label);
                });

                // Connecting rooms toggle
                document.getElementById('connectingRoomsSwitch').addEventListener('change', (e) => {
                    AppState.connectingRoomsEnabled = e.target.checked;
                    if (e.target.checked) {
                        if (AppState.selectedGroups.size === 2) {
                            AppState.autoAssignConnectingRooms();
                        } else if (AppState.selectedGroups.size >= 3) {
                            // Put all in Room 1 initially, let user assign
                            AppState.connectingRoom1Groups.clear();
                            AppState.connectingRoom2Groups.clear();
                            const labels = AppState.getSelectedGroupLabels();
                            labels.forEach((l, i) => {
                                if (i === 0) AppState.connectingRoom1Groups.add(l);
                                else if (i === 1) AppState.connectingRoom2Groups.add(l);
                                else AppState.connectingRoom1Groups.add(l);
                            });
                        }
                    } else {
                        AppState.connectingRoom1Groups.clear();
                        AppState.connectingRoom2Groups.clear();
                        AppState.connectingOpenBreakdowns.clear();
                    }
                    this.updateRoomAssignmentUI();
                    this.renderRoomAssignmentChips();
                    Renderer.renderConnectingPairsGrid();
                    document.getElementById('connectingPairsSection').classList.toggle('visible', e.target.checked && CONNECTING_PAIRS.length > 0);
                });

                // Room assignment chip clicks (delegation)
                document.getElementById('roomAssignment').addEventListener('click', (e) => {
                    const chip = e.target.closest('.room-group-chip');
                    if (!chip) return;
                    const label = chip.dataset.label;
                    const fromRoom = parseInt(chip.dataset.fromRoom);
                    if (fromRoom === 1) {
                        AppState.connectingRoom1Groups.delete(label);
                        AppState.connectingRoom2Groups.add(label);
                    } else {
                        AppState.connectingRoom2Groups.delete(label);
                        AppState.connectingRoom1Groups.add(label);
                    }
                    this.renderRoomAssignmentChips();
                    Renderer.renderConnectingPairsGrid();
                });

                // Connecting pair card breakdown toggle (delegation)
                document.getElementById('connectingPairsGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-connecting-breakdown')) {
                        const pairId = parseInt(e.target.dataset.pairId);
                        if (AppState.connectingOpenBreakdowns.has(pairId)) {
                            AppState.connectingOpenBreakdowns.delete(pairId);
                        } else {
                            AppState.connectingOpenBreakdowns.add(pairId);
                        }
                        Renderer.renderConnectingPairsGrid();
                    }
                });

                // Dark mode
                document.getElementById('darkModeToggle').addEventListener('click', () => this.toggleDarkMode());

                // Easter egg
                document.getElementById('shipNameLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleShipClick();
                });

                // Share buttons
                document.getElementById('copyLinkBtn').addEventListener('click', () => {
                    navigator.clipboard.writeText(window.location.href).then(() => {
                        const btn = document.getElementById('copyLinkBtn');
                        btn.textContent = 'Copied!';
                        setTimeout(() => { btn.textContent = 'Copy Link'; }, 2000);
                    });
                });

                document.getElementById('whatsappShareBtn').addEventListener('click', () => {
                    const msg = encodeURIComponent('Hey! Pick your cabin for our family cruise! ' + window.location.href);
                    window.open('https://wa.me/?text=' + msg, '_blank');
                });

                // Nudge buttons
                document.getElementById('unbookedPills').addEventListener('click', (e) => {
                    if (e.target.classList.contains('nudge-btn')) {
                        const name = e.target.dataset.name;
                        const msg = encodeURIComponent(`Hey ${name}! Have you picked your cabin yet? Check out the options: ${window.location.href}`);
                        window.open('https://wa.me/?text=' + msg, '_blank');
                    }
                });

                // Filter tabs
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        AppState.currentFilter = e.target.dataset.filter;
                        Renderer.renderGrid();
                    });
                });

                // Sort select
                document.getElementById('sortSelect').addEventListener('change', (e) => {
                    AppState.currentSort = e.target.value;
                    Renderer.renderGrid();
                });

                // Package toggles
                document.getElementById('drinkToggle').addEventListener('change', (e) => {
                    AppState.includeDrinks = e.target.checked;
                    this.updateFasPlusAvailability();
                });

                document.getElementById('dinnerToggle').addEventListener('change', (e) => {
                    AppState.includeDinner = e.target.checked;
                    this.updateFasPlusAvailability();
                });

                document.getElementById('tipsToggle').addEventListener('change', (e) => {
                    AppState.tipsBeforeCruise = e.target.checked;
                    document.getElementById('tipsToggleDesc').textContent = e.target.checked
                        ? 'Before cruise (by 7/23/2026)'
                        : 'Onboard (end of cruise)';
                    Renderer.updatePrices();
                });

                // FAS Plus toggle
                document.getElementById('fasPlusToggle').addEventListener('change', (e) => {
                    if (!AppState.includeDrinks || !AppState.includeDinner) {
                        // Auto-enable drink + dinner when FAS Plus is turned on
                        if (e.target.checked) {
                            AppState.includeDrinks = true;
                            AppState.includeDinner = true;
                            document.getElementById('drinkToggle').checked = true;
                            document.getElementById('dinnerToggle').checked = true;
                        }
                    }
                    AppState.freeAtSeaPlus = e.target.checked;
                    this.updateFasPlusDisplay();
                    Renderer.updatePrices();
                });

                // FAS Plus info button
                document.getElementById('fasPlusInfoBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.populateCostBenefitTable();
                    document.getElementById('fasPlusModal').classList.add('visible');
                });

                document.getElementById('closeFasModal').addEventListener('click', () => {
                    document.getElementById('fasPlusModal').classList.remove('visible');
                });

                document.getElementById('fasPlusModal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('fas-modal-overlay')) {
                        document.getElementById('fasPlusModal').classList.remove('visible');
                    }
                });

                // Deposit option radio buttons
                document.querySelectorAll('input[name="depositOption"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        AppState.depositOption = e.target.value;
                        document.querySelectorAll('.deposit-radio-label').forEach(label => {
                            label.classList.toggle('active', label.dataset.option === e.target.value);
                        });
                        Renderer.updatePrices();
                    });
                });

                // Cabin grid event delegation
                document.getElementById('cabinGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-breakdown')) {
                        const id = parseInt(e.target.dataset.id);
                        if (AppState.openBreakdowns.has(id)) {
                            AppState.openBreakdowns.delete(id);
                        } else {
                            AppState.openBreakdowns.add(id);
                        }
                        Renderer.renderGrid();
                    }

                    if (e.target.classList.contains('btn-compare')) {
                        const id = parseInt(e.target.dataset.id);
                        if (AppState.selectedCabins.has(id)) {
                            AppState.selectedCabins.delete(id);
                        } else if (AppState.selectedCabins.size < 3) {
                            AppState.selectedCabins.add(id);
                        }
                        Renderer.renderGrid();
                        Renderer.updateComparisonTray();
                    }
                });

                // Comparison tray
                document.getElementById('clearComparison').addEventListener('click', () => {
                    AppState.selectedCabins.clear();
                    Renderer.renderGrid();
                    Renderer.updateComparisonTray();
                });

                document.getElementById('compareNow').addEventListener('click', () => {
                    if (AppState.selectedCabins.size > 0) {
                        Renderer.renderComparison();
                        document.getElementById('comparisonModal').classList.add('visible');
                    }
                });

                // Comparison Modal
                document.getElementById('closeModal').addEventListener('click', () => {
                    document.getElementById('comparisonModal').classList.remove('visible');
                });

                document.getElementById('comparisonModal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-overlay')) {
                        document.getElementById('comparisonModal').classList.remove('visible');
                    }
                });

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.getElementById('comparisonModal').classList.remove('visible');
                        document.getElementById('fasPlusModal').classList.remove('visible');
                    }
                });

                // Initial stepper state
                this.updateGuestDisplay();
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
